# -*- coding: utf-8 -*-
"""
–ú–æ–¥—É–ª—å RAG (Retrieval-Augmented Generation) —Å Privacy First –ø–æ–¥—Ö–æ–¥–æ–º

–†–µ–∞–ª–∏–∑—É–µ—Ç:
- –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ OpenRouter API
- –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤
"""

import logging
import os
from typing import List, Dict, Optional, Tuple
from openai import OpenAI

from src.core.pii_anonymizer import PiiAnonymizer

logger = logging.getLogger(__name__)


class LLMService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM —Å Privacy First –ø–æ–¥—Ö–æ–¥–æ–º

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenRouter API –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º LLM –º–æ–¥–µ–ª—è–º
    """

    def __init__(
        self,
        api_key: Optional[str] = None,
        model: Optional[str] = None,
        base_url: str = "https://openrouter.ai/api/v1"
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM —Å–µ—Ä–≤–∏—Å–∞

        Args:
            api_key: OpenRouter API –∫–ª—é—á (–µ—Å–ª–∏ None - –±–µ—Ä–µ—Ç—Å—è –∏–∑ OPENROUTER_API_KEY)
            model: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ None - –±–µ—Ä–µ—Ç—Å—è –∏–∑ OPENROUTER_MODEL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç)
            base_url: Base URL –¥–ª—è OpenRouter API
        """
        # API –∫–ª—é—á
        self.api_key = api_key or os.getenv("OPENROUTER_API_KEY")
        if not self.api_key:
            logger.error("OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
            raise ValueError("OPENROUTER_API_KEY –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã LLM —Å–µ—Ä–≤–∏—Å–∞")

        # –ú–æ–¥–µ–ª—å
        self.model = model or os.getenv("OPENROUTER_MODEL", "openai/gpt-4o-mini")
        logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM –º–æ–¥–µ–ª—å: {self.model}")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç (—Å–æ–≤–º–µ—Å—Ç–∏–º —Å OpenRouter)
        self.client = OpenAI(
            api_key=self.api_key,
            base_url=base_url
        )

        # –ê–Ω–æ–Ω–∏–º–∞–π–∑–µ—Ä
        self.anonymizer = PiiAnonymizer()

        # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ (–º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ settings.py)
        DEPARTMENTS_INFO = """
–°–ü–ò–°–û–ö –û–¢–î–ï–õ–û–í –ò –ò–• –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨ (–ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–∞):

1. –ò–¢ (IT): –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç, Wi-Fi, –ø–æ—á—Ç–∞, –ø—Ä–∏–Ω—Ç–µ—Ä (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–ª–æ–º–∫–∞), —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º (–∫—Ä–æ–º–µ 1–°), –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∏–µ–π, –¥–æ—Å—Ç—É–ø–∞–º–∏ –≤ Windows.
2. 1–°: –û—à–∏–±–∫–∏ –∏–º–µ–Ω–Ω–æ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ 1–°, –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ 1–°, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç—á–µ—Ç–æ–≤ –≤ 1–°, –¥–æ—Ä–∞–±–æ—Ç–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ 1–°.
3. –†–∞—Å—á–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–Ω–æ–π –ø–ª–∞—Ç—ã: –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –õ–ò–ß–ù–´–ï –¥–µ–Ω—å–≥–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞: –ø–æ—á–µ–º—É –ø—Ä–∏—à–ª–æ –º–∞–ª–æ, –∞–≤–∞–Ω—Å, —Ä–∞—Å—á–µ—Ç–Ω—ã–π –ª–∏—Å—Ç, —É–¥–µ—Ä–∂–∞–Ω–∏—è, –ø—Ä–µ–º–∏–∏, –±–æ–ª—å–Ω–∏—á–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã.
4. –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è: –í–æ–ø—Ä–æ—Å—ã –ø—Ä–æ –î–ï–ù–¨–ì–ò –ö–û–ú–ü–ê–ù–ò–ò: –æ–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–æ–≤ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π, –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–∞, –∞–∫—Ç—ã —Å–≤–µ—Ä–æ–∫, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã, –∫–æ–º–∞–Ω–¥–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã (–∞–≤–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã).
5. –§–∏–Ω-—Å–ª—É–∂–±–∞: –ë—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑, –ø–ª–∞–Ω—ã –ø–æ –≤—ã—Ä—É—á–∫–µ/–ø—Ä–∏–±—ã–ª–∏, –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–î–ê–ñ.

6. –ö–∞–¥—Ä—ã (–ö–î–ü): –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: –ø—Ä–∏–µ–º –Ω–∞ —Ä–∞–±–æ—Ç—É, —É–≤–æ–ª—å–Ω–µ–Ω–∏–µ, –≥—Ä–∞—Ñ–∏–∫ –æ—Ç–ø—É—Å–∫–æ–≤, —Ç—Ä—É–¥–æ–≤–∞—è –∫–Ω–∏–∂–∫–∞, —Å–ø—Ä–∞–≤–∫–∏ —Å –º–µ—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã, –±—É–º–∞–∂–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ.
7. –ü–æ–¥–±–æ—Ä –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞: –û–±—É—á–µ–Ω–∏–µ, —Ç—Ä–µ–Ω–∏–Ω–≥–∏, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–æ–≤–∏—á–∫–æ–≤, –≤–∞–∫–∞–Ω—Å–∏–∏, —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏—è, –∫–∞–¥—Ä–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤.
8. –û—Ñ–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä: –ü—Ä–æ–ø—É—Å–∫–∞ (–∑–∞–∫–∞–∑, —É—Ç–µ—Ä—è), –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è, –≤–æ–¥–∞/–∫–æ—Ñ–µ, –∑–∞–∫–∞–∑ —Ç–∞–∫—Å–∏/–∫—É—Ä—å–µ—Ä–∞, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—ã—Ö, —É–±–æ—Ä–∫–∞ –≤ –æ—Ñ–∏—Å–µ.

9. –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ: –í–æ–ø—Ä–æ—Å—ã –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É, –≥—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω –Ω–∞ –ª–∏–Ω–∏–∏, —Ä–∞–±–æ—Ç–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, —Ç–µ—Ö–Ω–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ —Ü–µ—Ö—É.
10. –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü–ª–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞, –≥—Ä–∞—Ñ–∏–∫ –ø–æ—Å—Ç–∞–≤–æ–∫ —Å—ã—Ä—å—è, –∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏–Ω–∏–π.
11. R&D: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –Ω–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤/–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
12. –í–Ω–µ–¥—Ä–µ–Ω–∏—è —Ä–µ—Ü–µ–ø—Ç—É—Ä –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç—ã, –∑–∞–ø—É—Å–∫ –Ω–æ–≤–∏–Ω–∫–∏ –Ω–∞ –ª–∏–Ω–∏–∏, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π —Ä–µ—Ü–µ–ø—Ç—É—Ä—ã.
13. –û—Ç–¥–µ–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏–∏: –ì–û–°–¢—ã, –¢–£ (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Å–ª–æ–≤–∏—è), —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ü–∏–∏, –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞, —ç—Ç–∏–∫–µ—Ç–∫–∏ (—Ç–µ–∫—Å—Ç –∏ –Ω–æ—Ä–º—ã).
14. QA (–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞): –ñ–∞–ª–æ–±—ã –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ (–ø—Ä–µ—Ç–µ–Ω–∑–∏–∏), –±—Ä–∞–∫, —Å–∞–Ω–∏—Ç–∞—Ä–Ω—ã–µ –Ω–æ—Ä–º—ã, –∞—É–¥–∏—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞.
15. –ê–Ω–∞–ª–∏–∑ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞: –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã, –¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏ (—Å–µ–Ω—Å–æ—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑), –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–∑—Ü–æ–≤.

16. –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏: –°—Ä–æ–∫–∏ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ–¥—É–∫—Ç–∞, –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.
17. –ó–∞–∫—É–ø–∫–∏: –ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ (—Å—ã—Ä—å–µ, —É–ø–∞–∫–æ–≤–∫–∞, –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ), —Ç–µ–Ω–¥–µ—Ä—ã, –¥–æ–≥–æ–≤–æ—Ä–∞ –ø–æ—Å—Ç–∞–≤–∫–∏.
18. –ò–º–∏–¥–∂–µ–≤—ã–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (PR): –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è, –º–µ—Ä—á, –Ω–æ–≤–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏, —Å–æ—Ü—Å–µ—Ç–∏, –±—Ä–µ–Ω–¥, –ø–æ–¥–∞—Ä–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º.
19. –î–∏–∑–∞–π–Ω-—Å—Ç—É–¥–∏—è: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —É–ø–∞–∫–æ–≤–∫–∏, –º–∞–∫–µ—Ç–æ–≤, –±–∞–Ω–Ω–µ—Ä–æ–≤, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–æ–¥—É–∫—Ü–∏–∏, –ª–æ–≥–æ—Ç–∏–ø—ã.
20. –ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —Å—Ç—É–¥–∏—è: –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –µ–¥–æ–π, –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –±–ª—é–¥.

21. –Æ—Ä–∏—Å—Ç—ã: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–æ–≤, –ø—Ä–∞–≤–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞, —Å—É–¥–µ–±–Ω—ã–µ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏.
22. –°–û–ö: –í–æ–ø—Ä–æ—Å—ã –æ –°–ø–∞—Ä—Ç–∞–∫–∏–∞–¥–µ.
23. –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã: –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∏ –ø–æ–¥ –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤—ã—à–µ.
"""

        # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        self.system_prompt = f"""–¢—ã ‚Äî —É–º–Ω—ã–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ—á—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–∏.

–í–ê–ñ–ù–û: –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–π–¥–µ–Ω —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–∏—Å–∫–∞ –∏ –°–í–Ø–ó–ê–ù —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å.

{DEPARTMENTS_INFO}

–°–û–í–ï–¢–´ –ü–û –í–´–ë–û–†–£ –û–¢–î–ï–õ–ê:
1. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –õ–ò–ß–ù–£–Æ –∑–∞—Ä–ø–ª–∞—Ç—É ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ "–†–∞—Å—á–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–Ω–æ–π –ø–ª–∞—Ç—ã", –∞ –Ω–µ "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è".
2. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –ø—Ä–æ–≥—Ä–∞–º–º—É 1–° ‚Äî —ç—Ç–æ "1–°", –∞ –Ω–µ "–ò–¢".
3. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –æ—Ç–ø—É—Å–∫ ‚Äî —ç—Ç–æ "–ö–∞–¥—Ä—ã".
4. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –æ–±—É—á–µ–Ω–∏–µ –∏–ª–∏ —Ç—Ä–µ–Ω–∏–Ω–≥ ‚Äî —ç—Ç–æ "–ü–æ–¥–±–æ—Ä –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∞".
5. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∫–∞—á–µ—Å—Ç–≤–æ, —Å–º–æ—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç: "–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è" (–¥–æ–∫—É–º–µ–Ω—Ç—ã/–ì–û–°–¢), "QA" (–±—Ä–∞–∫/–ø—Ä–µ—Ç–µ–Ω–∑–∏–∏) –∏–ª–∏ "–ê–Ω–∞–ª–∏–∑" (–ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è).

–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:
–í —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–∫–µ–Ω—ã –≤–∏–¥–∞ [PER_1], [PHONE_1], [EMAIL_1], [URL_1]).
–ù–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–π, —á—Ç–æ –ø–æ–¥ –Ω–∏–º–∏ —Å–∫—Ä—ã—Ç–æ. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–∫–µ–Ω—ã –∫–∞–∫ –µ—Å—Ç—å.

–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –õ–û–ì–ò–ö–ï (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π):
1. **–ê–ù–ê–õ–ò–ó –ö–û–ù–¢–ï–ö–°–¢–ê:** –°–Ω–∞—á–∞–ª–∞ –∏—â–∏ –æ—Ç–≤–µ—Ç –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.
2. **–ü–†–û–í–ï–†–ö–ê –ú–ê–°–®–¢–ê–ë–ê (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û):**
   - –ü—Ä–æ–≤–µ—Ä—å, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–∞—Å—à—Ç–∞–±—É –≤–æ–ø—Ä–æ—Å–∞.
   - –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –£–ó–ö–û–ô –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –Ω–æ–≤–∏–Ω–∫–∞–º", "–¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ"), –∞ –≤–æ–ø—Ä–æ—Å –∑–∞–¥–∞–Ω –®–ò–†–û–ö–û ("–æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", "–¥–æ—Å—Ç—É–ø –∫ 1–°"), –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç.
   - –õ—É—á—à–µ —Å–∫–∞–∂–∏, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç, –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å –≤ –æ—Ç–¥–µ–ª, —á–µ–º –¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç —É–∑–∫–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –¥–ª—è –æ–±—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
3. **–†–û–õ–ò –ò –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:** –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º–æ–π –≤–æ–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É–π —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Ç–∞–º –∫–æ–Ω—Ç–∞–∫—Ç—ã.
4. **–ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø:** –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–±—Ä–æ—à–µ–Ω –Ω–∞ —à–∞–≥–µ 2 –∏–ª–∏ –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–π "–°–ü–ò–°–û–ö –û–¢–î–ï–õ–û–í" –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
5. –î—É–º–∞–π —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.

–ü–†–ò–ú–ï–†–´:

–ü—Ä–∏–º–µ—Ä 1 (–∫–æ—Å–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–ü–µ—á–∞—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —É [PER_5] (–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è, 3 —ç—Ç–∞–∂)."
–í–æ–ø—Ä–æ—Å: "–ì–¥–µ —Å–∏–¥—è—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ã?"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–∫–∞–∑–∞–Ω–æ, —á—Ç–æ [PER_5] –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ –∏ —Å–∏–¥–∏—Ç –Ω–∞ 3 —ç—Ç–∞–∂–µ.
–û—Ç–≤–µ—Ç: –ò—Å—Ö–æ–¥—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø–µ—á–∞—Ç–∏, –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ 3 —ç—Ç–∞–∂–µ.

–ü—Ä–∏–º–µ—Ä 2 (–≤—ã–≤–æ–¥ –æ–± –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–î–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ [URL_1]"
–í–æ–ø—Ä–æ—Å: "–ö—Ç–æ –≤–Ω–æ—Å–∏—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤?"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –ö–æ–Ω—Ç–µ–∫—Å—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—É. –°–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª—É, [URL_1] ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.
–û—Ç–≤–µ—Ç: –≠—Ç–∏–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è [URL_1]. –î–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ.

–ü—Ä–∏–º–µ—Ä 3 (–∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç -> –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞."
–í–æ–ø—Ä–æ—Å: "–ü–æ—á–µ–º—É –º–Ω–µ –ø—Ä–∏—à–ª–æ –º–∞–ª–æ –¥–µ–Ω–µ–≥ –≤ –∞–≤–∞–Ω—Å?"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—É—Å—Ç–æ. –í–æ–ø—Ä–æ—Å –ø—Ä–æ –¥–µ–Ω—å–≥–∏/–∞–≤–∞–Ω—Å. –í –°–ø–∏—Å–∫–µ –û—Ç–¥–µ–ª–æ–≤ —Å–∫–∞–∑–∞–Ω–æ, —á—Ç–æ "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è" –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∑–∞—Ä–ø–ª–∞—Ç—É –∏ –∞–≤–∞–Ω—Å.
–û—Ç–≤–µ—Ç: –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç —Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—é. –¢–∞–∫ –∫–∞–∫ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –≤—ã–ø–ª–∞—Ç, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –æ—Ç–¥–µ–ª –†–∞—Å—á–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–Ω–æ–π –ø–ª–∞—Ç—ã.

–ü—Ä–∏–º–µ—Ä 4 (–∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç -> –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–∫–æ–π..."
–í–æ–ø—Ä–æ—Å: "–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–∫–µ—Ç—É –≤ –∫–æ—Å–º–æ—Å?"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø—Ä–æ —Ä–∞–∫–µ—Ç—ã. –í –°–ø–∏—Å–∫–µ –û—Ç–¥–µ–ª–æ–≤ –Ω–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞ –∫–æ—Å–º–æ—Å.
–û—Ç–≤–µ—Ç: –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É. –ú–æ–∏ —Å–æ–∑–¥–∞—Ç–µ–ª–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–≤–∏–¥—è—Ç –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏ –¥–æ–±–∞–≤—è—Ç –≤ –º–æ—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É.
2. –°–æ—Ö—Ä–∞–Ω—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É (—Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã) –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
3. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
4. –ï—Å–ª–∏ –Ω–∞—à–µ–ª –æ—Ç–≤–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ.
5. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ –∫–∞–∫–æ–π –æ—Ç–¥–µ–ª ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–π –≤ –æ—Ç–¥–µ–ª.
6. –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ ‚Äî –æ—Ç–≤–µ—Ç—å, —á—Ç–æ –µ–≥–æ –Ω–µ –∑–Ω–∞–µ—à—å –æ–± —ç—Ç–æ–º.
"""

    def _prepare_context(self, chunks: List[Dict]) -> str:
        """
        –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤

        Args:
            chunks: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –ø–æ–ª—è–º–∏: question, answer, confidence

        Returns:
            –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM
        """
        if not chunks:
            return ""

        context_parts = []

        for i, chunk in enumerate(chunks, 1):
            question = chunk.get('question', '')
            answer = chunk.get('answer', '')
            confidence = chunk.get('confidence', 0)

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —á–∞–Ω–∫
            context_parts.append(
                f"–î–æ–∫—É–º–µ–Ω—Ç {i} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {confidence:.1f}%):\n"
                f"–í–æ–ø—Ä–æ—Å: {question}\n"
                f"–û—Ç–≤–µ—Ç: {answer}\n"
            )

        context = "\n---\n".join(context_parts)

        logger.debug(f"–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ {len(chunks)} —á–∞–Ω–∫–æ–≤ (–¥–ª–∏–Ω–∞: {len(context)} —Å–∏–º–≤–æ–ª–æ–≤)")

        return context

    def generate_answer(
        self,
        user_question: str,
        db_chunks: List[Dict],
        max_tokens: int = 1024,
        temperature: float = 0.3
    ) -> Tuple[str, Dict[str, any]]:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM —Å –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π PII

        –ü—Ä–æ—Ü–µ—Å—Å:
        1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ —á–∞–Ω–∫–æ–≤
        2. –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞
        3. –ó–∞–ø—Ä–æ—Å –∫ LLM
        4. –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞

        Args:
            user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            db_chunks: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ ChromaDB
                      –§–æ—Ä–º–∞—Ç: [{"question": "...", "answer": "...", "confidence": 85.5}, ...]
            max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.0 - –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, 1.0 - –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π)

        Returns:
            Tuple (answer, metadata)
            - answer: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–¥–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
            - metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–º–æ–¥–µ–ª—å, —Ç–æ–∫–µ–Ω—ã, –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏ —Ç.–¥.)
        """
        try:
            logger.info(f"ü§ñ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: '{user_question}'")
            logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(db_chunks)} —á–∞–Ω–∫–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")

            # –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            context = self._prepare_context(db_chunks)

            if not context:
                logger.warning("–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç! –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –æ—Ç–≤–µ—Ç.")
                return (
                    "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.",
                    {"error": "empty_context"}
                )

            # –®–∞–≥ 2: –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            logger.debug("–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...")
            anonymized_context, context_mapping = self.anonymizer.anonymize(context)

            # –®–∞–≥ 3: –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞
            logger.debug("–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞...")
            anonymized_question, question_mapping = self.anonymizer.anonymize(user_question)

            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥–∏
            combined_mapping = {**context_mapping, **question_mapping}

            logger.info(f"–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–π–¥–µ–Ω–æ PII: {len(combined_mapping)} —Å—É—â–Ω–æ—Å—Ç–µ–π")

            # –®–∞–≥ 4: –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ LLM
            messages = [
                {"role": "system", "content": self.system_prompt},
                {"role": "user", "content": f"–ö–û–ù–¢–ï–ö–°–¢:\n{anonymized_context}\n\n–í–û–ü–†–û–°: {anonymized_question}"}
            ]

            logger.debug(f"–ó–∞–ø—Ä–æ—Å –∫ LLM –º–æ–¥–µ–ª–∏: {self.model}")

            # –®–∞–≥ 5: –ó–∞–ø—Ä–æ—Å –∫ OpenRouter
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                max_tokens=max_tokens,
                temperature=temperature
            )

            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            anonymized_answer = response.choices[0].message.content

            logger.debug(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç LLM (–¥–ª–∏–Ω–∞: {len(anonymized_answer)} —Å–∏–º–≤–æ–ª–æ–≤)")

            # –®–∞–≥ 6: –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            logger.debug("–î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞...")
            final_answer = self.anonymizer.deanonymize(anonymized_answer, combined_mapping)

            # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            metadata = {
                "model": self.model,
                "chunks_used": len(db_chunks),
                "pii_found": len(combined_mapping),
                "tokens_used": {
                    "prompt": response.usage.prompt_tokens,
                    "completion": response.usage.completion_tokens,
                    "total": response.usage.total_tokens
                },
                "finish_reason": response.choices[0].finish_reason
            }

            logger.info(f"‚úÖ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –¢–æ–∫–µ–Ω–æ–≤: {metadata['tokens_used']['total']}, PII: {metadata['pii_found']}")

            return final_answer, metadata

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}", exc_info=True)
            return (
                "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                {"error": str(e)}
            )


# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

def generate_rag_answer(
    user_question: str,
    db_chunks: List[Dict],
    api_key: Optional[str] = None,
    model: Optional[str] = None
) -> Tuple[str, Dict[str, any]]:
    """
    –£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ RAG –æ—Ç–≤–µ—Ç–∞

    Args:
        user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db_chunks: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
        api_key: OpenRouter API –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        model: –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        Tuple (answer, metadata)
    """
    service = LLMService(api_key=api_key, model=model)
    return service.generate_answer(user_question, db_chunks)
