# -*- coding: utf-8 -*-
"""
–ú–æ–¥—É–ª—å RAG (Retrieval-Augmented Generation) —Å Privacy First –ø–æ–¥—Ö–æ–¥–æ–º

–†–µ–∞–ª–∏–∑—É–µ—Ç:
- –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ OpenRouter API
- –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–æ–≤
"""

import logging
import os
from typing import List, Dict, Optional, Tuple
from openai import OpenAI

from src.core.pii_anonymizer import PiiAnonymizer

logger = logging.getLogger(__name__)


class LLMService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM —Å Privacy First –ø–æ–¥—Ö–æ–¥–æ–º

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenRouter API –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º LLM –º–æ–¥–µ–ª—è–º
    """

    def __init__(
        self,
        api_key: Optional[str] = None,
        model: Optional[str] = None,
        base_url: str = "https://openrouter.ai/api/v1"
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LLM —Å–µ—Ä–≤–∏—Å–∞

        Args:
            api_key: OpenRouter API –∫–ª—é—á (–µ—Å–ª–∏ None - –±–µ—Ä–µ—Ç—Å—è –∏–∑ OPENROUTER_API_KEY)
            model: –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ None - –±–µ—Ä–µ—Ç—Å—è –∏–∑ OPENROUTER_MODEL –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç)
            base_url: Base URL –¥–ª—è OpenRouter API
        """
        # API –∫–ª—é—á
        self.api_key = api_key or os.getenv("OPENROUTER_API_KEY")
        if not self.api_key:
            logger.error("OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
            raise ValueError("OPENROUTER_API_KEY –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã LLM —Å–µ—Ä–≤–∏—Å–∞")

        # –ú–æ–¥–µ–ª—å
        self.model = model or os.getenv("OPENROUTER_MODEL", "openai/gpt-4o-mini")
        logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è LLM –º–æ–¥–µ–ª—å: {self.model}")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç (—Å–æ–≤–º–µ—Å—Ç–∏–º —Å OpenRouter)
        self.client = OpenAI(
            api_key=self.api_key,
            base_url=base_url
        )

        # –ê–Ω–æ–Ω–∏–º–∞–π–∑–µ—Ä
        self.anonymizer = PiiAnonymizer()

        self.system_prompt = """–¢—ã ‚Äî —É–º–Ω—ã–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø–æ–º–æ—á—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É, –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∫–æ–º–ø–∞–Ω–∏–∏.

–í–ê–ñ–ù–û: –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞–π–¥–µ–Ω —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–∏—Å–∫–∞ –∏ –°–í–Ø–ó–ê–ù —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å.

–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:
–í —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —Å–∫—Ä—ã—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–∫–µ–Ω—ã –≤–∏–¥–∞ [PER_1], [PHONE_1], [EMAIL_1], [URL_1]).
–ù–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–π, —á—Ç–æ –ø–æ–¥ –Ω–∏–º–∏ —Å–∫—Ä—ã—Ç–æ. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–∫–µ–Ω—ã –∫–∞–∫ –µ—Å—Ç—å.

–ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –õ–û–ì–ò–ö–ï:
1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω –∏–Ω–∞—á–µ, —á–µ–º –≤–æ–ø—Ä–æ—Å ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
2. –ü–†–û–í–ï–†–Ø–ô –õ–û–ì–ò–ö–£: –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ù–ï –∞–¥–∞–ø—Ç–∏—Ä—É–π –º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏. –õ–∏–±–æ –≤–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –∫–∞–∫ –µ—Å—Ç—å, –ª–∏–±–æ –ø—Ä–∏–∑–Ω–∞–π –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ.
3. **–í–ê–ñ–ù–û: –¢–µ–±–µ –†–ê–ó–†–ï–®–ï–ù–û –¥–µ–ª–∞—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã –æ —Ä–æ–ª—è—Ö –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç, –∫ –∫–æ–º—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ (—á–µ–ª–æ–≤–µ–∫, –æ—Ç–¥–µ–ª –∏–ª–∏ —Å—Å—ã–ª–∫–∞), —Å—á–∏—Ç–∞–π, —á—Ç–æ —ç—Ç–æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏–ª–∏ —è–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –µ—ë —Ä–µ—à–µ–Ω–∏—è.**
4. –î—É–º–∞–π —à–∞–≥ –∑–∞ —à–∞–≥–æ–º.

–ü–†–ò–ú–ï–†–´:

–ü—Ä–∏–º–µ—Ä 1 (–∫–æ—Å–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–ü–µ—á–∞—Ç—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —É [PER_5] (–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è, 3 —ç—Ç–∞–∂)."
–í–æ–ø—Ä–æ—Å: "–ì–¥–µ —Å–∏–¥—è—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä—ã?"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–∫–∞–∑–∞–Ω–æ, —á—Ç–æ [PER_5] –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ –∏ —Å–∏–¥–∏—Ç –Ω–∞ 3 —ç—Ç–∞–∂–µ. –ó–Ω–∞—á–∏—Ç, –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –Ω–∞ 3 —ç—Ç–∞–∂–µ.
–û—Ç–≤–µ—Ç: –ò—Å—Ö–æ–¥—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –æ –º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø–µ—á–∞—Ç–∏, –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ 3 —ç—Ç–∞–∂–µ.

–ü—Ä–∏–º–µ—Ä 2 (—Ä–∞–∑–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ - –ø–æ–¥—Ö–æ–¥–∏—Ç):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–í–æ–ø—Ä–æ—Å: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∏–Ω—Ç–µ—Ä–æ–º. –û—Ç–≤–µ—Ç: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á–µ–Ω –ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä –∏ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ [EMAIL_1]"
–í–æ–ø—Ä–æ—Å: "–ü—Ä–∏–Ω—Ç–µ—Ä –Ω–µ –ø–µ—á–∞—Ç–∞–µ—Ç"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: "–ù–µ –ø–µ—á–∞—Ç–∞–µ—Ç" ‚Äî —Ç–∏–ø–∏—á–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, –≥–¥–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∫–ª—é—á–µ–Ω –ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä –∏ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç.
–û—Ç–≤–µ—Ç: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á–µ–Ω –ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä –∏ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ [EMAIL_1]

**–ü—Ä–∏–º–µ—Ä 3 (–≤—ã–≤–æ–¥ –æ–± –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ—á–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ - –ü–û–î–•–û–î–ò–¢):**
**–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–í–æ–ø—Ä–æ—Å: –ö–∞–∫ –≤–Ω–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –≤ 1–°? –û—Ç–≤–µ—Ç: –î–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫ [URL_1]"**
**–í–æ–ø—Ä–æ—Å: "–ö—Ç–æ –≤–Ω–æ—Å–∏—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤?"**
**–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ö—Ç–æ?" (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å). –ö–æ–Ω—Ç–µ–∫—Å—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—É: –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ –Ω—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ [URL_1]. –°–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª—É –ª–æ–≥–∏–∫–∏ #3, —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥, —á—Ç–æ [URL_1] ‚Äî —ç—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞/–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —ç—Ç—É –∑–∞–¥–∞—á—É.**
**–û—Ç–≤–µ—Ç: –≠—Ç–∏–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è [URL_1]. –î–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Å—ã–ª–∫–µ.**

–ü—Ä–∏–º–µ—Ä 4 (–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π - –ù–ï –ø–æ–¥—Ö–æ–¥–∏—Ç):
–ö–æ–Ω—Ç–µ–∫—Å—Ç: "–í–æ–ø—Ä–æ—Å: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∏–Ω—Ç–µ—Ä–æ–º. –û—Ç–≤–µ—Ç: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á–µ–Ω –ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä –∏ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ [EMAIL_1]"
–í–æ–ø—Ä–æ—Å: "–ü—Ä–∏–Ω—Ç–µ—Ä –∑–∞–∂–µ–≤–∞–ª –±—É–º–∞–≥—É"
–†–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ: –í–æ–ø—Ä–æ—Å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π (–∑–∞–º—è—Ç–∏–µ –±—É–º–∞–≥–∏), –∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—â–∏–π (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞). –°–æ–≤–µ—Ç "–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞" –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞, –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –∑–∞–∂–µ–≤–∞–Ω–∞. –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã.
–û—Ç–≤–µ—Ç: –í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –µ—Å—Ç—å –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º —Å –ø—Ä–∏–Ω—Ç–µ—Ä–æ–º: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤–∫–ª—é—á–µ–Ω –ª–∏ –ø—Ä–∏–Ω—Ç–µ—Ä –∏ –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞. –î–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–º—è—Ç–∏–µ–º –±—É–º–∞–≥–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É –Ω–∞ [EMAIL_1]

–ü–†–ê–í–ò–õ–ê –û–¢–í–ï–¢–ê:
1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
2. –°–æ—Ö—Ä–∞–Ω—è–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É (—Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã) –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
4. –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –°–û–í–°–ï–ú –Ω–µ —Å–≤—è–∑–∞–Ω —Å –≤–æ–ø—Ä–æ—Å–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –æ—Ç–ø—É—Å–∫, –∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ –ø—Ä–∏–Ω—Ç–µ—Ä—ã), –æ—Ç–≤–µ—Ç—å: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –æ—Ñ–∏—Å-–º–µ–Ω–µ–¥–∂–µ—Ä—É."
"""

    def _prepare_context(self, chunks: List[Dict]) -> str:
        """
        –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤

        Args:
            chunks: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –ø–æ–ª—è–º–∏: question, answer, confidence

        Returns:
            –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM
        """
        if not chunks:
            return ""

        context_parts = []

        for i, chunk in enumerate(chunks, 1):
            question = chunk.get('question', '')
            answer = chunk.get('answer', '')
            confidence = chunk.get('confidence', 0)

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —á–∞–Ω–∫
            context_parts.append(
                f"–î–æ–∫—É–º–µ–Ω—Ç {i} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {confidence:.1f}%):\n"
                f"–í–æ–ø—Ä–æ—Å: {question}\n"
                f"–û—Ç–≤–µ—Ç: {answer}\n"
            )

        context = "\n---\n".join(context_parts)

        logger.debug(f"–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ {len(chunks)} —á–∞–Ω–∫–æ–≤ (–¥–ª–∏–Ω–∞: {len(context)} —Å–∏–º–≤–æ–ª–æ–≤)")

        return context

    def generate_answer(
        self,
        user_question: str,
        db_chunks: List[Dict],
        max_tokens: int = 1024,
        temperature: float = 0.3
    ) -> Tuple[str, Dict[str, any]]:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ LLM —Å –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π PII

        –ü—Ä–æ—Ü–µ—Å—Å:
        1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ —á–∞–Ω–∫–æ–≤
        2. –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞
        3. –ó–∞–ø—Ä–æ—Å –∫ LLM
        4. –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞

        Args:
            user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            db_chunks: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ –∏–∑ ChromaDB
                      –§–æ—Ä–º–∞—Ç: [{"question": "...", "answer": "...", "confidence": 85.5}, ...]
            max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
            temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.0 - –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, 1.0 - –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π)

        Returns:
            Tuple (answer, metadata)
            - answer: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–¥–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
            - metadata: –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–º–æ–¥–µ–ª—å, —Ç–æ–∫–µ–Ω—ã, –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏ —Ç.–¥.)
        """
        try:
            logger.info(f"ü§ñ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞: '{user_question}'")
            logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(db_chunks)} —á–∞–Ω–∫–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")

            # –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            context = self._prepare_context(db_chunks)

            if not context:
                logger.warning("–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç! –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –æ—Ç–≤–µ—Ç.")
                return (
                    "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.",
                    {"error": "empty_context"}
                )

            # –®–∞–≥ 2: –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            logger.debug("–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...")
            anonymized_context, context_mapping = self.anonymizer.anonymize(context)

            # –®–∞–≥ 3: –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞
            logger.debug("–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞...")
            anonymized_question, question_mapping = self.anonymizer.anonymize(user_question)

            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥–∏
            combined_mapping = {**context_mapping, **question_mapping}

            logger.info(f"–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞–π–¥–µ–Ω–æ PII: {len(combined_mapping)} —Å—É—â–Ω–æ—Å—Ç–µ–π")

            # –®–∞–≥ 4: –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ LLM
            messages = [
                {"role": "system", "content": self.system_prompt},
                {"role": "user", "content": f"–ö–û–ù–¢–ï–ö–°–¢:\n{anonymized_context}\n\n–í–û–ü–†–û–°: {anonymized_question}"}
            ]

            logger.debug(f"–ó–∞–ø—Ä–æ—Å –∫ LLM –º–æ–¥–µ–ª–∏: {self.model}")

            # –®–∞–≥ 5: –ó–∞–ø—Ä–æ—Å –∫ OpenRouter
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                max_tokens=max_tokens,
                temperature=temperature
            )

            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            anonymized_answer = response.choices[0].message.content

            logger.debug(f"–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç LLM (–¥–ª–∏–Ω–∞: {len(anonymized_answer)} —Å–∏–º–≤–æ–ª–æ–≤)")

            # –®–∞–≥ 6: –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            logger.debug("–î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞...")
            final_answer = self.anonymizer.deanonymize(anonymized_answer, combined_mapping)

            # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            metadata = {
                "model": self.model,
                "chunks_used": len(db_chunks),
                "pii_found": len(combined_mapping),
                "tokens_used": {
                    "prompt": response.usage.prompt_tokens,
                    "completion": response.usage.completion_tokens,
                    "total": response.usage.total_tokens
                },
                "finish_reason": response.choices[0].finish_reason
            }

            logger.info(f"‚úÖ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –¢–æ–∫–µ–Ω–æ–≤: {metadata['tokens_used']['total']}, PII: {metadata['pii_found']}")

            return final_answer, metadata

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}", exc_info=True)
            return (
                "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                {"error": str(e)}
            )


# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

def generate_rag_answer(
    user_question: str,
    db_chunks: List[Dict],
    api_key: Optional[str] = None,
    model: Optional[str] = None
) -> Tuple[str, Dict[str, any]]:
    """
    –£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ RAG –æ—Ç–≤–µ—Ç–∞

    Args:
        user_question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db_chunks: –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
        api_key: OpenRouter API –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        model: –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        Tuple (answer, metadata)
    """
    service = LLMService(api_key=api_key, model=model)
    return service.generate_answer(user_question, db_chunks)
