<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <!-- Tailwind CSS + Custom Styles -->
    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet"/>

    <!-- Auth Module -->
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4">
        <div class="flex flex-col h-full">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-primary rounded-lg size-10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-white">support_agent</span>
                </div>
                <h1 class="text-lg font-bold text-gray-800 dark:text-white">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="./">
                    <span class="material-symbols-outlined fill">import_contacts</span>
                    <p class="text-sm font-bold leading-normal">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./logs">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">receipt_long</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">–õ–æ–≥–∏</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./permissions">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">admin_panel_settings</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="./settings">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">settings</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-10">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <h1 class="text-gray-800 dark:text-white text-3xl font-bold leading-tight">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞.</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openAddModal()" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-primary text-white text-sm font-bold shadow-sm hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined text-xl">add_circle</span>
                        <span class="truncate">–î–æ–±–∞–≤–∏—Ç—å FAQ</span>
                    </button>
                    <button onclick="retrainModel()" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-yellow-500 text-white text-sm font-bold shadow-sm hover:bg-yellow-600 transition-colors">
                        <span class="material-symbols-outlined text-xl">refresh</span>
                        <span class="truncate">–ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å</span>
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-gray-800 dark:text-white text-lg font-semibold">–ü–æ–∏—Å–∫ FAQ</h3>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="searchType" value="text" checked class="w-4 h-4 text-primary">
                            <span class="text-sm text-gray-700 dark:text-gray-300">–¢–µ–∫—Å—Ç–æ–≤—ã–π</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="searchType" value="semantic" class="w-4 h-4 text-primary">
                            <span class="text-sm text-gray-700 dark:text-gray-300">–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π (AI)</span>
                        </label>
                    </div>
                </div>

                <div class="flex gap-3 mb-4">
                    <div class="flex-1 flex items-stretch rounded-lg bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600">
                        <div class="text-gray-400 flex items-center justify-center pl-4">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                        <input
                            type="text"
                            id="searchQuery"
                            class="form-input flex-1 bg-transparent border-none focus:ring-0 text-gray-800 dark:text-gray-200 placeholder:text-gray-400"
                            placeholder="–ù–∞–π—Ç–∏ –≤–æ–ø—Ä–æ—Å..."
                            onkeypress="if(event.key==='Enter') performSearch()"
                        >
                    </div>
                    <button onclick="performSearch()" class="flex items-center gap-2 px-5 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined">search</span>
                        <span>–ò—Å–∫–∞—Ç—å</span>
                    </button>
                    <button onclick="clearSearch()" class="flex items-center gap-2 px-5 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                        <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
                    </button>
                </div>

                <div id="searchInfo" style="display: none;" class="p-3 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-primary rounded text-sm text-gray-700 dark:text-gray-300"></div>
            </div>

            <!-- Filters & View Toggle -->
            <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
                <div class="flex-grow w-full">
                    <select id="categoryFilter" onchange="applyFilters()" class="form-select w-full rounded-lg bg-white dark:bg-gray-700/50 h-12 shadow-sm border border-gray-200 dark:border-gray-600 focus:ring-primary focus:border-primary">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Export Button -->
                <div class="relative">
                    <button onclick="toggleExportMenu()" class="flex items-center gap-2 px-4 h-12 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors shadow-sm">
                        <span class="material-symbols-outlined">download</span>
                        <span class="text-sm font-medium">–≠–∫—Å–ø–æ—Ä—Ç</span>
                        <span class="material-symbols-outlined text-xl">expand_more</span>
                    </button>

                    <!-- Export Dropdown Menu -->
                    <div id="exportMenu" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-600 z-50">
                        <div class="p-3">
                            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2 uppercase">–§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞</p>
                            <button onclick="exportForReview('excel')" class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-green-600 dark:text-green-400">table_chart</span>
                                <div>
                                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200">Excel (.xlsx)</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                                </div>
                            </button>
                            <button onclick="exportForReview('pdf')" class="w-full flex items-center gap-3 px-4 py-3 text-left hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                <span class="material-symbols-outlined text-red-600 dark:text-red-400">picture_as_pdf</span>
                                <div>
                                    <p class="text-sm font-medium text-gray-800 dark:text-gray-200">PDF</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">–î–ª—è –ø–µ—á–∞—Ç–∏</p>
                                </div>
                            </button>
                        </div>
                        <div class="border-t border-gray-200 dark:border-gray-600 p-3">
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                <span class="material-symbols-outlined text-sm align-middle">info</span>
                                –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400 shrink-0">–í–∏–¥:</p>
                    <div class="flex items-center bg-gray-200 dark:bg-gray-700/50 p-1 rounded-lg">
                        <button id="viewListBtn" onclick="setView('list')" class="p-1.5 rounded-md text-gray-500 dark:text-gray-400 hover:bg-white/50 dark:hover:bg-gray-800/50">
                            <span class="material-symbols-outlined">view_list</span>
                        </button>
                        <button id="viewGridBtn" onclick="setView('grid')" class="p-1.5 rounded-md bg-white dark:bg-gray-800 text-primary dark:text-white shadow">
                            <span class="material-symbols-outlined">grid_view</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- FAQ List Container -->
            <div id="faqListContainer">
                <!-- Grid View -->
                <div id="gridView" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <div class="text-center py-12 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>

                <!-- List View -->
                <div id="listView" class="bg-white dark:bg-[#182431] rounded-xl shadow-md overflow-hidden border border-gray-200 dark:border-gray-700" style="display: none;">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-2/5">–í–æ–ø—Ä–æ—Å</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider w-2/5">–û—Ç–≤–µ—Ç (–∫—Ä–∞—Ç–∫–æ)</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="listViewBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Modal –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è FAQ -->
<div id="faqModal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center" style="display: none;">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å FAQ</h2>
        <form id="faqForm">
            <input type="hidden" id="faqId">

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                <div class="flex gap-2">
                    <select id="faqCategory" required class="flex-1 form-select rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    </select>
                    <button type="button" onclick="openCategoryModal()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-xl font-bold">+</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–í–æ–ø—Ä–æ—Å *</label>
                <input type="text" id="faqQuestion" required class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–û—Ç–≤–µ—Ç *</label>
                <div id="faqAnswerEditor" class="wysiwyg-editor"></div>
                <textarea id="faqAnswer" required style="display: none;"></textarea>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                <input type="text" id="faqKeywords" class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white" placeholder="—Å–ª–æ–≤–æ1, —Å–ª–æ–≤–æ2, —Å–ª–æ–≤–æ3">
            </div>

            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closeModal()" class="px-5 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="px-5 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div id="categoryModal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center" style="display: none;">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
        <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white mb-4">
        <div class="flex gap-3 justify-end">
            <button type="button" onclick="closeCategoryModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" onclick="saveCategory()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    // –ë–∞–∑–æ–≤—ã–π URL –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å —É—á–µ—Ç–æ–º BASE_PATH –¥–ª—è reverse proxy)
    const BASE_URL = '{{ config.get("BASE_PATH", "") }}/admin';

    let currentEditId = null;
    let isSearchActive = false;
    let currentSearchData = null;
    let answerEditor = null;
    let currentView = localStorage.getItem('faqView') || 'grid';

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function setView(view) {
        currentView = view;
        localStorage.setItem('faqView', view);

        const gridView = document.getElementById('gridView');
        const listView = document.getElementById('listView');
        const gridBtn = document.getElementById('viewGridBtn');
        const listBtn = document.getElementById('viewListBtn');

        if (view === 'grid') {
            gridView.style.display = 'grid';
            listView.style.display = 'none';
            gridBtn.classList.add('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            gridBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
            listBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            listBtn.classList.add('text-gray-500', 'dark:text-gray-400');
        } else {
            gridView.style.display = 'none';
            listView.style.display = 'block';
            listBtn.classList.add('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            listBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
            gridBtn.classList.remove('bg-white', 'dark:bg-gray-800', 'text-primary', 'dark:text-white', 'shadow');
            gridBtn.classList.add('text-gray-500', 'dark:text-gray-400');
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∏–¥–∞
        if (!isSearchActive) {
            loadFAQs(document.getElementById('categoryFilter').value);
        } else {
            displaySearchResults(currentSearchData, document.querySelector('input[name="searchType"]:checked').value);
        }
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyFilters() {
        if (!isSearchActive) {
            loadFAQs(document.getElementById('categoryFilter').value);
        }
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Quill HTML –≤ Telegram HTML
    function convertQuillToTelegramHtml(html) {
        html = html.replace(/<strong>/g, '<b>');
        html = html.replace(/<\/strong>/g, '</b>');
        html = html.replace(/<em>/g, '<i>');
        html = html.replace(/<\/em>/g, '</i>');
        html = html.replace(/<pre class="ql-syntax"[^>]*>/g, '<code>');
        html = html.replace(/<\/pre>/g, '</code>');
        html = html.replace(/<p><br><\/p>/g, '\n');
        html = html.replace(/<p>/g, '');
        html = html.replace(/<\/p>/g, '\n');
        html = html.replace(/<br>/g, '\n');
        html = html.replace(/<br\/>/g, '\n');
        html = html.replace(/<br \/>/g, '\n');
        html = html.replace(/\n+$/g, '');
        return html;
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Telegram HTML –≤ Quill HTML
    function convertTelegramToQuillHtml(html) {
        if (!html) return '<p><br></p>';
        html = html.replace(/<b>/g, '<strong>');
        html = html.replace(/<\/b>/g, '</strong>');
        html = html.replace(/<i>/g, '<em>');
        html = html.replace(/<\/i>/g, '</em>');
        html = html.replace(/<code>/g, '<code class="ql-code">');
        const lines = html.split('\n');
        const paragraphs = lines.map(line => {
            if (line.trim() === '') return '<p><br></p>';
            return '<p>' + line + '</p>';
        });
        return paragraphs.join('');
    }

    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Quill HTML –≤ BB –∫–æ–¥—ã –ë–∏—Ç—Ä–∏–∫—Å24
    function convertQuillToBBCode(html) {
        if (!html) return '';

        let text = html;

        // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
        text = text.replace(/<strong>/g, '[b]');
        text = text.replace(/<\/strong>/g, '[/b]');
        text = text.replace(/<b>/g, '[b]');
        text = text.replace(/<\/b>/g, '[/b]');

        // –ö—É—Ä—Å–∏–≤
        text = text.replace(/<em>/g, '[i]');
        text = text.replace(/<\/em>/g, '[/i]');
        text = text.replace(/<i>/g, '[i]');
        text = text.replace(/<\/i>/g, '[/i]');

        // –ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π
        text = text.replace(/<u>/g, '[u]');
        text = text.replace(/<\/u>/g, '[/u]');

        // –ó–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π
        text = text.replace(/<s>/g, '[s]');
        text = text.replace(/<\/s>/g, '[/s]');
        text = text.replace(/<strike>/g, '[s]');
        text = text.replace(/<\/strike>/g, '[/s]');
        text = text.replace(/<del>/g, '[s]');
        text = text.replace(/<\/del>/g, '[/s]');

        // –ö–æ–¥
        text = text.replace(/<code[^>]*>/g, '[code]');
        text = text.replace(/<\/code>/g, '[/code]');
        text = text.replace(/<pre[^>]*>/g, '[code]');
        text = text.replace(/<\/pre>/g, '[/code]');

        // –°—Å—ã–ª–∫–∏
        text = text.replace(/<a\s+href=["']([^"']+)["'][^>]*>(.*?)<\/a>/g, '[URL=$1]$2[/URL]');

        // –£–±–∏—Ä–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è HTML —Ç–µ–≥–∏
        text = text.replace(/<br\s*\/?>/g, '\n');
        text = text.replace(/<p><br><\/p>/g, '\n');
        text = text.replace(/<p>/g, '');
        text = text.replace(/<\/p>/g, '\n');
        text = text.replace(/<div>/g, '');
        text = text.replace(/<\/div>/g, '\n');

        // –û—á–∏—Å—Ç–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
        text = text.replace(/\n{3,}/g, '\n\n');
        text = text.trim();

        return text;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    function initAnswerEditor() {
        if (answerEditor) return;

        const editorContainer = document.getElementById('faqAnswerEditor');
        if (!editorContainer) return;

        answerEditor = new Quill(editorContainer, {
            theme: 'snow',
            placeholder: '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'code'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        });

        answerEditor.on('text-change', () => {
            const html = answerEditor.root.innerHTML;
            const telegramHtml = convertQuillToTelegramHtml(html);
            document.getElementById('faqAnswer').value = telegramHtml;
        });
    }

    // –ü–æ–∏—Å–∫ FAQ
    async function performSearch() {
        const query = document.getElementById('searchQuery').value.trim();
        if (!query) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', 'error');
            return;
        }

        const searchType = document.querySelector('input[name="searchType"]:checked').value;
        const searchInfo = document.getElementById('searchInfo');

        searchInfo.style.display = 'block';
        searchInfo.innerHTML = '<div class="flex items-center gap-2"><span class="material-symbols-outlined animate-spin">refresh</span> –ü–æ–∏—Å–∫...</div>';

        try {
            let response;
            if (searchType === 'text') {
                response = await fetchWithAuth(`${BASE_URL}/search?q=${encodeURIComponent(query)}`);
            } else {
                response = await fetchWithAuth(`${BASE_URL}/search/semantic`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, n_results: 20})
                });
            }

            const data = await response.json();

            if (data.success) {
                isSearchActive = true;
                currentSearchData = data;
                displaySearchResults(data, searchType);
            } else {
                searchInfo.innerHTML = `<div class="text-red-600">‚ùå ${data.message}</div>`;
            }
        } catch (error) {
            searchInfo.innerHTML = `<div class="text-red-600">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }

    function displaySearchResults(data, searchType) {
        const searchInfo = document.getElementById('searchInfo');

        if (data.count === 0) {
            searchInfo.innerHTML = `üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "<strong>${data.query}</strong>"`;
            document.getElementById('gridView').innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>';
            document.getElementById('listViewBody').innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</td></tr>';
            return;
        }

        searchInfo.innerHTML = `‚úÖ –ù–∞–π–¥–µ–Ω–æ: <strong>${data.count}</strong> —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | –ó–∞–ø—Ä–æ—Å: "<strong>${data.query}</strong>" | –¢–∏–ø: <strong>${searchType === 'text' ? '–¢–µ–∫—Å—Ç–æ–≤—ã–π' : '–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π (AI)'}</strong>`;

        if (currentView === 'grid') {
            displayGridView(data.results);
        } else {
            displayListView(data.results);
        }
    }

    function clearSearch() {
        document.getElementById('searchQuery').value = '';
        document.getElementById('searchInfo').style.display = 'none';
        isSearchActive = false;
        currentSearchData = null;
        loadFAQs(document.getElementById('categoryFilter').value);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ FAQ
    async function loadFAQs(category = '') {
        if (isSearchActive) return;

        const url = category ? `${BASE_URL}/faq/list?category=${category}` : `${BASE_URL}/faq/list`;
        const response = await fetchWithAuth(url);
        const faqs = await response.json();

        if (faqs.length === 0) {
            document.getElementById('gridView').innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            document.getElementById('listViewBody').innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        if (currentView === 'grid') {
            displayGridView(faqs);
        } else {
            displayListView(faqs);
        }
    }

    function displayGridView(faqs) {
        const colors = ['blue', 'green', 'yellow', 'indigo', 'purple', 'pink'];
        document.getElementById('gridView').innerHTML = faqs.map((faq, idx) => {
            const color = colors[idx % colors.length];
            return `
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 flex flex-col hover:shadow-lg transition-shadow duration-300">
                    <div class="flex-grow">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 dark:bg-${color}-900/50 dark:text-${color}-300 mb-3">${faq.category}</span>
                        <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-2 leading-tight">${faq.question}</h3>
                        <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed line-clamp-2">${faq.answer.substring(0, 100)}...</p>
                        ${faq.keywords && faq.keywords.length > 0 ? `
                            <div class="mt-3 flex flex-wrap gap-2">
                                ${faq.keywords.map(k => `<span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded">${k}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-3">
                        <button onclick="editFAQ('${faq.id}')" class="flex-1 flex items-center justify-center gap-2 rounded-lg h-9 px-4 bg-gray-100 dark:bg-gray-700/50 text-gray-700 dark:text-gray-300 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <span class="material-symbols-outlined text-lg">edit</span>
                            <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                        </button>
                        <button onclick="deleteFAQ('${faq.id}')" class="flex-1 flex items-center justify-center gap-2 rounded-lg h-9 px-4 bg-red-50 dark:bg-red-500/10 text-red-600 dark:text-red-400 text-sm font-medium hover:bg-red-100 dark:hover:bg-red-500/20 transition-colors">
                            <span class="material-symbols-outlined text-lg">delete</span>
                            <span>–£–¥–∞–ª–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayListView(faqs) {
        const colors = ['blue', 'green', 'yellow', 'indigo', 'purple', 'pink'];
        document.getElementById('listViewBody').innerHTML = faqs.map((faq, idx) => {
            const color = colors[idx % colors.length];
            return `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                    <td class="px-6 py-4 text-gray-800 dark:text-gray-200 text-sm font-medium max-w-sm truncate">${faq.question}</td>
                    <td class="px-6 py-4 text-gray-500 dark:text-gray-400 text-sm max-w-sm truncate">${faq.answer.substring(0, 100)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-${color}-100 text-${color}-800 dark:bg-${color}-900/50 dark:text-${color}-300">${faq.category}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center gap-4">
                            <button onclick="editFAQ('${faq.id}')" class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-xl">edit</span>
                            </button>
                            <button onclick="deleteFAQ('${faq.id}')" class="text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-500 transition-colors flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-xl">delete</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function loadCategories(selectedCategory = '') {
        const select = document.getElementById('faqCategory');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';

        try {
            const response = await fetchWithAuth(`${BASE_URL}/categories`);
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');

            const categories = await response.json();
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                if (cat === selectedCategory) option.selected = true;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        }
    }

    async function openAddModal() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å FAQ';
        document.getElementById('faqForm').reset();
        document.getElementById('faqId').value = '';
        await loadCategories();
        initAnswerEditor();
        if (answerEditor) answerEditor.setText('');
        document.getElementById('faqModal').style.display = 'flex';
    }

    async function editFAQ(id) {
        const response = await fetchWithAuth(`${BASE_URL}/faq/${id}`);
        const faq = await response.json();

        currentEditId = id;
        document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å FAQ';
        document.getElementById('faqId').value = faq.id;
        loadCategories(faq.category);
        document.getElementById('faqQuestion').value = faq.question;
        document.getElementById('faqKeywords').value = faq.keywords.join(', ');

        initAnswerEditor();
        if (answerEditor) {
            const quillHtml = convertTelegramToQuillHtml(faq.answer);
            answerEditor.root.innerHTML = quillHtml;
            const telegramHtml = convertQuillToTelegramHtml(answerEditor.root.innerHTML);
            document.getElementById('faqAnswer').value = telegramHtml;
        }

        document.getElementById('faqModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('faqModal').style.display = 'none';
        if (answerEditor) answerEditor.setText('');
    }

    function openCategoryModal() {
        document.getElementById('categoryModal').style.display = 'flex';
    }

    function closeCategoryModal() {
        document.getElementById('categoryModal').style.display = 'none';
    }

    async function saveCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            return;
        }

        const response = await fetchWithAuth(`${BASE_URL}/categories`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name })
        });

        if (response.ok) {
            document.getElementById('newCategoryName').value = '';
            closeCategoryModal();
            await loadCategories(name);
            document.getElementById('faqCategory').value = name;
        } else {
            const data = await response.json();
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
    }

    document.getElementById('faqForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            category: document.getElementById('faqCategory').value,
            question: document.getElementById('faqQuestion').value,
            answer: document.getElementById('faqAnswer').value,
            keywords: document.getElementById('faqKeywords').value
        };

        if (currentEditId) data.id = currentEditId;

        let response;
        if (currentEditId) {
            response = await fetchWithAuth(`${BASE_URL}/faq/update/${currentEditId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        } else {
            response = await fetchWithAuth(`${BASE_URL}/faq/add`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            closeModal();
            clearSearch();
        } else {
            showNotification(result.message, 'error');
        }
    });

    async function deleteFAQ(id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç FAQ?')) return;

        const response = await fetchWithAuth(`${BASE_URL}/faq/delete/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showNotification(result.message, 'success');
            clearSearch();
        } else {
            showNotification(result.message, 'error');
        }
    }

    async function retrainModel() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) return;

        showNotification('–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...', 'info');

        const response = await fetchWithAuth(`${BASE_URL}/retrain`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showNotification(`${result.message} (${result.count} –∑–∞–ø–∏—Å–µ–π)`, 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏: ' + result.message, 'error');
        }
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg z-[100] text-white font-medium ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 3000);
    }

    // ========== –≠–ö–°–ü–û–†–¢ –î–õ–Ø –ê–ö–¢–£–ê–õ–ò–ó–ê–¶–ò–ò ==========

    function toggleExportMenu() {
        const menu = document.getElementById('exportMenu');
        menu.classList.toggle('hidden');
    }

    // –ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('exportMenu');
        const button = event.target.closest('button[onclick="toggleExportMenu()"]');

        if (!button && !menu.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });

    function exportForReview(format) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Ñ–∏–ª—å—Ç—Ä–∞
        const category = document.getElementById('categoryFilter').value || 'all';

        // –§–æ—Ä–º–∏—Ä—É–µ–º URL
        const url = `${BASE_URL}/export-review?category=${encodeURIComponent(category)}&format=${format}`;

        // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
        document.getElementById('exportMenu').classList.add('hidden');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showNotification(`–ó–∞–≥—Ä—É–∑–∫–∞ ${format === 'pdf' ? 'PDF' : 'Excel'} —Ñ–∞–π–ª–∞...`, 'info');

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ (–±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫–∞—á–∞–µ—Ç)
        window.open(url, '_blank');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setView(currentView);
    loadFAQs();
</script>
</body>
</html>
