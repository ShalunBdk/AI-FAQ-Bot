<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>–õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b8cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4">
        <div class="flex flex-col h-full">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-primary rounded-lg size-10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-white">support_agent</span>
                </div>
                <h1 class="text-lg font-bold text-gray-800 dark:text-white">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="/admin/">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">import_contacts</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="/admin/logs">
                    <span class="material-symbols-outlined fill">receipt_long</span>
                    <p class="text-sm font-bold leading-normal">–õ–æ–≥–∏</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="/admin/permissions">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">admin_panel_settings</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="/admin/settings">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">settings</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-10">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <h1 class="text-gray-800 dark:text-white text-3xl font-bold leading-tight">–õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">–ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —á–∞—Ç-–±–æ—Ç–æ–º.</p>
                </div>
                <div class="flex gap-3">
                    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ -->
                    <div class="relative">
                        <button onclick="toggleColumnsDropdown()" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-gray-500 text-white text-sm font-bold shadow-sm hover:bg-gray-600 transition-colors">
                            <span class="material-symbols-outlined text-xl">view_column</span>
                            <span class="truncate">–°—Ç–æ–ª–±—Ü—ã</span>
                        </button>
                        <!-- Dropdown –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤ -->
                        <div id="columnsDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                            <div class="p-3">
                                <div class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã:</div>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-time" onchange="toggleColumn('time')" class="w-4 h-4 text-primary rounded">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–í—Ä–µ–º—è</span>
                                </label>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-user" onchange="toggleColumn('user')" class="w-4 h-4 text-primary rounded" checked>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                                </label>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-platform" onchange="toggleColumn('platform')" class="w-4 h-4 text-primary rounded">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</span>
                                </label>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-question" onchange="toggleColumn('question')" class="w-4 h-4 text-primary rounded" checked>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–í–æ–ø—Ä–æ—Å</span>
                                </label>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-answer" onchange="toggleColumn('answer')" class="w-4 h-4 text-primary rounded" checked>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–û—Ç–≤–µ—Ç</span>
                                </label>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-similarity" onchange="toggleColumn('similarity')" class="w-4 h-4 text-primary rounded" checked>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–¢–æ—á–Ω–æ—Å—Ç—å</span>
                                </label>
                                <label class="flex items-center gap-2 py-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 px-2 rounded">
                                    <input type="checkbox" id="col-rating" onchange="toggleColumn('rating')" class="w-4 h-4 text-primary rounded" checked>
                                    <span class="text-sm text-gray-700 dark:text-gray-300">–û—Ü–µ–Ω–∫–∞</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button onclick="exportLogs()" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-green-500 text-white text-sm font-bold shadow-sm hover:bg-green-600 transition-colors">
                        <span class="material-symbols-outlined text-xl">download</span>
                        <span class="truncate">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</span>
                    </button>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8">
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 text-center">
                    <h3 id="stat-total-queries" class="text-gray-800 dark:text-white text-3xl font-bold mb-1">0</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</p>
                </div>
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 text-center">
                    <h3 id="stat-avg-similarity" class="text-gray-800 dark:text-white text-3xl font-bold mb-1">0%</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">–°—Ä–µ–¥–Ω—è—è —Å—Ö–æ–∂–µ—Å—Ç—å</p>
                </div>
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 text-center">
                    <h3 id="stat-helpful-percentage" class="text-gray-800 dark:text-white text-3xl font-bold mb-1">0%</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">–ü–æ–ª–µ–∑–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</p>
                </div>
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 text-center">
                    <h3 id="stat-helpful-count" class="text-green-600 dark:text-green-400 text-3xl font-bold mb-1">0</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">üëç –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö</p>
                </div>
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 text-center">
                    <h3 id="stat-not-helpful-count" class="text-red-600 dark:text-red-400 text-3xl font-bold mb-1">0</h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">üëé –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö</p>
                </div>
                <div onclick="showNoAnswerQueries()" class="bg-white dark:bg-[#182431] rounded-xl shadow-md border-2 border-red-500 p-6 text-center cursor-pointer hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
                    <h3 id="stat-no-answer-count" class="text-red-600 dark:text-red-400 text-3xl font-bold mb-1">0</h3>
                    <p class="text-red-600 dark:text-red-400 text-sm font-semibold">‚ùå –ë–µ–∑ –æ—Ç–≤–µ—Ç–∞</p>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-gray-800 dark:text-white text-xl font-bold">–§–∏–ª—å—Ç—Ä—ã</h2>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="filter-no-answer" onchange="applyFilters()" class="w-5 h-5 text-red-600 rounded focus:ring-red-500">
                        <span class="text-red-600 dark:text-red-400 font-semibold text-sm">–¢–æ–ª—å–∫–æ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É</label>
                        <input type="text" id="filter-search" oninput="handleSearchInput()" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–û—Ü–µ–Ω–∫–∞</label>
                        <select id="filter-rating" onchange="applyFilters()" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <option value="">–í—Å–µ</option>
                            <option value="helpful">üëç –ü–æ–ª–µ–∑–Ω–æ</option>
                            <option value="not_helpful">üëé –ù–µ –ø–æ–º–æ–≥–ª–æ</option>
                            <option value="no_rating">–ë–µ–∑ –æ—Ü–µ–Ω–∫–∏</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
                        <select id="filter-platform" onchange="applyFilters()" class="form-select w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                            <option value="">–í—Å–µ</option>
                            <option value="telegram">‚úàÔ∏è Telegram</option>
                            <option value="bitrix24">üíº Bitrix24</option>
                            <option value="web">üåê Web</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–î–∞—Ç–∞ –æ—Ç</label>
                        <input type="date" id="filter-date-from" onchange="applyFilters()" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">–î–∞—Ç–∞ –¥–æ</label>
                        <input type="date" id="filter-date-to" onchange="applyFilters()" class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="resetFilters()" class="px-5 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </div>

            <!-- Loading/No Data Messages -->
            <div id="loading" class="text-center py-12 text-primary" style="display: none;">
                <span class="material-symbols-outlined text-4xl animate-spin inline-block mb-2">refresh</span>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>

            <div id="no-data" class="text-center py-12 text-gray-500" style="display: none;">
                <span class="material-symbols-outlined text-6xl mb-4 opacity-50">inbox</span>
                <p class="text-xl">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
            </div>

            <!-- Table Container -->
            <div id="table-container" class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700/50 dark:text-gray-400">
                            <tr>
                                <th class="px-6 py-3" data-column="time">–í—Ä–µ–º—è</th>
                                <th class="px-6 py-3" data-column="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                <th class="px-6 py-3" data-column="platform">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                                <th class="px-6 py-3" data-column="question">–í–æ–ø—Ä–æ—Å</th>
                                <th class="px-6 py-3" data-column="answer">–û—Ç–≤–µ—Ç</th>
                                <th class="px-6 py-3 text-center" data-column="similarity">–¢–æ—á–Ω–æ—Å—Ç—å</th>
                                <th class="px-6 py-3 text-center" data-column="rating">–û—Ü–µ–Ω–∫–∞</th>
                            </tr>
                        </thead>
                        <tbody id="logs-tbody">
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-[#182431] px-4 py-3 sm:px-6">
                    <div class="flex flex-1 justify-between sm:hidden">
                        <button onclick="changePage(currentPage - 1)" class="relative inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">–ù–∞–∑–∞–¥</button>
                        <button onclick="changePage(currentPage + 1)" class="relative ml-3 inline-flex items-center rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                    <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                        <div>
                            <p id="page-info" class="text-sm text-gray-700 dark:text-gray-400">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="prev-btn" onclick="changePage(currentPage - 1)" class="relative inline-flex items-center rounded-lg px-3 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined">chevron_left</span>
                            </button>
                            <button id="next-btn" onclick="changePage(currentPage + 1)" class="relative inline-flex items-center rounded-lg px-3 py-2 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined">chevron_right</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let currentPage = 1;
    let totalPages = 1;
    let currentFilters = {};
    let similarityThreshold = 45;

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã: time –∏ platform)
    let visibleColumns = JSON.parse(localStorage.getItem('logsVisibleColumns')) || {
        time: false,
        user: true,
        platform: false,
        question: true,
        answer: true,
        similarity: true,
        rating: true
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("DOMContentLoaded", () => {
        initializeColumnVisibility();
        loadStatistics();
        loadLogs();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
    function initializeColumnVisibility() {
        Object.keys(visibleColumns).forEach(col => {
            const checkbox = document.getElementById(`col-${col}`);
            if (checkbox) {
                checkbox.checked = visibleColumns[col];
                applyColumnVisibility(col, visibleColumns[col]);
            }
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ dropdown
    function toggleColumnsDropdown() {
        const dropdown = document.getElementById('columnsDropdown');
        dropdown.classList.toggle('hidden');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('columnsDropdown');
        const button = event.target.closest('button[onclick="toggleColumnsDropdown()"]');
        if (!dropdown.contains(event.target) && !button) {
            dropdown.classList.add('hidden');
        }
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–æ–ª–±—Ü–∞
    function toggleColumn(columnName) {
        visibleColumns[columnName] = !visibleColumns[columnName];
        localStorage.setItem('logsVisibleColumns', JSON.stringify(visibleColumns));
        applyColumnVisibility(columnName, visibleColumns[columnName]);
    }

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç–æ–ª–±—Ü–∞
    function applyColumnVisibility(columnName, isVisible) {
        const headers = document.querySelectorAll(`th[data-column="${columnName}"]`);
        const cells = document.querySelectorAll(`td[data-column="${columnName}"]`);

        const displayValue = isVisible ? '' : 'none';
        headers.forEach(header => header.style.display = displayValue);
        cells.forEach(cell => cell.style.display = displayValue);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadStatistics() {
        try {
            const response = await fetch("/admin/api/logs/statistics");
            const data = await response.json();

            if (data.success) {
                const stats = data.statistics;
                document.getElementById("stat-total-queries").textContent = stats.total_queries || 0;
                document.getElementById("stat-avg-similarity").textContent = (stats.avg_similarity || 0) + "%";
                document.getElementById("stat-helpful-percentage").textContent = (stats.helpful_percentage || 0) + "%";
                document.getElementById("stat-helpful-count").textContent = stats.helpful_count || 0;
                document.getElementById("stat-not-helpful-count").textContent = stats.not_helpful_count || 0;
                document.getElementById("stat-no-answer-count").textContent = stats.no_answer_count || 0;

                if (stats.similarity_threshold) {
                    similarityThreshold = stats.similarity_threshold;
                }
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
    async function loadLogs(page = 1) {
        document.getElementById("loading").style.display = "block";
        document.getElementById("table-container").style.display = "none";
        document.getElementById("no-data").style.display = "none";

        try {
            const params = new URLSearchParams({
                page: page,
                per_page: 50,
                ...currentFilters,
            });

            const response = await fetch(`/admin/api/logs/list?${params}`);
            const data = await response.json();

            document.getElementById("loading").style.display = "none";

            if (data.success && data.logs.length > 0) {
                displayLogs(data.logs);
                updatePagination(data.pagination);
                document.getElementById("table-container").style.display = "block";
            } else {
                document.getElementById("no-data").style.display = "block";
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:", error);
            document.getElementById("loading").style.display = "none";
            document.getElementById("no-data").style.display = "block";
        }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ
    function displayLogs(logs) {
        const tbody = document.getElementById("logs-tbody");
        tbody.innerHTML = "";

        logs.forEach((log) => {
            const row = document.createElement("tr");

            const noAnswer = !log.faq_id || (log.similarity_score && log.similarity_score < similarityThreshold);

            row.className = "border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/30 transition-colors";

            if (noAnswer) {
                row.classList.add("bg-orange-50/50", "dark:bg-orange-500/10");
            } else {
                row.classList.add("bg-white", "dark:bg-[#182431]");
            }

            const dateStr = log.query_timestamp + " UTC+7";

            const score = log.similarity_score || 0;
            const scoreClass = score >= 70 ? "text-green-600 dark:text-green-400" :
                              score >= 50 ? "text-yellow-600 dark:text-yellow-400" :
                              "text-red-600 dark:text-red-400";

            let ratingHTML = '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">-</span>';
            if (log.rating === "helpful") {
                ratingHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300"><span class="material-symbols-outlined text-sm fill">thumb_up</span> –ü–æ–ª–µ–∑–Ω–æ</span>';
            } else if (log.rating === "not_helpful") {
                ratingHTML = '<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300"><span class="material-symbols-outlined text-sm fill">thumb_down</span> –ù–µ –ø–æ–º–æ–≥–ª–æ</span>';
            }

            const platform = log.platform || "telegram";
            let platformIcon, platformText, platformClass;

            if (platform === "bitrix24") {
                platformIcon = "üíº";
                platformText = "Bitrix24";
                platformClass = "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300";
            } else if (platform === "web") {
                platformIcon = "üåê";
                platformText = "Web";
                platformClass = "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300";
            } else {
                platformIcon = "‚úàÔ∏è";
                platformText = "Telegram";
                platformClass = "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300";
            }

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-gray-900 dark:text-white font-medium" data-column="time">${dateStr}</td>
                <td class="px-6 py-4" data-column="user">
                    <div class="text-gray-900 dark:text-white font-medium">${log.username || "N/A"}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">ID: ${log.user_id}</div>
                </td>
                <td class="px-6 py-4" data-column="platform">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${platformClass}">${platformIcon} ${platformText}</span>
                </td>
                <td class="px-6 py-4" data-column="question">
                    <div class="max-w-xs truncate text-gray-800 dark:text-gray-200" title="${log.query_text}">
                        ${noAnswer ? "‚ùå " : ""}${log.query_text}
                    </div>
                </td>
                <td class="px-6 py-4" data-column="answer">
                    ${log.faq_question ? `
                        <div class="max-w-xs truncate text-gray-800 dark:text-gray-200" title="${log.faq_question}">${log.faq_question}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${log.category || ""}</div>
                    ` : '<span class="text-red-600 dark:text-red-400 font-semibold text-sm">–û—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</span>'}
                </td>
                <td class="px-6 py-4 text-center" data-column="similarity">
                    <span class="font-bold ${scoreClass}">${score.toFixed(1)}%</span>
                </td>
                <td class="px-6 py-4 text-center" data-column="rating">${ratingHTML}</td>
            `;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç–æ–ª–±—Ü–æ–≤
            Object.keys(visibleColumns).forEach(col => {
                const cells = row.querySelectorAll(`td[data-column="${col}"]`);
                if (!visibleColumns[col]) {
                    cells.forEach(cell => cell.style.display = 'none');
                }
            });

            tbody.appendChild(row);
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function updatePagination(pagination) {
        currentPage = pagination.page;
        totalPages = pagination.total_pages;

        document.getElementById("page-info").textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages} (–≤—Å–µ–≥–æ: ${pagination.total})`;

        document.getElementById("prev-btn").disabled = currentPage <= 1;
        document.getElementById("next-btn").disabled = currentPage >= totalPages;
    }

    // –°–º–µ–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function changePage(page) {
        if (page >= 1 && page <= totalPages) {
            loadLogs(page);
        }
    }

    // Debounce —Ñ—É–Ω–∫—Ü–∏—è
    let searchDebounceTimer;
    function debounce(func, delay) {
        return function () {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(func, delay);
        };
    }

    const handleSearchInput = debounce(() => {
        applyFilters();
    }, 500);

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function applyFilters() {
        currentFilters = {};

        const search = document.getElementById("filter-search").value.trim();
        if (search) currentFilters.search = search;

        const rating = document.getElementById("filter-rating").value;
        if (rating) currentFilters.rating = rating;

        const platform = document.getElementById("filter-platform").value;
        if (platform) currentFilters.platform = platform;

        const dateFrom = document.getElementById("filter-date-from").value;
        if (dateFrom) currentFilters.date_from = dateFrom;

        const dateTo = document.getElementById("filter-date-to").value;
        if (dateTo) currentFilters.date_to = dateTo;

        const noAnswer = document.getElementById("filter-no-answer").checked;
        if (noAnswer) currentFilters.no_answer = "true";

        loadLogs(1);
        loadStatistics();
    }

    // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetFilters() {
        document.getElementById("filter-search").value = "";
        document.getElementById("filter-rating").value = "";
        document.getElementById("filter-platform").value = "";
        document.getElementById("filter-date-from").value = "";
        document.getElementById("filter-date-to").value = "";
        document.getElementById("filter-no-answer").checked = false;
        currentFilters = {};
        loadLogs(1);
        loadStatistics();
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
    function exportLogs() {
        const params = new URLSearchParams(currentFilters);
        window.location.href = `/admin/api/logs/export?${params}`;
    }

    // –ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä "–ë–µ–∑ –æ—Ç–≤–µ—Ç–∞"
    function showNoAnswerQueries() {
        document.getElementById("filter-no-answer").checked = true;
        document.getElementById("filter-search").value = "";
        document.getElementById("filter-rating").value = "";
        document.getElementById("filter-date-from").value = "";
        document.getElementById("filter-date-to").value = "";
        applyFilters();
        document.getElementById("table-container").scrollIntoView({ behavior: "smooth", block: "start" });
    }
</script>
</body>
</html>
