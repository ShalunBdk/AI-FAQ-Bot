<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Рассылка - Панель администратора</title>

    <link href="{{ url_for('static', filename='css/output.css') }}" rel="stylesheet"/>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>

    <style>
        /* Стили для сворачивающегося сайдбара */
        .sidebar-expanded {
            width: 16rem;
        }

        .sidebar-collapsed {
            width: 4.5rem;
        }

        .sidebar-collapsed .sidebar-text {
            display: none;
        }

        .sidebar-text {
            transition: opacity 0.2s ease-in-out;
        }

        .sidebar-collapsed .sidebar-text {
            opacity: 0;
        }

        #sidebar.sidebar-collapsed > div > div:first-child > div:first-child {
            justify-content: center !important;
        }

        #sidebar.sidebar-collapsed nav a {
            justify-content: center !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        /* Анимация прогресс-бара */
        @keyframes progress-stripes {
            0% { background-position: 1rem 0; }
            100% { background-position: 0 0; }
        }

        .progress-animated {
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.15) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.15) 75%,
                transparent 75%,
                transparent
            );
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">

    <aside id="sidebar" class="sidebar-expanded bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4 transition-all duration-300">
        <div class="flex flex-col h-full">
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-primary rounded-lg size-10 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-white">support_agent</span>
                    </div>
                    <h1 class="sidebar-text text-lg font-bold text-gray-800 dark:text-white whitespace-nowrap overflow-hidden">Админ-панель</h1>
                </div>
                <button onclick="toggleSidebar()" class="w-full flex items-center justify-center gap-2 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors" title="Свернуть/развернуть меню">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 text-xl">menu</span>
                    <span class="sidebar-text text-sm font-medium text-gray-600 dark:text-gray-400">Свернуть меню</span>
                </button>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/" title="База знаний">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">import_contacts</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">База знаний</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/logs" title="Логи">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">receipt_long</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">Логи</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/test-periods" title="Тестирование">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">science</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">Тестирование</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="{{ config.get('BASE_PATH', '') }}/admin/broadcast" title="Рассылка">
                    <span class="material-symbols-outlined fill flex-shrink-0">campaign</span>
                    <p class="sidebar-text text-sm font-bold leading-normal whitespace-nowrap overflow-hidden">Рассылка</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/permissions" title="Права доступа">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">admin_panel_settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">Права доступа</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="{{ config.get('BASE_PATH', '') }}/admin/settings" title="Настройки">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400 flex-shrink-0">settings</span>
                    <p class="sidebar-text text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal whitespace-nowrap overflow-hidden">Настройки</p>
                </a>
            </nav>
        </div>
    </aside>

    <main class="flex-1 p-6 lg:p-10">
        <div class="max-w-5xl mx-auto">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <h1 class="text-gray-800 dark:text-white text-3xl font-bold leading-tight">Рассылка сообщений</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">Отправка сообщений всем пользователям Bitrix24 от имени бота.</p>
                </div>
            </div>

            <!-- Форма создания рассылки -->
            <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6 mb-6">
                <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">edit_note</span>
                    Новая рассылка
                </h3>

                <form id="broadcastForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Название рассылки *</label>
                        <input type="text" id="broadcastTitle" required class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white" placeholder="Например: Поздравление с Новым годом">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Только для идентификации в истории. Пользователи это название не увидят.
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Текст сообщения * (поддерживается BB-code)</label>
                        <textarea id="broadcastMessage" rows="6" required class="w-full form-input rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white font-mono text-sm" placeholder="[b]Уважаемые коллеги![/b]

Поздравляем вас с праздником!

[i]С уважением, команда HR[/i]"></textarea>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            BB-коды: [b]жирный[/b], [i]курсив[/i], [u]подчёркнутый[/u], [s]зачёркнутый[/s], [URL=ссылка]текст[/URL]
                        </p>
                    </div>

                    <div class="flex gap-3 justify-end pt-2">
                        <button type="submit" class="flex items-center justify-center gap-2 rounded-lg h-11 px-5 bg-primary text-white text-sm font-bold shadow-sm hover:bg-primary/90 transition-colors">
                            <span class="material-symbols-outlined text-xl">send</span>
                            <span>Создать и отправить</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- История рассылок -->
            <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">history</span>
                    История рассылок
                </h3>

                <div id="broadcastsLoading" class="text-center py-8">
                    <span class="material-symbols-outlined text-4xl animate-spin text-primary">refresh</span>
                    <p class="mt-2 text-gray-500 dark:text-gray-400">Загрузка...</p>
                </div>

                <div id="broadcastsList" class="hidden">
                    <div id="broadcastsEmpty" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">inbox</span>
                        <p>Рассылок пока нет</p>
                    </div>

                    <div id="broadcastsTable" class="overflow-x-auto hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-gray-700/50">
                                <tr>
                                    <th class="px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Дата</th>
                                    <th class="px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Автор</th>
                                    <th class="px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Название</th>
                                    <th class="px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Статус</th>
                                    <th class="px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Прогресс</th>
                                    <th class="px-4 py-3 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="broadcastsBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Модалка подтверждения отправки -->
<div id="confirmModal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center" style="display: none;">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
            <span class="material-symbols-outlined text-yellow-500">warning</span>
            Подтверждение отправки
        </h3>
        <p class="text-gray-600 dark:text-gray-300 mb-4">
            Сообщение будет отправлено <strong id="confirmUsersCount">0</strong> пользователям.
        </p>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
            Примерное время отправки: <strong id="confirmTime">0</strong> мин.
        </p>
        <div class="flex gap-3 justify-end">
            <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">Отмена</button>
            <button onclick="confirmSend()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined">send</span>
                <span>Отправить</span>
            </button>
        </div>
    </div>
</div>

<!-- Модалка логов рассылки -->
<div id="logsModal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center" style="display: none;">
    <div class="bg-white dark:bg-[#182431] rounded-xl shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Детальный лог рассылки</h3>
            <button onclick="closeLogsModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div id="logsContent" class="overflow-y-auto flex-1">
            <div class="text-center py-8">
                <span class="material-symbols-outlined text-4xl animate-spin text-primary">refresh</span>
            </div>
        </div>
    </div>
</div>

<script>
    const BASE_URL = '{{ config.get("BASE_PATH", "") }}/admin';

    let pendingBroadcastId = null;
    let usersCount = 0;
    let progressIntervals = {};

    // ========== ФУНКЦИИ ДЛЯ САЙДБАРА ==========
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const isExpanded = sidebar.classList.contains('sidebar-expanded');

        if (isExpanded) {
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
            localStorage.setItem('sidebarState', 'collapsed');
        } else {
            sidebar.classList.remove('sidebar-collapsed');
            sidebar.classList.add('sidebar-expanded');
            localStorage.setItem('sidebarState', 'expanded');
        }
    }

    function restoreSidebarState() {
        const savedState = localStorage.getItem('sidebarState');
        if (savedState === 'collapsed') {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('sidebar-expanded');
            sidebar.classList.add('sidebar-collapsed');
        }
    }

    restoreSidebarState();

    // ========== УВЕДОМЛЕНИЯ ==========
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg z-[100] text-white font-medium transition-all duration-300 transform translate-x-[400px] ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;

        const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';
        notification.innerHTML = `<span class="material-symbols-outlined mr-2 align-middle">${icon}</span><span>${message}</span>`;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 10);

        setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // ========== ЗАГРУЗКА РАССЫЛОК ==========
    async function loadBroadcasts() {
        try {
            const response = await fetchWithAuth(`${BASE_URL}/api/broadcast/list`);
            const data = await response.json();

            document.getElementById('broadcastsLoading').classList.add('hidden');
            document.getElementById('broadcastsList').classList.remove('hidden');

            if (!data.success || !data.broadcasts || data.broadcasts.length === 0) {
                document.getElementById('broadcastsEmpty').classList.remove('hidden');
                document.getElementById('broadcastsTable').classList.add('hidden');
                return;
            }

            document.getElementById('broadcastsEmpty').classList.add('hidden');
            document.getElementById('broadcastsTable').classList.remove('hidden');

            const tbody = document.getElementById('broadcastsBody');
            tbody.innerHTML = data.broadcasts.map(b => renderBroadcastRow(b)).join('');

            // Запускаем polling для активных рассылок
            data.broadcasts.forEach(b => {
                if (b.status === 'sending') {
                    startProgressPolling(b.id);
                }
            });

        } catch (error) {
            console.error('Ошибка загрузки рассылок:', error);
            showNotification('Ошибка загрузки рассылок', 'error');
        }
    }

    function renderBroadcastRow(b) {
        const statusBadge = getStatusBadge(b.status);
        const progress = b.total_recipients > 0 ? Math.round((b.sent_count + b.failed_count) / b.total_recipients * 100) : 0;

        let progressHtml = '';
        if (b.status === 'sending') {
            progressHtml = `
                <div class="w-32">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>${b.sent_count + b.failed_count} / ${b.total_recipients}</span>
                        <span>${progress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div class="bg-blue-500 h-2 rounded-full progress-animated transition-all" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        } else if (b.status === 'sent' || b.status === 'cancelled') {
            progressHtml = `
                <div class="text-sm">
                    <span class="text-green-600 dark:text-green-400">${b.sent_count}</span>
                    ${b.failed_count > 0 ? `/ <span class="text-red-600 dark:text-red-400">${b.failed_count}</span>` : ''}
                    <span class="text-gray-400">из ${b.total_recipients}</span>
                </div>
            `;
        } else {
            progressHtml = '<span class="text-gray-400">-</span>';
        }

        let actionsHtml = '';
        if (b.status === 'sending') {
            actionsHtml = `
                <button onclick="cancelBroadcast(${b.id})" class="text-red-500 hover:text-red-700 transition-colors" title="Остановить">
                    <span class="material-symbols-outlined">stop_circle</span>
                </button>
            `;
        }

        // Кнопка логов для всех завершённых рассылок
        if (b.status !== 'draft') {
            actionsHtml += `
                <button onclick="showLogs(${b.id})" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors" title="Логи">
                    <span class="material-symbols-outlined">list_alt</span>
                </button>
            `;
        }

        // Если нет действий — показываем прочерк
        if (!actionsHtml) {
            actionsHtml = '<span class="text-gray-400">-</span>';
        }

        return `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50" id="broadcast-row-${b.id}">
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300 whitespace-nowrap">${b.created_at || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300">${escapeHtml(b.created_by || 'Неизвестно')}</td>
                <td class="px-4 py-3 text-sm text-gray-800 dark:text-white font-medium">${escapeHtml(b.title)}</td>
                <td class="px-4 py-3">${statusBadge}</td>
                <td class="px-4 py-3" id="progress-${b.id}">${progressHtml}</td>
                <td class="px-4 py-3 flex items-center gap-1">${actionsHtml}</td>
            </tr>
        `;
    }

    function getStatusBadge(status) {
        const badges = {
            'draft': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300">Черновик</span>',
            'sending': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300 flex items-center gap-1"><span class="material-symbols-outlined text-sm animate-spin">sync</span> Отправка</span>',
            'sent': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300">Отправлено</span>',
            'cancelled': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300">Отменено</span>',
            'failed': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300">Ошибка</span>'
        };
        return badges[status] || status;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========== СОЗДАНИЕ РАССЫЛКИ ==========
    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const title = document.getElementById('broadcastTitle').value.trim();
        const message = document.getElementById('broadcastMessage').value.trim();

        if (!title || !message) {
            showNotification('Заполните все поля', 'error');
            return;
        }

        try {
            // Сначала получаем количество пользователей
            showNotification('Подсчёт пользователей...', 'info');

            const countResponse = await fetchWithAuth(`${BASE_URL}/api/broadcast/users-count`);
            const countData = await countResponse.json();

            if (!countData.success) {
                showNotification('Ошибка: ' + countData.message, 'error');
                return;
            }

            usersCount = countData.count;

            // Создаём черновик
            const createResponse = await fetchWithAuth(`${BASE_URL}/api/broadcast`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, message})
            });

            const createData = await createResponse.json();

            if (!createData.success) {
                showNotification('Ошибка: ' + createData.message, 'error');
                return;
            }

            pendingBroadcastId = createData.broadcast_id;

            // Проверяем, что ID рассылки получен
            if (!pendingBroadcastId) {
                showNotification('Ошибка: не удалось создать рассылку (broadcast_id не получен)', 'error');
                return;
            }

            // Показываем подтверждение
            document.getElementById('confirmUsersCount').textContent = usersCount;
            document.getElementById('confirmTime').textContent = Math.ceil(usersCount * 0.5 / 60);
            document.getElementById('confirmModal').style.display = 'flex';

        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка создания рассылки', 'error');
        }
    });

    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
        pendingBroadcastId = null;
    }

    async function confirmSend() {
        if (!pendingBroadcastId) return;

        // Сохраняем ID до закрытия модалки (closeConfirmModal обнуляет pendingBroadcastId)
        const broadcastId = pendingBroadcastId;

        closeConfirmModal();

        try {
            showNotification('Запуск рассылки...', 'info');

            const response = await fetchWithAuth(`${BASE_URL}/api/broadcast/${broadcastId}/send`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`Рассылка запущена для ${data.total} пользователей`, 'success');
                document.getElementById('broadcastForm').reset();
                loadBroadcasts();
            } else {
                showNotification('Ошибка: ' + data.message, 'error');
            }

        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка запуска рассылки', 'error');
        }
    }

    // ========== POLLING ПРОГРЕССА ==========
    function startProgressPolling(broadcastId) {
        if (progressIntervals[broadcastId]) return;

        progressIntervals[broadcastId] = setInterval(async () => {
            try {
                const response = await fetchWithAuth(`${BASE_URL}/api/broadcast/${broadcastId}`);
                const data = await response.json();

                if (!data.success) {
                    stopProgressPolling(broadcastId);
                    return;
                }

                const b = data.broadcast;
                updateBroadcastRow(b);

                if (b.status !== 'sending') {
                    stopProgressPolling(broadcastId);
                    showNotification(`Рассылка "${b.title}" ${b.status === 'sent' ? 'завершена' : 'отменена'}`, b.status === 'sent' ? 'success' : 'info');
                }

            } catch (error) {
                console.error('Ошибка polling:', error);
                stopProgressPolling(broadcastId);
            }
        }, 2000);
    }

    function stopProgressPolling(broadcastId) {
        if (progressIntervals[broadcastId]) {
            clearInterval(progressIntervals[broadcastId]);
            delete progressIntervals[broadcastId];
        }
    }

    function updateBroadcastRow(b) {
        const row = document.getElementById(`broadcast-row-${b.id}`);
        if (row) {
            row.outerHTML = renderBroadcastRow(b);
        }
    }

    // ========== ДЕЙСТВИЯ С РАССЫЛКАМИ ==========
    async function cancelBroadcast(id) {
        if (!confirm('Вы уверены, что хотите остановить рассылку?')) return;

        try {
            const response = await fetchWithAuth(`${BASE_URL}/api/broadcast/${id}/cancel`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Рассылка остановлена', 'success');
            } else {
                showNotification('Ошибка: ' + data.message, 'error');
            }

        } catch (error) {
            showNotification('Ошибка остановки рассылки', 'error');
        }
    }

    async function deleteBroadcast(id) {
        if (!confirm('Вы уверены, что хотите удалить рассылку?')) return;

        try {
            const response = await fetchWithAuth(`${BASE_URL}/api/broadcast/${id}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Рассылка удалена', 'success');
                loadBroadcasts();
            } else {
                showNotification('Ошибка: ' + data.message, 'error');
            }

        } catch (error) {
            showNotification('Ошибка удаления рассылки', 'error');
        }
    }

    // ========== ЛОГИ ==========
    async function showLogs(id) {
        document.getElementById('logsModal').style.display = 'flex';
        document.getElementById('logsContent').innerHTML = '<div class="text-center py-8"><span class="material-symbols-outlined text-4xl animate-spin text-primary">refresh</span></div>';

        try {
            const response = await fetchWithAuth(`${BASE_URL}/api/broadcast/${id}/logs`);
            const data = await response.json();

            if (!data.success || !data.logs || data.logs.length === 0) {
                document.getElementById('logsContent').innerHTML = '<p class="text-center text-gray-500 py-8">Логов пока нет</p>';
                return;
            }

            const logsHtml = `
                <div class="space-y-2">
                    ${data.logs.map(log => `
                        <div class="flex items-center justify-between p-2 rounded-lg ${log.status === 'sent' ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm ${log.status === 'sent' ? 'text-green-600' : 'text-red-600'}">
                                    ${log.status === 'sent' ? 'check_circle' : 'error'}
                                </span>
                                <span class="text-sm font-medium text-gray-800 dark:text-white">${escapeHtml(log.user_name || 'ID: ' + log.user_id)}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${log.status === 'sent' ? log.sent_at || '' : (log.error_message ? escapeHtml(log.error_message.substring(0, 50)) : 'Ошибка')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('logsContent').innerHTML = logsHtml;

        } catch (error) {
            document.getElementById('logsContent').innerHTML = '<p class="text-center text-red-500 py-8">Ошибка загрузки логов</p>';
        }
    }

    function closeLogsModal() {
        document.getElementById('logsModal').style.display = 'none';
    }

    // ========== ИНИЦИАЛИЗАЦИЯ ==========
    loadBroadcasts();
</script>
</body>
</html>
