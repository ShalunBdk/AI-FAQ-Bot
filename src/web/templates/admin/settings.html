<!DOCTYPE html>
<html class="light" lang="ru">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Настройки бота - Панель администратора</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b8cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1;
        }

        /* Quill Editor Styles */
        .wysiwyg-editor {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            height: auto !important;
        }
        .wysiwyg-editor .ql-toolbar {
            border: none;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
            padding: 8px;
        }
        .wysiwyg-editor .ql-container {
            border: none;
            font-size: 16px;
            font-family: inherit;
            height: 150px;
        }
        .wysiwyg-editor .ql-editor {
            height: 150px;
            padding: 12px;
            line-height: 1.6;
            overflow-y: auto;
        }

        /* Для длинного приветственного сообщения */
        #start_message_editor .ql-container,
        #start_message_editor .ql-editor {
            height: 180px;
        }

        /* Для коротких ответов на обратную связь */
        #feedback_response_yes_editor .ql-container,
        #feedback_response_no_editor .ql-container,
        #feedback_response_yes_editor .ql-editor,
        #feedback_response_no_editor .ql-editor {
            height: 100px;
        }

        .wysiwyg-editor .ql-editor.ql-blank::before {
            color: #adb5bd;
            font-style: normal;
        }
        .wysiwyg-editor:focus-within {
            border-color: #3498db;
        }

        /* Скрываем textarea для WYSIWYG редактора */
        .wysiwyg-source {
            display: none !important;
        }

        /* Telegram Preview */
        .telegram-message {
            background: #2481cc;
            color: white;
            padding: 12px 16px;
            border-radius: 12px 12px 12px 4px;
            max-width: 85%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .telegram-message strong { font-weight: bold; }
        .telegram-message em { font-style: italic; }
        .telegram-message code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }

        .telegram-button {
            background: white;
            color: #2481cc;
            padding: 10px 16px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 120px;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-[#1F2937] dark:text-gray-200">
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 flex-shrink-0 bg-white dark:bg-[#182431] border-r border-gray-200 dark:border-gray-700 p-4">
        <div class="flex flex-col h-full">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-primary rounded-lg size-10 flex items-center justify-center">
                    <span class="material-symbols-outlined text-white">support_agent</span>
                </div>
                <h1 class="text-lg font-bold text-gray-800 dark:text-white">Админ-панель</h1>
            </div>

            <nav class="flex flex-col gap-2 flex-grow">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="/admin/">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">import_contacts</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">База знаний</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="/admin/logs">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">receipt_long</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Логи</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors" href="/admin/permissions">
                    <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">admin_panel_settings</span>
                    <p class="text-gray-800 dark:text-gray-200 text-sm font-medium leading-normal">Права доступа</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 dark:bg-primary/30 text-primary dark:text-white" href="/admin/settings">
                    <span class="material-symbols-outlined fill">settings</span>
                    <p class="text-sm font-bold leading-normal">Настройки</p>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-10">
        <div class="max-w-5xl mx-auto">
            <!-- Header -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div class="flex flex-col gap-1">
                    <h1 class="text-gray-800 dark:text-white text-3xl font-bold leading-tight">Настройки бота</h1>
                    <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">Управление текстами и сообщениями Telegram-бота.</p>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center py-12 text-primary">
                <span class="material-symbols-outlined text-4xl animate-spin inline-block mb-2">refresh</span>
                <p>Загрузка настроек...</p>
            </div>

            <!-- Settings Form -->
            <form id="settingsForm" class="space-y-6" style="display: none;">
                <!-- Приветственное сообщение -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">waving_hand</span>
                        Приветственное сообщение (/start)
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        Это сообщение видят пользователи при нажатии на команду /start или /help. Используйте панель инструментов для форматирования текста.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Текст приветствия:</label>
                            <textarea id="start_message" class="wysiwyg-source" required></textarea>
                            <div id="start_message_editor" class="wysiwyg-editor"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Предпросмотр в Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4 min-h-[180px]">
                                <div class="telegram-message">
                                    <div id="start_message_preview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопка "Полезно" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500 fill">thumb_up</span>
                        Кнопка обратной связи "Полезно"
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        Текст кнопки, которая появляется под ответами бота.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Текст кнопки:</label>
                            <input type="text" id="feedback_button_yes" required class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Предпросмотр в Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-button" id="feedback_button_yes_preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопка "Не помогло" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-red-500 fill">thumb_down</span>
                        Кнопка обратной связи "Не помогло"
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        Текст кнопки для негативного отзыва.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Текст кнопки:</label>
                            <input type="text" id="feedback_button_no" required class="form-input w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Предпросмотр в Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-button" id="feedback_button_no_preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ответ на "Полезно" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500 fill">check_circle</span>
                        Ответ на положительный отзыв
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        Сообщение, которое видит пользователь после нажатия на кнопку "Полезно".
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Текст ответа:</label>
                            <textarea id="feedback_response_yes" class="wysiwyg-source" required></textarea>
                            <div id="feedback_response_yes_editor" class="wysiwyg-editor"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Предпросмотр в Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-message">
                                    <div id="feedback_response_yes_preview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ответ на "Не помогло" -->
                <div class="bg-white dark:bg-[#182431] rounded-xl shadow-md border border-gray-200 dark:border-gray-700 p-6">
                    <h3 class="text-gray-800 dark:text-white text-xl font-bold mb-2 flex items-center gap-2">
                        <span class="material-symbols-outlined text-red-500 fill">cancel</span>
                        Ответ на негативный отзыв
                    </h3>
                    <p class="text-gray-500 dark:text-gray-400 text-sm mb-4">
                        Сообщение, которое видит пользователь после нажатия на кнопку "Не помогло". Здесь можно указать контакты для дополнительной помощи.
                    </p>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 items-start">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Текст ответа:</label>
                            <textarea id="feedback_response_no" class="wysiwyg-source" required></textarea>
                            <div id="feedback_response_no_editor" class="wysiwyg-editor"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Предпросмотр в Telegram:</label>
                            <div class="bg-gray-100 dark:bg-gray-700/50 rounded-lg p-4">
                                <div class="telegram-message">
                                    <div id="feedback_response_no_preview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Действия -->
                <div class="flex gap-3 justify-end pt-4">
                    <button type="button" onclick="resetSettings()" class="flex items-center gap-2 px-5 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                        <span class="material-symbols-outlined">restart_alt</span>
                        <span>Сбросить к умолчаниям</span>
                    </button>
                    <button type="submit" class="flex items-center gap-2 px-5 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                        <span class="material-symbols-outlined">save</span>
                        <span>Сохранить изменения</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    const editors = {};

    // Конвертация Quill HTML в Telegram HTML
    function convertQuillToTelegramHtml(html) {
        html = html.replace(/<strong>/g, '<b>');
        html = html.replace(/<\/strong>/g, '</b>');
        html = html.replace(/<em>/g, '<i>');
        html = html.replace(/<\/em>/g, '</i>');
        html = html.replace(/<pre class="ql-syntax"[^>]*>/g, '<code>');
        html = html.replace(/<\/pre>/g, '</code>');
        html = html.replace(/<p><br><\/p>/g, '\n');
        html = html.replace(/<p>/g, '');
        html = html.replace(/<\/p>/g, '\n');
        html = html.replace(/<br>/g, '\n');
        html = html.replace(/<br\/>/g, '\n');
        html = html.replace(/<br \/>/g, '\n');
        html = html.replace(/\n+$/g, '');
        return html;
    }

    // Конвертация Telegram HTML в Quill HTML
    function convertTelegramToQuillHtml(html) {
        if (!html) return '<p><br></p>';
        html = html.replace(/<b>/g, '<strong>');
        html = html.replace(/<\/b>/g, '</strong>');
        html = html.replace(/<i>/g, '<em>');
        html = html.replace(/<\/i>/g, '</em>');
        html = html.replace(/<code>/g, '<code class="ql-code">');
        const lines = html.split('\n');
        const paragraphs = lines.map(line => {
            if (line.trim() === '') return '<p><br></p>';
            return '<p>' + line + '</p>';
        });
        return paragraphs.join('');
    }

    // Инициализация Quill редакторов
    function initWysiwygEditors() {
        if (Object.keys(editors).length > 0) return;

        const editorConfigs = [
            { id: "start_message", containerId: "start_message_editor" },
            { id: "feedback_response_yes", containerId: "feedback_response_yes_editor" },
            { id: "feedback_response_no", containerId: "feedback_response_no_editor" },
        ];

        editorConfigs.forEach((config) => {
            const container = document.getElementById(config.containerId);
            const textarea = document.getElementById(config.id);

            const quill = new Quill(`#${config.containerId}`, {
                theme: "snow",
                modules: {
                    toolbar: [
                        ["bold", "italic", "underline", "strike"],
                        ["code-block"],
                        ["clean"],
                    ],
                },
                placeholder: "Введите текст...",
            });

            editors[config.id] = quill;

            quill.on("text-change", () => {
                let html = quill.root.innerHTML;
                html = convertQuillToTelegramHtml(html);
                textarea.value = html;
                updatePreview(config.id, config.id + "_preview");
            });
        });
    }

    // Загрузка настроек
    async function loadSettings() {
        try {
            const response = await fetch("/admin/api/settings");
            const data = await response.json();

            if (data.success) {
                const settings = data.settings;

                document.getElementById("feedback_button_yes").value = settings.feedback_button_yes || "";
                document.getElementById("feedback_button_no").value = settings.feedback_button_no || "";

                initWysiwygEditors();

                if (editors["start_message"]) {
                    const quillHtml = convertTelegramToQuillHtml(settings.start_message || "");
                    editors["start_message"].root.innerHTML = quillHtml;
                    const html = convertQuillToTelegramHtml(editors["start_message"].root.innerHTML);
                    document.getElementById("start_message").value = html;
                }
                if (editors["feedback_response_yes"]) {
                    const quillHtml = convertTelegramToQuillHtml(settings.feedback_response_yes || "");
                    editors["feedback_response_yes"].root.innerHTML = quillHtml;
                    const html = convertQuillToTelegramHtml(editors["feedback_response_yes"].root.innerHTML);
                    document.getElementById("feedback_response_yes").value = html;
                }
                if (editors["feedback_response_no"]) {
                    const quillHtml = convertTelegramToQuillHtml(settings.feedback_response_no || "");
                    editors["feedback_response_no"].root.innerHTML = quillHtml;
                    const html = convertQuillToTelegramHtml(editors["feedback_response_no"].root.innerHTML);
                    document.getElementById("feedback_response_no").value = html;
                }

                updateAllPreviews();

                document.getElementById("loadingIndicator").style.display = "none";
                document.getElementById("settingsForm").style.display = "block";
            } else {
                showNotification("Ошибка загрузки настроек: " + data.message, "error");
            }
        } catch (error) {
            showNotification("Ошибка при загрузке настроек: " + error.message, "error");
        }
    }

    // Обновление предпросмотра
    function updatePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        let text = input.value;

        if (inputId.includes("button")) {
            preview.textContent = text;
            return;
        }

        text = text.replace(/\n/g, "<br>");
        preview.innerHTML = text;
    }

    function updateAllPreviews() {
        updatePreview("start_message", "start_message_preview");
        updatePreview("feedback_button_yes", "feedback_button_yes_preview");
        updatePreview("feedback_button_no", "feedback_button_no_preview");
        updatePreview("feedback_response_yes", "feedback_response_yes_preview");
        updatePreview("feedback_response_no", "feedback_response_no_preview");
    }

    // Обработчики для обычных input полей
    document.addEventListener("DOMContentLoaded", () => {
        const inputs = ["feedback_button_yes", "feedback_button_no"];

        inputs.forEach((inputId) => {
            const element = document.getElementById(inputId);
            element.addEventListener("input", () => {
                updatePreview(inputId, inputId + "_preview");
            });
        });
    });

    // Сохранение настроек
    document.getElementById("settingsForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const settings = {
            start_message: document.getElementById("start_message").value,
            feedback_button_yes: document.getElementById("feedback_button_yes").value,
            feedback_button_no: document.getElementById("feedback_button_no").value,
            feedback_response_yes: document.getElementById("feedback_response_yes").value,
            feedback_response_no: document.getElementById("feedback_response_no").value,
        };

        try {
            showNotification("Сохранение настроек...", "info");

            const response = await fetch("/admin/api/settings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ settings }),
            });

            const data = await response.json();

            if (data.success) {
                showNotification("✅ Настройки успешно сохранены!", "success");
            } else {
                showNotification("❌ Ошибка: " + data.message, "error");
            }
        } catch (error) {
            showNotification("❌ Ошибка при сохранении: " + error.message, "error");
        }
    });

    // Сброс настроек
    async function resetSettings() {
        if (!confirm("Вы уверены, что хотите сбросить все настройки к значениям по умолчанию?")) {
            return;
        }

        try {
            showNotification("Сброс настроек...", "info");

            const response = await fetch("/admin/api/settings/reset", {
                method: "POST",
            });

            const data = await response.json();

            if (data.success) {
                showNotification("✅ Настройки сброшены!", "success");
                setTimeout(() => {
                    loadSettings();
                }, 1000);
            } else {
                showNotification("❌ Ошибка: " + data.message, "error");
            }
        } catch (error) {
            showNotification("❌ Ошибка при сбросе: " + error.message, "error");
        }
    }

    // Уведомления
    function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.className = `fixed top-5 right-5 px-6 py-3 rounded-lg shadow-lg z-[100] text-white font-medium ${
            type === 'success' ? 'bg-green-500' :
            type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => notification.remove(), 3000);
    }

    // Загружаем настройки при загрузке страницы
    loadSettings();
</script>
</body>
</html>
