# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: Clarification –∏ No Answer –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–∑–ª–∏—á–∞–µ—Ç **—Ç—Ä–∏ —Ç–∏–ø–∞ "–Ω–µ–ø–æ–ª–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"** –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:

| Search Level | –ó–Ω–∞—á–µ–Ω–∏–µ | –ò–∫–æ–Ω–∫–∞ | –°—á–∏—Ç–∞–µ—Ç—Å—è Failed Query? |
|--------------|----------|--------|-------------------------|
| **clarification** | RAG –ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å (—Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π –∑–∞–ø—Ä–æ—Å) | ‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ | ‚ùå –ù–µ—Ç |
| **no_answer** | RAG –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π | üö´ –ù–µ –Ω–∞–π–¥–µ–Ω–æ | ‚úÖ –î–∞ |
| **none** | –û—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–æ–æ–±—â–µ (cascading search failed) | ‚ùå None | ‚úÖ –î–∞ |

---

## –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

### –ü—Ä–æ–±–ª–µ–º–∞ —Ä–∞–Ω—å—à–µ:
- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–ª "–∑–∞–∫–∞–∑" –∏–ª–∏ "–ø–∏—Å—å–º–æ" (—Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ), RAG –ø—Ä–æ—Å–∏–ª —É—Ç–æ—á–Ω–∏—Ç—å
- –≠—Ç–∏ –ø—Ä–æ—Å—å–±—ã —É—Ç–æ—á–Ω–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ RAG –æ—Ç–≤–µ—Ç—ã
- –í —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –Ω–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ, —á—Ç–æ —ç—Ç–æ –Ω–µ –Ω–∞—Å—Ç–æ—è—â–∏–π –æ—Ç–≤–µ—Ç
- –°–ª–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤

### –†–µ—à–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å:
- **Clarification** (—É—Ç–æ—á–Ω–µ–Ω–∏–µ) - –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø, –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π
- **No Answer** (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ) - –∫–æ–≥–¥–∞ RAG –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ —Å–º–æ–≥ –ø–æ–º–æ—á—å
- –ß–µ—Ç–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: –≤–∏–¥–Ω–æ —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Å—å–± —É—Ç–æ—á–Ω–∏—Ç—å vs —Ä–µ–∞–ª—å–Ω—ã—Ö "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1Ô∏è‚É£ Clarification (–ü—Ä–æ—Å—å–±–∞ —É—Ç–æ—á–Ω–∏—Ç—å)

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å (1-2 —Å–ª–æ–≤–∞): "–∑–∞–∫–∞–∑", "–ø–∏—Å—å–º–æ", "–¥–æ—Å—Ç–∞–≤–∫–∞"
- RAG –ø–æ–Ω–∏–º–∞–µ—Ç —Ç–µ–º—É, –Ω–æ –∑–∞–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```
–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –∑–∞–∫–∞–∑ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?

–ù–∞–ø—Ä–∏–º–µ—Ä:
- –ó–∞–∫–∞–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∏
- –ó–∞–∫–∞–∑ –ø—Ä–æ–ø—É—Å–∫–∞
- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É
```

**–î–µ—Ç–µ–∫—Ü–∏—è:**
–§—É–Ω–∫—Ü–∏—è `is_rag_clarification()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã:
- "—É—Ç–æ—á–Ω–∏—Ç–µ"
- "—É—Ç–æ—á–Ω–∏—Ç—å"
- "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ"
- "–∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ"
- "—á—Ç–æ –∏–º–µ–Ω–Ω–æ"
- "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ"
- "–Ω–∞–ø—Ä–∏–º–µ—Ä:"
- "–≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç"

**–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
```sql
search_level = 'clarification'
faq_id = NULL
```

**–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ä–∞–Ω–∂–µ–≤—ã–π badge: `‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ`
- –° RAG badge: `üß† Semantic ü§ñ RAG ‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ`
- **–ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è** –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É "Failed Queries"

---

### 2Ô∏è‚É£ No Answer (–ù–µ –Ω–∞–π–¥–µ–Ω–æ)

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- RAG –Ω–µ –Ω–∞—à–µ–ª —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- FAQ chunks –±—ã–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ LLM, –Ω–æ LLM –Ω–µ —Å–º–æ–≥ –¥–∞—Ç—å –æ—Ç–≤–µ—Ç

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```
–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –æ—Ç–¥–µ–ª –ø–æ–¥–¥–µ—Ä–∂–∫–∏.
```

**–î–µ—Ç–µ–∫—Ü–∏—è:**
–§—É–Ω–∫—Ü–∏—è `is_rag_no_answer()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. `metadata.error` - –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏
2. –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã:
   - "–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é"
   - "–Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
   - "–Ω–µ –Ω–∞—à—ë–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
   - "–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
   - "–Ω–µ –∑–Ω–∞—é"
   - "–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å"
   - "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç"
   - "–≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç"
   - "–∏–∑–≤–∏–Ω–∏—Ç–µ"
   - "—è –Ω–µ –∑–Ω–∞—é"

**–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
```sql
search_level = 'no_answer'
faq_id = NULL
```

**–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–π badge: `üö´ –ù–µ –Ω–∞–π–¥–µ–Ω–æ`
- –° RAG badge: `üß† Semantic ü§ñ RAG üö´ –ù–µ –Ω–∞–π–¥–µ–Ω–æ`
- **–í–ö–õ–Æ–ß–ê–ï–¢–°–Ø** –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É "Failed Queries"

---

### 3Ô∏è‚É£ None (Fallback)

**–ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- Cascading search –Ω–µ –Ω–∞—à–µ–ª –Ω–∏—á–µ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ
- RAG –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```
üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –Ω–∞—à–µ–ª —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å.

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:
‚Ä¢ –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
```

**–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
```sql
search_level = 'none'
faq_id = NULL
```

**–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–π badge: `‚ùå None`
- **–í–ö–õ–Æ–ß–ê–ï–¢–°–Ø** –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É "Failed Queries"

---

## –ü—Ä–æ—Å–º–æ—Ç—Ä –≤ Admin Panel

### –ö–æ–ª–æ–Ω–∫–∞ "–£—Ä–æ–≤–µ–Ω—å –ø–æ–∏—Å–∫–∞"

–ù–æ–≤—ã–µ badges:

| Badge | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| `‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ` | RAG –ø—Ä–æ—Å–∏—Ç —É—Ç–æ—á–Ω–∏—Ç—å –≤–æ–ø—Ä–æ—Å (–æ—Ä–∞–Ω–∂–µ–≤—ã–π) |
| `üö´ –ù–µ –Ω–∞–π–¥–µ–Ω–æ` | RAG –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–∫—Ä–∞—Å–Ω—ã–π) |
| `‚ùå None` | –û—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–æ–æ–±—â–µ (–∫—Ä–∞—Å–Ω—ã–π) |

### –§–∏–ª—å—Ç—Ä "Failed Queries"

–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã":

**–í–∫–ª—é—á–∞—é—Ç—Å—è:**
- ‚úÖ `no_answer` - RAG –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- ‚úÖ `none` - –æ—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–æ–æ–±—â–µ
- ‚úÖ Low similarity (< 45%)

**–ò—Å–∫–ª—é—á–∞—é—Ç—Å—è:**
- ‚ùå `clarification` - –ø—Ä–æ—Å—å–±–∞ —É—Ç–æ—á–Ω–∏—Ç—å (–Ω–µ –æ—à–∏–±–∫–∞)
- ‚ùå `disambiguation_shown` - –ø–æ–∫–∞–∑–∞–Ω—ã –≤–∞—Ä–∏–∞–Ω—Ç—ã
- ‚ùå `disambiguation` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –≤–∞—Ä–∏–∞–Ω—Ç

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –°–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π –≤–æ–ø—Ä–æ—Å

**–ó–∞–ø—Ä–æ—Å:** "–ø–∏—Å—å–º–æ"

**Cascading Search:**
- üß† Semantic: –ù–∞—Ö–æ–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ FAQ –ø—Ä–æ –ø–∏—Å—å–º–∞ (confidence ~60%)

**RAG:**
- –ü–æ–ª—É—á–∞–µ—Ç chunks –ø—Ä–æ "–ø–∏—Å—å–º–æ –ø–æ—á—Ç–æ–π –†–æ—Å—Å–∏–∏" –∏ "–ø–∏—Å—å–º–æ –ø–æ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç–µ"
- –ü–æ–Ω–∏–º–∞–µ—Ç —á—Ç–æ –≤–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–∏–π
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç: "–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç? –ù–∞–ø—Ä–∏–º–µ—Ä: –ø–∏—Å—å–º–æ –ø–æ—á—Ç–æ–π –†–æ—Å—Å–∏–∏ –∏–ª–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞?"

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- `search_level = 'clarification'`
- `faq_id = NULL`
- LLM metadata —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (tokens, chunks, generation time)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Badge –≤ UI: `‚ùì –£—Ç–æ—á–Ω–µ–Ω–∏–µ ü§ñ RAG`
- –ù–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è failed query
- –í–∏–¥–Ω–æ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ RAG –∫–∞–∫ clarification request

---

### –ü—Ä–∏–º–µ—Ä 2: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç

**–ó–∞–ø—Ä–æ—Å:** "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≤–∏–∑—É –≤ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥—É?"

**Cascading Search:**
- üß† Semantic: –ù–∞—Ö–æ–¥–∏—Ç FAQ –ø—Ä–æ –≤–∏–∑—ã (confidence ~50%)

**RAG:**
- –ü–æ–ª—É—á–∞–µ—Ç chunks –ø—Ä–æ –≤–∏–∑—ã –≤ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã
- –ü–æ–Ω–∏–º–∞–µ—Ç —á—Ç–æ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–æ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥—É
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç: "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∏–∑–µ –≤ –ê–Ω—Ç–∞—Ä–∫—Ç–∏–¥—É. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –æ—Ç–¥–µ–ª HR."

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- `search_level = 'no_answer'`
- `faq_id = NULL`
- LLM metadata —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Badge –≤ UI: `üö´ –ù–µ –Ω–∞–π–¥–µ–Ω–æ ü§ñ RAG`
- –°—á–∏—Ç–∞–µ—Ç—Å—è failed query
- –í–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –æ—Ç—á–µ—Ç "–ó–∞–ø—Ä–æ—Å—ã –±–µ–∑ –æ—Ç–≤–µ—Ç–∞"

---

## SQL –ó–∞–ø—Ä–æ—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—å–± —É—Ç–æ—á–Ω–∏—Ç—å
```sql
SELECT COUNT(*) as clarification_count
FROM answer_logs
WHERE search_level = 'clarification'
  AND period_id IS NULL;
```

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ" –æ—Ç RAG
```sql
SELECT COUNT(*) as rag_no_answer_count
FROM answer_logs al
LEFT JOIN llm_generations lg ON al.id = lg.answer_log_id
WHERE al.search_level = 'no_answer'
  AND lg.id IS NOT NULL  -- –¢–æ–ª—å–∫–æ RAG –æ—Ç–≤–µ—Ç—ã
  AND al.period_id IS NULL;
```

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ "–Ω–µ–ø–æ–ª–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"
```sql
SELECT
    search_level,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM answer_logs WHERE period_id IS NULL), 1) as percentage
FROM answer_logs
WHERE search_level IN ('clarification', 'no_answer', 'none')
  AND period_id IS NULL
GROUP BY search_level
ORDER BY count DESC;
```

### –¢–æ–ø-10 –∑–∞–ø—Ä–æ—Å–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è
```sql
SELECT
    ql.query_text,
    COUNT(*) as count
FROM query_logs ql
LEFT JOIN answer_logs al ON ql.id = al.query_log_id
WHERE al.search_level = 'clarification'
  AND ql.period_id IS NULL
GROUP BY ql.query_text
ORDER BY count DESC
LIMIT 10;
```

---

## Best Practices

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:

1. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ clarification –∑–∞–ø—Ä–æ—Å—ã**:
   - –ß–∞—Å—Ç—ã–µ –ø—Ä–æ—Å—å–±—ã —É—Ç–æ—á–Ω–∏—Ç—å ‚Üí –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ FAQ
   - –ü—Ä–∏–º–µ—Ä: –ï—Å–ª–∏ —á–∞—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–∑–∞–∫–∞–∑", —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ FAQ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–æ–≤

2. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ no_answer**:
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
   - –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–æ–≤—ã–µ FAQ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É**:
   - –í—ã—Å–æ–∫–∏–π % clarification ‚Üí –≤–æ–ø—Ä–æ—Å—ã —Å–ª–∏—à–∫–æ–º –æ–±—â–∏–µ, –Ω—É–∂–Ω—ã –ø—Ä–∏–º–µ—Ä—ã –≤ FAQ
   - –í—ã—Å–æ–∫–∏–π % no_answer ‚Üí –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ–ø–æ–ª–Ω–∞—è

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:

1. **–î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** –≤ `is_rag_clarification()`:
   ```python
   clarification_patterns = [
       '—É—Ç–æ—á–Ω–∏—Ç–µ',
       '–∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ',
       # –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   ]
   ```

2. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ no_answer –ø–∞—Ç—Ç–µ—Ä–Ω—ã** –≤ `is_rag_no_answer()`:
   ```python
   no_answer_patterns = [
       '–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é',
       '–Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏',
       # –î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
   ]
   ```

3. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –¥–µ—Ç–µ–∫—Ü–∏—é**:
   ```python
   # –¢–µ—Å—Ç clarification
   assert is_rag_clarification("–£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞–∫–æ–π –∑–∞–∫–∞–∑?") == True

   # –¢–µ—Å—Ç no_answer
   assert is_rag_no_answer("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏", {}) == True
   ```

---

## Troubleshooting

### ‚ùå Clarification –Ω–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**:
1. RAG –≤–∫–ª—é—á–µ–Ω: `RAG_ENABLED=True` –≤ `.env`
2. –§—É–Ω–∫—Ü–∏—è `is_rag_clarification()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ `is_rag_no_answer()`
3. –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∞—à–∏–º RAG –æ—Ç–≤–µ—Ç–∞–º

**–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ `clarification_patterns`

### ‚ùå No Answer —Å—á–∏—Ç–∞–µ—Ç—Å—è Clarification

**–ü—Ä–∏—á–∏–Ω–∞**: –ü–∞—Ç—Ç–µ—Ä–Ω—ã –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ**: `is_rag_clarification()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ)

### ‚ùå Failed Queries –≤–∫–ª—é—á–∞—é—Ç Clarification

**–ü—Ä–∏—á–∏–Ω–∞**: SQL —Ñ–∏–ª—å—Ç—Ä –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ `'clarification'` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `NOT IN` —Ñ–∏–ª—å—Ç—Ä—ã:
```sql
AND al.search_level NOT IN ('disambiguation_shown', 'disambiguation', 'clarification')
```

---

## –°—Å—ã–ª–∫–∏

- **–ö–æ–¥ –±–æ—Ç–∞**: `src/bots/bot.py` (lines 426-488)
- **–ö–æ–¥ B24 –±–æ—Ç–∞**: `src/bots/b24_bot.py` (lines 432-494)
- **RAG —Å–µ—Ä–≤–∏—Å**: `src/core/llm_service.py`
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: `src/core/database.py` (lines 725, 844, 1519, 1660)
- **Frontend**: `src/web/templates/admin/logs.html` (lines 566-568, 614-622)
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `CLAUDE.md` (lines 215-246)

---

**–í–µ—Ä—Å–∏—è**: 1.0
**–î–∞—Ç–∞**: 2025-12-19
**–°—Ç–∞—Ç—É—Å**: ‚úÖ Production Ready
