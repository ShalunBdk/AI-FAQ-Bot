# RAG (Retrieval-Augmented Generation) - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ FAQ Bot –±—ã–ª–∞ –¥–æ—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è **Secure RAG** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å Privacy First –ø–æ–¥—Ö–æ–¥–æ–º. –¢–µ–ø–µ—Ä—å –±–æ—Ç –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –∏–∑ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã, –∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —á–µ—Ä–µ–∑ LLM, –ø—Ä–∏ —ç—Ç–æ–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### üîí Privacy First

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–±–ª–∞—á–Ω—ã–µ LLM (GPT-4, Claude, Gemini) –º–æ–≥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

**–†–µ—à–µ–Ω–∏–µ**: –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
1. **–ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è** ‚Üí –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM –≤—Å–µ PII –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
2. **–î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è** ‚Üí –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∑–∞–º–µ–Ω—è—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–¢–∏–ø—ã –∑–∞—â–∏—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö:**
- üìß Email –∞–¥—Ä–µ—Å–∞ ‚Üí `[EMAIL_1]`, `[EMAIL_2]`, ...
- üì± –¢–µ–ª–µ—Ñ–æ–Ω—ã ‚Üí `[PHONE_1]`, `[PHONE_2]`, ...
- üë§ –ò–º–µ–Ω–∞ –ª—é–¥–µ–π ‚Üí `[PER_1]`, `[PER_2]`, ...
- üè¢ –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ ‚Üí `[ORG_1]`, `[ORG_2]`, ...
- üìç –õ–æ–∫–∞—Ü–∏–∏ ‚Üí `[LOC_1]`, `[LOC_2]`, ...

### ü§ñ –£–º–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ—Å—Ç—ã–º –ø–æ–∏—Å–∫–æ–º:**
- ‚úÖ –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- ‚úÖ –°—Ç—Ä–æ–∏—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã (–µ—Å–ª–∏ "–ü–µ—á–∞—Ç—å —É –ú–∞—Ä–∏–∏" + "–ú–∞—Ä–∏—è –≤ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏" ‚Üí "–ü–µ—á–∞—Ç—å –≤ –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏")
- ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤

### üîÑ Cascading Search + RAG

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **4-—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–æ–∏—Å–∫** –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –∑–∞—Ç–µ–º –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç:

```
1. Exact Match (100%) ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
2. Keyword Search (70-95%) ‚Üí –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
3. Semantic Search (45-70%) ‚Üí —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ ChromaDB
4. Fallback (0%) ‚Üí –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–∫–∞–∑
                ‚Üì
            RAG –ì–ï–ù–ï–†–ê–¶–ò–Ø (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ)
                ‚Üì
    –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è ‚Üí LLM ‚Üí –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

–ù–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `requirements.txt`:

```bash
pip install natasha openai
```

–ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
pip install -r requirements.txt
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ OpenRouter API –∫–ª—é—á–∞

OpenRouter –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –µ–¥–∏–Ω—ã–π API –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–Ω–æ–∂–µ—Å—Ç–≤—É LLM –º–æ–¥–µ–ª–µ–π.

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [https://openrouter.ai/](https://openrouter.ai/)
2. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å (–º–∏–Ω–∏–º—É–º $5, —ç—Ç–æ–≥–æ —Ö–≤–∞—Ç–∏—Ç –Ω–∞ ~500,000 –∑–∞–ø—Ä–æ—Å–æ–≤ —Å gpt-4o-mini)
3. –°–æ–∑–¥–∞–π—Ç–µ API –∫–ª—é—á –≤ —Ä–∞–∑–¥–µ–ª–µ [Keys](https://openrouter.ai/keys)
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env

–û—Ç–∫—Ä–æ–π—Ç–µ `.env` —Ñ–∞–π–ª –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```env
# ===============================================
# RAG API (LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤)
# ===============================================

# –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ LLM (true/false)
RAG_ENABLED=true

# OpenRouter API –∫–ª—é—á (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxxxxxxxxxxxxxx

# –ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏:
#   - openai/gpt-4o-mini (–±—ã—Å—Ç—Ä–∞—è –∏ –¥–µ—à–µ–≤–∞—è, $0.15/$0.60 –∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤)
#   - openai/gpt-4o (–±–æ–ª–µ–µ –º–æ—â–Ω–∞—è, $2.50/$10.00 –∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤)
#   - anthropic/claude-3.5-sonnet (–æ—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ, $3.00/$15.00)
#   - google/gemini-2.0-flash-001 (–ë–ï–°–ü–õ–ê–¢–ù–ê–Ø, —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
OPENROUTER_MODEL=openai/gpt-4o-mini

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ LLM
RAG_MAX_TOKENS=1024

# –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.0 - –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, 1.0 - –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–π)
# –î–ª—è FAQ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 0.3 (—Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ "—Ñ–∞–Ω—Ç–∞–∑–∏–π")
RAG_TEMPERATURE=0.3

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ RAG
# –î–æ–∫—É–º–µ–Ω—Ç—ã —Å similarity –Ω–∏–∂–µ —ç—Ç–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã
RAG_MIN_RELEVANCE_SCORE=45.0

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ RAG
RAG_MAX_CHUNKS=5
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏:**

| –ú–æ–¥–µ–ª—å | –¶–µ–Ω–∞ (–∑–∞ 1M —Ç–æ–∫–µ–Ω–æ–≤) | –ö–∞—á–µ—Å—Ç–≤–æ | –°–∫–æ—Ä–æ—Å—Ç—å | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|---------------------|----------|----------|--------------|
| `google/gemini-2.0-flash-001` | **–ë–ï–°–ü–õ–ê–¢–ù–û** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚ö°‚ö°‚ö° | –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è |
| `openai/gpt-4o-mini` | $0.15/$0.60 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚ö°‚ö°‚ö° | **–ü—Ä–æ–¥–∞–∫—à–Ω** |
| `openai/gpt-4o` | $2.50/$10.00 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚ö°‚ö° | –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ |
| `anthropic/claude-3.5-sonnet` | $3.00/$15.00 | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | ‚ö°‚ö° | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ GPT |

–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π: [https://openrouter.ai/models](https://openrouter.ai/models)

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞

–°–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã RAG –ø–∞–π–ø–ª–∞–π–Ω–∞:

```bash
python scripts/test_rag_pipeline.py
```

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∫—Ä–∏–ø—Ç:**
1. ‚úÖ –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Email, —Ç–µ–ª–µ—Ñ–æ–Ω—ã, –∏–º–µ–Ω–∞, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –ª–æ–∫–∞—Ü–∏–∏)
2. ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM
3. ‚úÖ –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
4. ‚úÖ –ü–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                 –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï RAG –ü–ê–ô–ü–õ–ê–ô–ù–ê (Privacy First)                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

================================================================================
                   –¢–ï–°–¢ 1: –ê–ù–û–ù–ò–ú–ò–ó–ê–¶–ò–Ø –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–•
================================================================================

--- –¢–µ—Å—Ç 1: Email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω ---

–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç:
  –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ò–≤–∞–Ω–æ–º –ü–µ—Ç—Ä–æ–≤—ã–º –ø–æ email ivan.petrov@example.com –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (999) 123-45-67.

–ê–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:
  –°–≤—è–∂–∏—Ç–µ—Å—å —Å [PER_1] –ø–æ email [EMAIL_1] –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É [PHONE_1].

–ù–∞–π–¥–µ–Ω–Ω—ã–µ PII:
  [EMAIL_1] ‚Üí ivan.petrov@example.com (EMAIL)
  [PHONE_1] ‚Üí +7 (999) 123-45-67 (PHONE)
  [PER_1] ‚Üí –ò–≤–∞–Ω–æ–º –ü–µ—Ç—Ä–æ–≤—ã–º (PER)

–î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:
  –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ò–≤–∞–Ω–æ–º –ü–µ—Ç—Ä–æ–≤—ã–º –ø–æ email ivan.petrov@example.com –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (999) 123-45-67.

‚úì –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ (—Ç–µ–∫—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é)
‚úì –ù–∞–π–¥–µ–Ω—ã –≤—Å–µ –æ–∂–∏–¥–∞–µ–º—ã–µ —Ç–∏–ø—ã PII: EMAIL, PHONE, PER
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å–∫ –±–æ—Ç–æ–≤

RAG –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –æ–±–∞ –±–æ—Ç–∞:

**Telegram –±–æ—Ç:**
```bash
python -m src.bots.bot
```

**Bitrix24 –±–æ—Ç:**
```bash
python -m src.bots.b24_bot
```

### 2. –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏–º–µ—Ä –¥–∏–∞–ª–æ–≥–∞:**

```
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–µ–π?

ü§ñ –ë–æ—Ç (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ–±—Ä–∞–±–æ—Ç–∫–∞):
  1. –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫ ‚Üí –Ω–∞—Ö–æ–¥–∏—Ç FAQ "–ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏"
  2. –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
     "–ì–ª–∞–≤–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä: –ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞. –¢–µ–ª–µ—Ñ–æ–Ω: +7 (495) 123-45-67"
     ‚Üí "–ì–ª–∞–≤–Ω—ã–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä: [PER_1]. –¢–µ–ª–µ—Ñ–æ–Ω: [PHONE_1]"
  3. LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—Å –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º)
  4. –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
  5. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

ü§ñ –ë–æ—Ç ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
  "–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≥–ª–∞–≤–Ω—ã–º –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º –ú–∞—Ä–∏–µ–π –ü–µ—Ç—Ä–æ–≤–æ–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (495) 123-45-67
   –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ –Ω–∞ maria.petrova@company.ru. –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å 9:00 –¥–æ 18:00."
```

### 3. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ RAG

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø—Ä–æ—Å—Ç–æ–º—É –ø–æ–∏—Å–∫—É (–±–µ–∑ LLM):

```env
RAG_ENABLED=false
```

–ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ - –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ FAQ –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. PiiAnonymizer (`src/core/pii_anonymizer.py`)

**–ö–ª–∞—Å—Å –¥–ª—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏/–¥–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö.**

**–ú–µ—Ç–æ–¥—ã:**
- `anonymize(text)` ‚Üí `(anonymized_text, mapping)`
- `deanonymize(text, mapping)` ‚Üí `original_text`

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
- **Regex** –¥–ª—è Email –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (–±—ã—Å—Ç—Ä–æ, —Ç–æ—á–Ω–æ)
- **natasha** (NER) –¥–ª—è –∏–º–µ–Ω, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, –ª–æ–∫–∞—Ü–∏–π (ML-–º–æ–¥–µ–ª—å –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞)

**–ü—Ä–∏–º–µ—Ä:**
```python
from src.core.pii_anonymizer import PiiAnonymizer

anonymizer = PiiAnonymizer()

text = "–ó–≤–æ–Ω–∏—Ç–µ –ò–≤–∞–Ω—É: +7 999 123-45-67"
anonymized, mapping = anonymizer.anonymize(text)
# anonymized: "–ó–≤–æ–Ω–∏—Ç–µ [PER_1]: [PHONE_1]"
# mapping: {"[PER_1]": "–ò–≤–∞–Ω—É", "[PHONE_1]": "+7 999 123-45-67"}

original = anonymizer.deanonymize(anonymized, mapping)
# original: "–ó–≤–æ–Ω–∏—Ç–µ –ò–≤–∞–Ω—É: +7 999 123-45-67"
```

#### 2. LLMService (`src/core/llm_service.py`)

**–°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ OpenRouter API.**

**–ú–µ—Ç–æ–¥—ã:**
- `generate_answer(user_question, db_chunks, max_tokens, temperature)` ‚Üí `(answer, metadata)`

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ chunks
2. –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ–ø—Ä–æ—Å–∞
3. –ó–∞–ø—Ä–æ—Å –∫ LLM (OpenRouter API)
4. –î–µ–∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞

**System Prompt:**
```
–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç FAQ –±–æ—Ç–∞ –∫–æ–º–ø–∞–Ω–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,
–∏—Å–ø–æ–ª—å–∑—É—è —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–π —ç—Ç–æ.
2. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
3. –°–æ—Ö—Ä–∞–Ω—è–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã ([PER_1], [LOC_1], etc.) –∫–∞–∫ –µ—Å—Ç—å.
4. –°—Ç—Ä–æ–π –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
5. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º –∏ —Ç–æ—á–Ω—ã–º.
```

**–ü—Ä–∏–º–µ—Ä:**
```python
from src.core.llm_service import LLMService

service = LLMService()

chunks = [
    {
        'question': '–ö–æ–Ω—Ç–∞–∫—Ç—ã –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏',
        'answer': '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è: –ú–∞—Ä–∏—è –ò–≤–∞–Ω–æ–≤–∞, —Ç–µ–ª. +7 495 123-45-67',
        'confidence': 92.3
    }
]

answer, metadata = service.generate_answer(
    user_question="–ö–∞–∫ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–µ–π?",
    db_chunks=chunks
)

print(answer)
# "–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≥–ª–∞–≤–Ω—ã–º –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º –ú–∞—Ä–∏–µ–π –ò–≤–∞–Ω–æ–≤–æ–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 495 123-45-67"

print(metadata)
# {'model': 'openai/gpt-4o-mini', 'chunks_used': 1, 'pii_found': 2, 'tokens_used': {...}}
```

#### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç—ã

**Telegram –±–æ—Ç** (`src/bots/bot.py:527-596`):
- –ü–æ—Å–ª–µ –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- –ü–µ—Ä–µ–¥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ

**Bitrix24 –±–æ—Ç** (`src/bots/b24_bot.py:481-559`):
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ BB-–∫–æ–¥–æ–≤ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:

```sql
-- answer_logs —Ç–∞–±–ª–∏—Ü–∞
answer_shown TEXT  -- –°–æ–¥–µ—Ä–∂–∏—Ç –§–ò–ù–ê–õ–¨–ù–´–ô –æ—Ç–≤–µ—Ç (RAG –∏–ª–∏ –æ–±—ã—á–Ω—ã–π)
```

**–í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (RAG —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
- ‚úÖ Search level –æ—Å—Ç–∞–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º (exact, keyword, semantic)
- ‚úÖ Confidence score –æ—Ç –ø–æ–∏—Å–∫–∞ (–Ω–µ –æ—Ç LLM)

**–í –∫–æ–Ω—Å–æ–ª–∏ (–ª–æ–≥–∏):**
```
üîç –ö–∞—Å–∫–∞–¥–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: '–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É?'
‚úÖ –û—Ç–≤–µ—Ç –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ keyword (confidence: 87.3%)
ü§ñ –ó–∞–ø—É—Å–∫ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...
  –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ 1 chunks –¥–ª—è RAG
‚úÖ RAG –æ—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω–æ–≤: 245
```

---

## –°—Ç–æ–∏–º–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏

–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –º–æ–¥–µ–ª–∏ `openai/gpt-4o-mini`:

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –¶–µ–Ω–∞ –∑–∞ 1M input —Ç–æ–∫–µ–Ω–æ–≤ | $0.15 |
| –¶–µ–Ω–∞ –∑–∞ 1M output —Ç–æ–∫–µ–Ω–æ–≤ | $0.60 |
| –°—Ä–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å (input) | ~500 —Ç–æ–∫–µ–Ω–æ–≤ |
| –°—Ä–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç (output) | ~200 —Ç–æ–∫–µ–Ω–æ–≤ |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å 1 –∑–∞–ø—Ä–æ—Å–∞** | **~$0.00019** |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å 1000 –∑–∞–ø—Ä–æ—Å–æ–≤** | **~$0.19** |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤** | **~$1.90** |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
   ```env
   OPENROUTER_MODEL=google/gemini-2.0-flash-001
   ```

2. **–£–º–µ–Ω—å—à–∏—Ç–µ max_tokens:**
   ```env
   RAG_MAX_TOKENS=512  # –≤–º–µ—Å—Ç–æ 1024
   ```

3. **–£–≤–µ–ª–∏—á—å—Ç–µ –ø–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏** (–º–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM):
   ```env
   RAG_MIN_RELEVANCE_SCORE=60.0  # –≤–º–µ—Å—Ç–æ 45.0
   ```

4. **–û—Ç–∫–ª—é—á–∏—Ç–µ RAG –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
   - Exact match ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ RAG (100% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏)
   - Keyword match —Å –≤—ã—Å–æ–∫–∏–º confidence ‚Üí –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å RAG

---

## FAQ

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ OpenRouter?

**–î–∞, –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏–∏.**

- ‚úÖ –í—Å–µ PII –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
- ‚úÖ LLM –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: `[PER_1]`, `[EMAIL_1]`, etc.
- ‚úÖ –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
- ‚úÖ OpenRouter [–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ](https://openrouter.ai/privacy) (–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å zero data retention)

### –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ LLM "–≥–∞–ª–ª—é—Ü–∏–Ω–∏—Ä—É–µ—Ç"?

**–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π system prompt:**

1. –£–º–µ–Ω—å—à–∏—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É:
   ```env
   RAG_TEMPERATURE=0.1  # –±–æ–ª–µ–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
   ```

2. –ò–∑–º–µ–Ω–∏—Ç–µ system prompt –≤ `src/core/llm_service.py` (—Å—Ç—Ä–æ–∫–∞ 61-82)

### –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—É—é LLM?

**–î–∞, –Ω–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞.**

OpenAI SDK (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–æ–¥–µ) —Å–æ–≤–º–µ—Å—Ç–∏–º —Å:
- Ollama (–ª–æ–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏)
- LocalAI
- LM Studio

–ò–∑–º–µ–Ω–∏—Ç–µ `base_url` –≤ `LLMService.__init__()`:
```python
self.client = OpenAI(
    api_key="not-needed",
    base_url="http://localhost:11434/v1"  # Ollama
)
```

### –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—é –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤?

–ò–∑–º–µ–Ω–∏—Ç–µ `PiiAnonymizer._anonymize_ner()` –≤ `src/core/pii_anonymizer.py`:

```python
# –û—Ç–∫–ª—é—á–∏—Ç—å –∞–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—é –ª–æ–∫–∞—Ü–∏–π
type_mapping = {
    'PER': 'PER',
    # 'LOC': 'LOC',  # –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
    'ORG': 'ORG'
}
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "OPENROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"

**–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–ª—é—á –≤ `.env`:
```env
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxx
```

### –û—à–∏–±–∫–∞: "natasha –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"

**–†–µ—à–µ–Ω–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install natasha
```

### LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ OpenRouter
2. –ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á
3. –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å.

### –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `gpt-4o-mini` –∏–ª–∏ `gemini-2.0-flash-001` (–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)
2. –£–º–µ–Ω—å—à–∏—Ç–µ `RAG_MAX_TOKENS`
3. –£–≤–µ–ª–∏—á—å—Ç–µ `RAG_MIN_RELEVANCE_SCORE`

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Secure RAG –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏ —ç—Ç–æ–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –æ–±–∞ –±–æ—Ç–∞ (Telegram –∏ Bitrix24) –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üîí Privacy First - –∑–∞—â–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ü§ñ –£–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã - LLM –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–∏—Å–∫–∞
- üìä –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã - –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö FAQ
- ‚ö° –ë—ã—Å—Ç—Ä—ã–π fallback - –ø—Ä–∏ –æ—à–∏–±–∫–µ LLM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç
- üí∞ –ì–∏–±–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å - –æ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –¥–æ –ø—Ä–µ–º–∏—É–º –º–æ–¥–µ–ª–µ–π

**–î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Fine-tuning –º–æ–¥–µ–ª–∏ –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–µ –∫–æ–º–ø–∞–Ω–∏–∏
- –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

---

## RAG Logging and Analytics

**–í—Å–µ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è** —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

### –ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:

- **Model**: –ú–æ–¥–µ–ª—å LLM (–Ω–∞–ø—Ä–∏–º–µ—Ä, `openai/gpt-4o-mini`)
- **Token usage**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (prompt, completion, total)
- **FAQ chunks**: –°–ø–∏—Å–æ–∫ FAQ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ confidence scores
- **PII detected**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏ –∞–Ω–æ–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö PII —Å—É—â–Ω–æ—Å—Ç–µ–π
- **Generation latency**: –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
- **Error messages**: –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏)

### –ü—Ä–æ—Å–º–æ—Ç—Ä RAG –¥–∞–Ω–Ω—ã—Ö –≤ Admin Panel:

1. **ü§ñ RAG Badge**: –ò—â–∏—Ç–µ badge "RAG" —Ä—è–¥–æ–º —Å –∏–∫–æ–Ω–∫–∞–º–∏ —É—Ä–æ–≤–Ω—è –ø–æ–∏—Å–∫–∞ (üéØ/üîë/üß†)
2. **‚ÑπÔ∏è Info Icon**: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É "info" —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å expandable —Å–µ–∫—Ü–∏—é —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
3. **üìä RAG Statistics Card**: –î–∞—à–±–æ—Ä–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
   - –í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤ —Å RAG
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤
   - Success rate (%)
   - –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
4. **‚ùå Failed Queries Filter**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç RAG errors –≥–¥–µ LLM –≤–µ—Ä–Ω—É–ª "no answer"

### Database Schema:

–¢–∞–±–ª–∏—Ü–∞ `llm_generations` —Ö—Ä–∞–Ω–∏—Ç:
```sql
CREATE TABLE llm_generations (
    id INTEGER PRIMARY KEY,
    answer_log_id INTEGER,  -- FK to answer_logs
    model TEXT,
    chunks_used INTEGER,
    chunks_data TEXT,  -- JSON: [{"faq_id": "...", "question": "...", "confidence": 85.5}, ...]
    pii_detected INTEGER,
    tokens_prompt INTEGER,
    tokens_completion INTEGER,
    tokens_total INTEGER,
    finish_reason TEXT,
    generation_time_ms INTEGER,
    error_message TEXT,
    created_at TIMESTAMP,
    FOREIGN KEY (answer_log_id) REFERENCES answer_logs(id)
)
```

### –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
from src.core import database

# –ü–æ—Å–ª–µ RAG –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
database.add_llm_generation_log(
    answer_log_id=answer_log_id,
    model=rag_metadata.get('model', 'unknown'),
    chunks_used=rag_metadata.get('chunks_used', 0),
    chunks_data=rag_metadata.get('chunks_data', []),
    pii_detected=rag_metadata.get('pii_found', 0),
    tokens_prompt=rag_metadata.get('tokens_used', {}).get('prompt', 0),
    tokens_completion=rag_metadata.get('tokens_used', {}).get('completion', 0),
    tokens_total=rag_metadata.get('tokens_used', {}).get('total', 0),
    finish_reason=rag_metadata.get('finish_reason', 'unknown'),
    generation_time_ms=rag_metadata.get('generation_time_ms', 0),
    error_message=rag_metadata.get('error')
)
```

### "No Answer" Detection:

RAG –º–æ–∂–µ—Ç –Ω–µ –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ –ø–æ:

1. **metadata.error** - –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
2. **–ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã** –≤ –æ—Ç–≤–µ—Ç–µ:
   - "–∫ —Å–æ–∂–∞–ª–µ–Ω–∏—é"
   - "–Ω–µ –Ω–∞—à–µ–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏" / "–Ω–µ –Ω–∞—à—ë–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
   - "–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
   - "–Ω–µ –∑–Ω–∞—é"
   - "–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å"
   - "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç"
   - "–≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç"

–§—É–Ω–∫—Ü–∏—è `is_rag_no_answer()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç —Ç–∞–∫–∏–µ —Å–ª—É—á–∞–∏ –∫–∞–∫ `search_level='none'`.

---

**–ê–≤—Ç–æ—Ä:** AI Assistant
**–î–∞—Ç–∞:** 2025-12-19
**–í–µ—Ä—Å–∏—è:** 1.1 (—Å RAG Logging)
