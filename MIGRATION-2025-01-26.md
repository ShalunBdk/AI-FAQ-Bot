# Migration Guide - 2025-01-26

## –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —ç—Ç–æ–º —Ä–µ–ª–∏–∑–µ

### 1. üéØ –£–ª—É—á—à–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º Keyword Search
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—Ä–æ—Å "–∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∫–∞—Ä—Ç—Ä–∏–¥–∂" –Ω–µ –Ω–∞—Ö–æ–¥–∏–ª FAQ, —Ö–æ—Ç—è –æ–±–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –±–∞–∑–µ.

**–†–µ—à–µ–Ω–∏–µ:**
- –ò–∑–º–µ–Ω–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á—ë—Ç–∞ confidence (—É–±—Ä–∞–Ω —à—Ç—Ä–∞—Ñ –∑–∞ FAQ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤)
- –ü–æ–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ `keyword_match_threshold` —Å 70% –¥–æ 65%

**–§–∞–π–ª—ã:**
- `src/core/search.py` (—Ñ—É–Ω–∫—Ü–∏—è `calculate_keyword_confidence`)
- `src/core/database.py` (DEFAULT_BOT_SETTINGS)

### 2. üöÄ CPU-only –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Docker —Å–±–æ—Ä–∫–∏
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–±–æ—Ä–∫–µ Docker –æ–±—Ä–∞–∑–∞ —Å–∫–∞—á–∏–≤–∞–ª–∏—Å—å NVIDIA CUDA –ø–∞–∫–µ—Ç—ã (~1.5 –ì–ë), —Ö–æ—Ç—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ CPU.

**–†–µ—à–µ–Ω–∏–µ:**
- Dockerfile —Ç–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç PyTorch CPU-only –≤–µ—Ä—Å–∏—é
- –≠–∫–æ–Ω–æ–º–∏—è ~1.5 –ì–ë –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
- –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏ –Ω–∞ 5-10 –º–∏–Ω—É—Ç
- –£–≤–µ–ª–∏—á–µ–Ω—ã npm timeouts –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–π —Å–±–æ—Ä–∫–∏

**–§–∞–π–ª—ã:**
- `docker/Dockerfile` (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ torch —Å CPU –∏–Ω–¥–µ–∫—Å–æ–º, npm timeouts)
- `requirements.txt` (—É–±—Ä–∞–Ω–∞ —è–≤–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å torch)
- `requirements-cpu.txt` (–Ω–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

### 3. üîÄ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ BASE_PATH –¥–ª—è reverse proxy
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–Ω–æ–ø–∫–∏ –ø–æ—Ö–æ–∂–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ reverse proxy —Å BASE_PATH.

**–†–µ—à–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ BASE_PATH –∫ BITRIX24_HANDLER_URL –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥
- Bitrix24 —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL

**–§–∞–π–ª—ã:**
- `src/bots/b24_bot.py` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ BASE_PATH)
- `.env.example` (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è BASE_PATH)
- `REVERSE-PROXY-SETUP.md` (–Ω–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

---

## –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–µ—Ä–≤–µ—Ä–µ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

```bash
# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/FAQBot

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å)
docker compose exec web-admin python -c "import shutil; shutil.copy('data/bot.db', 'data/bot.db.backup')"

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin main
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ BASE_PATH (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è reverse proxy)

**–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –≤–∞—Å reverse proxy —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –ø—É—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, /faqbot):**

```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env
nano .env

# –î–æ–±–∞–≤—å—Ç–µ BASE_PATH (–Ω–∞–ø—Ä–∏–º–µ—Ä):
# BASE_PATH=/faqbot
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:**
- –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º –ø—É—Ç–∏ - –æ—Å—Ç–∞–≤—å—Ç–µ `BASE_PATH=` –ø—É—Å—Ç—ã–º
- –°–º. [REVERSE-PROXY-SETUP.md](REVERSE-PROXY-SETUP.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```bash
# –û–±–Ω–æ–≤–ª—è–µ–º keyword_match_threshold –Ω–∞ 65%
docker compose exec web-admin python scripts/update_keyword_threshold.py
```

**–í—ã–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:**
```
–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ keyword_match_threshold: 70
OK: Obnovleno keyword_match_threshold = 65%
```

### –®–∞–≥ 4: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤

```bash
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose --profile bitrix24 down

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã —Å –Ω–æ–≤—ã–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
docker compose --profile bitrix24 build --no-cache

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose --profile bitrix24 up -d
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
docker compose ps

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ BASE_PATH –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
docker compose logs -f --tail=50 bitrix24-bot | grep -E "(BASE_PATH|HANDLER_URL)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏
docker compose logs -f --tail=50 bitrix24-bot

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å "–∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∫–∞—Ä—Ç—Ä–∏–¥–∂" –≤ –±–æ—Ç–µ
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

1. **–í –ª–æ–≥–∞—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–µ—Å–ª–∏ BASE_PATH –Ω–∞—Å—Ç—Ä–æ–µ–Ω):**
   ```
   üîß BASE_PATH –ø—Ä–∏–º–µ–Ω—ë–Ω –∫ HANDLER_URL: https://domain.com/faqbot/webhook/bitrix24
   ```

2. **–ó–∞–ø—Ä–æ—Å "–∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∫–∞—Ä—Ç—Ä–∏–¥–∂":**
   - Search Level: `keyword`
   - Confidence: `95.0%`
   - FAQ –Ω–∞–π–¥–µ–Ω: "–ó–∞–∫–æ–Ω—á–∏–ª—Å—è –∫–∞—Ä—Ç—Ä–∏–¥–∂, —á—Ç–æ –¥–µ–ª–∞—Ç—å?"

3. **–ö–Ω–æ–ø–∫–∏ –ø–æ—Ö–æ–∂–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç:**
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–∞—Å—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ—Ö–æ–∂–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚úì

---

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

### –û—Ç–∫–∞—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
docker compose exec web-admin cp data/bot.db.backup data/bot.db

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose --profile bitrix24 restart
```

### –û—Ç–∫–∞—Ç –∫–æ–¥–∞

```bash
# –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
git log --oneline  # –ù–∞—Ö–æ–¥–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç
git reset --hard <commit-hash>

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã
docker compose --profile bitrix24 build --no-cache
docker compose --profile bitrix24 up -d
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–∏—Å–∫–∞

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ –±–æ—Ç –∑–∞–ø—Ä–æ—Å—ã:
- ‚úÖ "–∑–∞–∫–æ–Ω—á–∏–ª—Å—è –∫–∞—Ä—Ç—Ä–∏–¥–∂" ‚Üí –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ FAQ (keyword, 95%)
- ‚úÖ "–∑–∞—Ä–ø–ª–∞—Ç–∞ –º–µ–Ω—å—à–µ" ‚Üí –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ FAQ (keyword, 95%)
- ‚úÖ "vpn –¥–æ—Å—Ç—É–ø" ‚Üí –¥–æ–ª–∂–µ–Ω –Ω–∞–π—Ç–∏ FAQ (keyword, 95%)

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞

```bash
docker images | grep faqbot
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä:** ~2.0 GB (—Ä–∞–Ω—å—à–µ –±—ã–ª–æ ~3.5 GB)

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è CUDA

```bash
docker compose exec web-admin python -c "import torch; print('CUDA:', torch.cuda.is_available())"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:** `CUDA: False`

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ CPU –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** [DOCKER-CPU-OPTIMIZATION.md](DOCKER-CPU-OPTIMIZATION.md)
- **–ê–ª–≥–æ—Ä–∏—Ç–º –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:** [CLAUDE.md](CLAUDE.md#cascading-search)

---

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker compose logs -f bitrix24-bot`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: –∑–∞–π–¥–∏—Ç–µ –≤ –≤–µ–±-–∞–¥–º–∏–Ω–∫—É ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏
3. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã
