<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ Bot - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>

    <!-- Quill WYSIWYG Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            border-bottom: 3px solid #34495e;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.85;
            font-size: 1em;
            color: #ecf0f1;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .search-section {
            background: white;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-header h3 {
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 600;
        }

        .search-type-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-type-toggle label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-info {
            padding: 12px;
            background: #e3f2fd;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            font-size: 14px;
            color: #495057;
        }

        .search-results-count {
            font-weight: bold;
            color: #2c3e50;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .filter-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .actions-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        select, input, button {
            padding: 12px 20px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        select, input {
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 4px 10px;
            font-size: 18px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-small:hover {
            background-color: #45a049;
        }

        .content {
            padding: 30px;
        }

        .faq-list {
            display: grid;
            gap: 20px;
        }

        .faq-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            padding: 20px;
            transition: all 0.3s;
        }

        .faq-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
            transform: translateY(-1px);
        }

        .faq-item.search-result {
            border-color: #28a745;
        }

        .faq-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .faq-info {
            flex: 1;
        }

        .faq-category {
            display: inline-block;
            background: #34495e;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 10px;
            margin-right: 10px;
            font-weight: 500;
        }

        .match-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .similarity-badge {
            display: inline-block;
            background: #17a2b8;
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }

        .faq-question {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .faq-answer {
            color: #666;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .faq-keywords {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword {
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 13px;
            color: #495057;
        }

        .faq-actions {
            display: flex;
            gap: 10px;
        }

        .faq-actions button {
            padding: 8px 15px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 4px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è Quill WYSIWYG —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
        .wysiwyg-editor {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .wysiwyg-editor .ql-toolbar {
            border: none;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
        }

        .wysiwyg-editor .ql-container {
            border: none;
            font-size: 16px;
            font-family: inherit;
            min-height: 150px;
        }

        .wysiwyg-editor .ql-editor {
            min-height: 150px;
            padding: 12px;
            line-height: 1.6;
        }

        .wysiwyg-editor .ql-editor.ql-blank::before {
            color: #adb5bd;
            font-style: normal;
        }

        .wysiwyg-editor:focus-within {
            border-color: #3498db;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 2000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #3498db;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FAQ Bot - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –º–æ–¥–µ–ª–∏</p>
        </div>

        <div class="controls">
            <!-- –°–µ–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ -->
            <div class="search-section">
                <div class="search-header">
                    <h3>üîç –ü–æ–∏—Å–∫ FAQ</h3>
                    <div class="search-type-toggle">
                        <label>
                            <input type="radio" name="searchType" value="text" checked>
                            –¢–µ–∫—Å—Ç–æ–≤—ã–π
                        </label>
                        <label>
                            <input type="radio" name="searchType" value="semantic">
                            –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π (AI)
                        </label>
                    </div>
                </div>
                
                <div class="search-box">
                    <input 
                        type="text" 
                        id="searchQuery" 
                        class="search-input" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..."
                        onkeypress="if(event.key==='Enter') performSearch()"
                    >
                    <button onclick="performSearch()">üîç –ò—Å–∫–∞—Ç—å</button>
                    <button class="btn-secondary" onclick="clearSearch()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                
                <div id="searchInfo" style="display: none;"></div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="filter-group">
                <div class="filter-left">
                    <select id="categoryFilter">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-right">
                    <button onclick="openAddModal()">+ –î–æ–±–∞–≤–∏—Ç—å FAQ</button>
                    <button onclick="window.location.href='/admin/logs'" class="btn-secondary">üìä –õ–æ–≥–∏</button>
                    <button onclick="window.location.href='/admin/settings'" class="btn-secondary">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</button>
                    <button onclick="retrainModel()" class="btn-warning">üîÑ –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div id="faqList" class="faq-list">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è FAQ -->
    <div id="faqModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-header" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å FAQ</h2>
            <form id="faqForm">
                <input type="hidden" id="faqId">
                <div class="form-group">
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="faqCategory" required style="flex: 1;">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            </select>
                            <button type="button" id="addCategoryBtn" class="btn-small" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>–í–æ–ø—Ä–æ—Å *</label>
                    <input type="text" id="faqQuestion" required>
                </div>
                <div class="form-group">
                    <label>–û—Ç–≤–µ—Ç *</label>
                    <div id="faqAnswerEditor" class="wysiwyg-editor"></div>
                    <textarea id="faqAnswer" required style="display: none;"></textarea>
                </div>
                <div class="form-group">
                    <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="faqKeywords" placeholder="—Å–ª–æ–≤–æ1, —Å–ª–æ–≤–æ2, —Å–ª–æ–≤–æ3">
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="categoryModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
            <input type="text" id="newCategoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
            <div class="form-actions">
                <button type="button" onclick="closeCategoryModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" onclick="saveCategory()" class="btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let currentEditId = null;
        let isSearchActive = false;
        let currentSearchData = null;
        let answerEditor = null; // Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –æ—Ç–≤–µ—Ç–∞

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Quill HTML –≤ Telegram HTML
        function convertQuillToTelegramHtml(html) {
            // –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–≥–∏ Quill –Ω–∞ —Ç–µ–≥–∏ Telegram
            html = html.replace(/<strong>/g, '<b>');
            html = html.replace(/<\/strong>/g, '</b>');
            html = html.replace(/<em>/g, '<i>');
            html = html.replace(/<\/em>/g, '</i>');

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º code-block –≤ code
            html = html.replace(/<pre class="ql-syntax"[^>]*>/g, '<code>');
            html = html.replace(/<\/pre>/g, '</code>');

            // –í–ê–ñ–ù–û: Telegram HTML –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç <br>, –∏—Å–ø–æ–ª—å–∑—É–µ–º \n
            // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã
            html = html.replace(/<p><br><\/p>/g, '\n');
            html = html.replace(/<p>/g, '');
            html = html.replace(/<\/p>/g, '\n');

            // –ó–∞–º–µ–Ω—è–µ–º <br> –Ω–∞ \n
            html = html.replace(/<br>/g, '\n');
            html = html.replace(/<br\/>/g, '\n');
            html = html.replace(/<br \/>/g, '\n');

            // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã –≤ –∫–æ–Ω—Ü–µ
            html = html.replace(/\n+$/g, '');

            return html;
        }

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Telegram HTML –≤ Quill HTML (–æ–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)
        function convertTelegramToQuillHtml(html) {
            if (!html) return '<p><br></p>';

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–≥–∏ Telegram –≤ —Ç–µ–≥–∏ Quill
            html = html.replace(/<b>/g, '<strong>');
            html = html.replace(/<\/b>/g, '</strong>');
            html = html.replace(/<i>/g, '<em>');
            html = html.replace(/<\/i>/g, '</em>');

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º code –≤ pre
            html = html.replace(/<code>/g, '<code class="ql-code">');

            // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ \n –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ <p> —Ç–µ–≥–∏
            const lines = html.split('\n');
            const paragraphs = lines.map(line => {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ
                if (line.trim() === '') {
                    return '<p><br></p>';
                }
                // –ò–Ω–∞—á–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ <p>
                return '<p>' + line + '</p>';
            });

            return paragraphs.join('');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        function initAnswerEditor() {
            if (answerEditor) {
                return; // –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            }

            const editorContainer = document.getElementById('faqAnswerEditor');
            if (!editorContainer) return;

            answerEditor = new Quill(editorContainer, {
                theme: 'snow',
                placeholder: '–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å...',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'code'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å textarea
            answerEditor.on('text-change', () => {
                const html = answerEditor.root.innerHTML;
                const telegramHtml = convertQuillToTelegramHtml(html);
                document.getElementById('faqAnswer').value = telegramHtml;
            });
        }

        // –ü–æ–∏—Å–∫ FAQ
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', 'error');
                return;
            }

            const searchType = document.querySelector('input[name="searchType"]:checked').value;
            const searchInfo = document.getElementById('searchInfo');
            const faqList = document.getElementById('faqList');
            
            searchInfo.style.display = 'block';
            searchInfo.innerHTML = '<div class="search-info">‚è≥ –ü–æ–∏—Å–∫...</div>';
            
            try {
                let response;
                
                if (searchType === 'text') {
                    response = await fetch(`/admin/search?q=${encodeURIComponent(query)}`);
                } else {
                    response = await fetch('/admin/search/semantic', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({query: query, n_results: 20})
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    isSearchActive = true;
                    currentSearchData = data;
                    displaySearchResults(data, searchType);
                } else {
                    searchInfo.innerHTML = `<div class="search-info" style="background: #f8d7da; border-color: #dc3545;">‚ùå ${data.message}</div>`;
                }
                
            } catch (error) {
                searchInfo.innerHTML = `<div class="search-info" style="background: #f8d7da; border-color: #dc3545;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        function displaySearchResults(data, searchType) {
            const searchInfo = document.getElementById('searchInfo');
            const faqList = document.getElementById('faqList');
            
            if (data.count === 0) {
                searchInfo.innerHTML = `
                    <div class="search-info" style="background: #fff3cd; border-color: #ffc107;">
                        üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "<strong>${data.query}</strong>"
                    </div>
                `;
                faqList.innerHTML = `
                    <div class="empty-state">
                        <h2>üîç –ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Ç–∏–ø –ø–æ–∏—Å–∫–∞</p>
                    </div>
                `;
                return;
            }
            
            searchInfo.innerHTML = `
                <div class="search-info">
                    ‚úÖ –ù–∞–π–¥–µ–Ω–æ: <span class="search-results-count">${data.count}</span> —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ 
                    | –ó–∞–ø—Ä–æ—Å: "<strong>${data.query}</strong>" 
                    | –¢–∏–ø: <strong>${searchType === 'text' ? '–¢–µ–∫—Å—Ç–æ–≤—ã–π' : '–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π (AI)'}</strong>
                </div>
            `;
            
            faqList.innerHTML = data.results.map(faq => {
                let badges = '';
                
                if (faq.match_location && faq.match_location.length > 0) {
                    badges = `<span class="match-badge">–ù–∞–π–¥–µ–Ω–æ –≤: ${faq.match_location.join(', ')}</span>`;
                }
                
                if (faq.similarity) {
                    badges += `<span class="similarity-badge">–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ: ${faq.similarity}%</span>`;
                }
                
                return `
                    <div class="faq-item search-result">
                        <div class="faq-header">
                            <div class="faq-info">
                                <div>
                                    <div class="faq-category">${faq.category}</div>
                                    ${badges}
                                </div>
                                <div class="faq-question">${faq.question}</div>
                                <div class="faq-answer">${faq.answer}</div>
                                ${faq.keywords && faq.keywords.length > 0 ? `
                                    <div class="faq-keywords">
                                        ${faq.keywords.map(k => `<span class="keyword">${k}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="faq-actions">
                                <button onclick="editFAQ('${faq.id || ''}')" class="btn-warning">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                                <button onclick="deleteFAQ('${faq.id || ''}')" class="btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearSearch() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchInfo').style.display = 'none';
            document.getElementById('searchInfo').innerHTML = '';
            isSearchActive = false;
            currentSearchData = null;
            loadFAQs(document.getElementById('categoryFilter').value);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ FAQ
        async function loadFAQs(category = '') {
            if (isSearchActive) return; // –ù–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ–∏—Å–∫

            const url = category ? `/admin/faq/list?category=${category}` : '/admin/faq/list';
            const response = await fetch(url);
            const faqs = await response.json();

            const faqList = document.getElementById('faqList');

            if (faqs.length === 0) {
                faqList.innerHTML = `
                    <div class="empty-state">
                        <h2>üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
                        <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π FAQ –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                `;
                return;
            }

            faqList.innerHTML = faqs.map(faq => `
                <div class="faq-item">
                    <div class="faq-header">
                        <div class="faq-info">
                            <div class="faq-category">${faq.category}</div>
                            <div class="faq-question">${faq.question}</div>
                            <div class="faq-answer">${faq.answer}</div>
                            ${faq.keywords.length > 0 ? `
                                <div class="faq-keywords">
                                    ${faq.keywords.map(k => `<span class="keyword">${k}</span>`).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="faq-actions">
                            <button onclick="editFAQ('${faq.id}')" class="btn-warning">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button onclick="deleteFAQ('${faq.id}')" class="btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadCategories(selectedCategory = '') {
            const select = document.getElementById('faqCategory');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';

            try {
                const response = await fetch('/admin/categories');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');

                const categories = await response.json();
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (cat === selectedCategory) option.selected = true;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            }
        }

        async function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å FAQ';
            document.getElementById('faqForm').reset();
            document.getElementById('faqId').value = '';
            await loadCategories();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä
            initAnswerEditor();

            // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (answerEditor) {
                answerEditor.setText('');
            }

            document.getElementById('faqModal').classList.add('active');
        }

        async function editFAQ(id) {
            const response = await fetch(`/admin/faq/${id}`);
            const faq = await response.json();

            currentEditId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å FAQ';
            document.getElementById('faqId').value = faq.id;
            loadCategories(faq.category);
            document.getElementById('faqQuestion').value = faq.question;
            document.getElementById('faqKeywords').value = faq.keywords.join(', ');

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä
            initAnswerEditor();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–≤–µ—Ç –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—è –∏–∑ Telegram HTML
            if (answerEditor) {
                const quillHtml = convertTelegramToQuillHtml(faq.answer);
                answerEditor.root.innerHTML = quillHtml;
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç—ã–π textarea
                const telegramHtml = convertQuillToTelegramHtml(answerEditor.root.innerHTML);
                document.getElementById('faqAnswer').value = telegramHtml;
            }

            document.getElementById('faqModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('faqModal').classList.remove('active');
            // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
            if (answerEditor) {
                answerEditor.setText('');
            }
        }

        document.getElementById('faqForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                category: document.getElementById('faqCategory').value,
                question: document.getElementById('faqQuestion').value,
                answer: document.getElementById('faqAnswer').value,
                keywords: document.getElementById('faqKeywords').value
            };

            if (currentEditId) {
                data.id = currentEditId;
            }

            let response;
            if (currentEditId) {
                response = await fetch(`/admin/faq/update/${currentEditId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch('/admin/faq/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }

            const result = await response.json();

            if (result.success) {
                showNotification(result.message, 'success');
                closeModal();
                clearSearch(); // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                showNotification(result.message, 'error');
            }
        });

        async function deleteFAQ(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç FAQ?')) return;

            const response = await fetch(`/admin/faq/delete/${id}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (result.success) {
                showNotification(result.message, 'success');
                clearSearch(); // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                showNotification(result.message, 'error');
            }
        }

        async function retrainModel() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) return;

            showNotification('–ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏...', 'info');

            const response = await fetch('/admin/retrain', {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                showNotification(`${result.message} (${result.count} –∑–∞–ø–∏—Å–µ–π)`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏: ' + result.message, 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        document.getElementById('addCategoryBtn').addEventListener('click', () => {
            document.getElementById('categoryModal').classList.add('active');
        });

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        async function saveCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                return;
            }

            const response = await fetch('/admin/categories', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name })
            });

            if (response.ok) {
                document.getElementById('newCategoryName').value = '';
                closeCategoryModal();
                await loadCategories(name);
                document.getElementById('faqCategory').value = name;
            } else {
                const data = await response.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            }
        }

        document.getElementById('categoryFilter').addEventListener('change', (e) => {
            clearSearch();
            loadFAQs(e.target.value);
        });

        document.getElementById('faqModal').addEventListener('click', (e) => {
            if (e.target.id === 'faqModal') {
                closeModal();
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadFAQs();
    </script>
</body>
</html>
