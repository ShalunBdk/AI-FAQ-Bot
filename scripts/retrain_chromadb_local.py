# -*- coding: utf-8 -*-
"""
–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ ChromaDB
"""

import sys
import os
import logging

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from dotenv import load_dotenv
load_dotenv()

os.environ["ANONYMIZED_TELEMETRY"] = "False"

import chromadb
from chromadb.utils import embedding_functions
from src.core import database

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
MODEL_NAME = os.getenv("MODEL_NAME", "deepvk/USER2-base")
CHROMA_PATH = os.getenv('CHROMA_PATH', './data/chroma_db')


def retrain_chromadb():
    """
    –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ ChromaDB –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã
    """
    logger.info("="*80)
    logger.info("üîÑ –ü–ï–†–ï–û–ë–£–ß–ï–ù–ò–ï CHROMADB")
    logger.info("="*80)
    logger.info(f"   –ú–æ–¥–µ–ª—å: {MODEL_NAME}")
    logger.info(f"   –ü—É—Ç—å: {CHROMA_PATH}")

    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ChromaDB
        chroma_client = chromadb.PersistentClient(path=CHROMA_PATH)
        embedding_func = embedding_functions.SentenceTransformerEmbeddingFunction(
            model_name=MODEL_NAME
        )

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
        try:
            chroma_client.delete_collection(name="faq_collection")
            logger.info("‚úÖ –°—Ç–∞—Ä–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞")
        except Exception as e:
            logger.info(f"‚ö†Ô∏è –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–µ –±—ã–ª–æ –∏–ª–∏ –æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: {e}")

        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
        collection = chroma_client.create_collection(
            name="faq_collection",
            embedding_function=embedding_func,
            metadata={"hnsw:space": "cosine"}
        )
        logger.info("‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è")

        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ FAQ –∏–∑ –±–∞–∑—ã
        all_faqs = database.get_all_faqs()
        if not all_faqs:
            logger.error("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è")
            return False

        logger.info(f"üì• –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(all_faqs)} FAQ –∏–∑ –±–∞–∑—ã")

        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è ChromaDB
        documents, metadatas, ids = [], [], []
        for faq in all_faqs:
            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
            keywords = faq.get('keywords', [])
            if isinstance(keywords, list):
                keywords_str = ' '.join(keywords)
            elif isinstance(keywords, str):
                keywords_str = keywords.replace(',', ' ')
            else:
                keywords_str = ''

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
            text = f"{faq['question']} {keywords_str}"
            documents.append(f"search_document: {text}")

            metadatas.append({
                "category": faq["category"],
                "question": faq["question"],
                "answer": faq["answer"]
            })
            ids.append(str(faq["id"]))

        # –î–æ–±–∞–≤–ª—è–µ–º –≤ ChromaDB
        collection.add(documents=documents, metadatas=metadatas, ids=ids)

        logger.info(f"‚úÖ ChromaDB –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∞: {len(all_faqs)} –∑–∞–ø–∏—Å–µ–π")
        logger.info(f"‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç {collection.count()} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞
        test_results = collection.query(
            query_texts=["search_query: —Ç–µ—Å—Ç"],
            n_results=1
        )
        if test_results and test_results['ids']:
            logger.info("‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
        else:
            logger.warning("‚ö†Ô∏è –ö–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞—è –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")

        return True

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–∏: {e}")
        import traceback
        traceback.print_exc()
        return False


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    success = retrain_chromadb()

    if success:
        logger.info("\n" + "="*80)
        logger.info("üéâ –ü–ï–†–ï–û–ë–£–ß–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!")
        logger.info("="*80)
        logger.info("\n–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å:")
        logger.info("  python scripts/test_keyword_ranking.py")
    else:
        logger.error("\n" + "="*80)
        logger.error("‚ùå –û–®–ò–ë–ö–ê –ü–ï–†–ï–û–ë–£–ß–ï–ù–ò–Ø")
        logger.error("="*80)


if __name__ == "__main__":
    main()
