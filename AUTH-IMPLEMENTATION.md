# JWT Authentication Implementation

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

**–î–∞—Ç–∞**: 2025-01-28
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (`src/web/static/js/auth.js`)

**–§—É–Ω–∫—Ü–∏–∏:**
- `getAuthToken()` - –ø–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ –∏–∑ URL –∏–ª–∏ localStorage
- `fetchWithAuth(url, options)` - fetch —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º Authorization header
- `getCurrentUser()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `isAuthenticated()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
- `logout()` - –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```javascript
// 1. –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ ?token=...
const tokenFromUrl = new URLSearchParams(window.location.search).get('token');

// 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
localStorage.setItem('accessToken', tokenFromUrl);

// 3. –û—á–∏—â–∞–µ–º URL –æ—Ç —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
window.history.replaceState({}, '', cleanUrl);

// 4. –î–æ–±–∞–≤–ª—è–µ–º Authorization –≤–æ –≤—Å–µ API –∑–∞–ø—Ä–æ—Å—ã
fetchWithAuth('/admin/api/logs/list', {method: 'GET'})
// ‚Üí headers: { Authorization: 'Bearer eyJhbGci...' }
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω –±—ç–∫–µ–Ω–¥ (`src/web/web_admin.py`)

**–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞:**

```python
@admin_bp.before_request
def check_admin_access():
    if not is_production():
        return  # Dev —Ä–µ–∂–∏–º - –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫

    # 1. Origin –ø—Ä–æ–≤–µ—Ä–∫–∞ - –¥–ª—è –í–°–ï–• –∑–∞–ø—Ä–æ—Å–æ–≤
    if not check_cors_origin(origin):
        return 403

    # 2. JWT –ø—Ä–æ–≤–µ—Ä–∫–∞ - —Ç–æ–ª—å–∫–æ –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
    is_api_request = (
        request.method in ['POST', 'PUT', 'DELETE'] or
        '/api/' in request.path
    )

    if is_api_request:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º JWT —Ç–æ–∫–µ–Ω
        if not valid_token:
            return 401
```

**–ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞:**

| –ó–∞–ø—Ä–æ—Å | –ë–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–∏–∑ Bitrix24) | –° —Ç–æ–∫–µ–Ω–æ–º (–∏–∑ Bitrix24) |
|--------|-------------------------|------------------------|
| `GET /admin/` (HTML) | ‚úÖ 200 OK | ‚úÖ 200 OK |
| `GET /admin/logs` (HTML) | ‚úÖ 200 OK | ‚úÖ 200 OK |
| `GET /admin/api/logs/list` | ‚ùå 401 | ‚úÖ 200 OK |
| `POST /admin/faq/add` | ‚ùå 401 | ‚úÖ 200 OK |
| `PUT /admin/faq/update/1` | ‚ùå 401 | ‚úÖ 200 OK |
| `DELETE /admin/faq/delete/1` | ‚ùå 401 | ‚úÖ 200 OK |

### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ HTML —à–∞–±–ª–æ–Ω—ã

**–§–∞–π–ª—ã:**
- ‚úÖ `index.html` - –ø–æ–¥–∫–ª—é—á–µ–Ω `auth.js`, –∑–∞–º–µ–Ω–µ–Ω–æ 10 fetch
- ‚úÖ `logs.html` - –ø–æ–¥–∫–ª—é—á–µ–Ω `auth.js`, –∑–∞–º–µ–Ω–µ–Ω–æ 2 fetch
- ‚úÖ `settings.html` - –ø–æ–¥–∫–ª—é—á–µ–Ω `auth.js`, –∑–∞–º–µ–Ω–µ–Ω–æ 3 fetch
- ‚úÖ `permissions.html` - –ø–æ–¥–∫–ª—é—á–µ–Ω `auth.js`, –∑–∞–º–µ–Ω–µ–Ω–æ 4 fetch

**–ë—ã–ª–æ:**
```javascript
const response = await fetch('/admin/api/logs/list');
```

**–°—Ç–∞–ª–æ:**
```javascript
const response = await fetchWithAuth('/admin/api/logs/list');
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è: Authorization: Bearer <token>
```

---

## üîÑ –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –®–∞–≥ 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω–∫—É –≤ Bitrix24

```
1. Bitrix24 ‚Üí GET /bitrix24/app
2. OAuth –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Bitrix24
3. Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
4. –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥:
   {
     "accessToken": "eyJhbGci...",
     "user": {"id": "405", "role": "admin", "username": "..."}
   }
```

### –®–∞–≥ 2: Iframe –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å —Ç–æ–∫–µ–Ω–æ–º

```
5. iframe.src = '/admin/?token=eyJhbGci...'
6. auth.js –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ URL
7. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ localStorage.setItem('accessToken', token)
8. –û—á–∏—â–∞–µ—Ç URL ‚Üí '/admin/'
```

### –®–∞–≥ 3: API –∑–∞–ø—Ä–æ—Å—ã —Å —Ç–æ–∫–µ–Ω–æ–º

```
9. JavaScript –≤—ã–∑—ã–≤–∞–µ—Ç:
   fetchWithAuth('/admin/api/logs/list')

10. auth.js –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫:
    Authorization: Bearer eyJhbGci...

11. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω
12. ‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –≤ –∞–¥–º–∏–Ω–∫–µ:
```javascript
console.log(getAuthToken());
// –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: "eyJhbGci..."

console.log(getCurrentUser());
// –î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: {id: "405", role: "admin", username: "..."}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∑–∞–ø—Ä–æ—Å–æ–≤

–í Network tab DevTools –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª—é–±–æ–π API –∑–∞–ø—Ä–æ—Å:
```
Request Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞)

```javascript
// –£–¥–∞–ª–∏—Ç–µ —Ç–æ–∫–µ–Ω
localStorage.removeItem('accessToken');

// –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏
// –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ 401 Unauthorized
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (–¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è)

```bash
# –ë–µ–∑ Origin –∏–∑ Bitrix24
curl https://it.virtex-food.ru/faqbot/admin/
‚Üí 403 Forbidden
```

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è | –°—Ç—Ä–æ–∫–∏ |
|------|-----------|--------|
| `src/web/static/js/auth.js` | ‚ú® –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π | 100+ |
| `src/web/web_admin.py` | üîí –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ | ~60 |
| `src/web/templates/admin/index.html` | üîë –î–æ–±–∞–≤–ª–µ–Ω auth.js, 10 –∑–∞–º–µ–Ω | 12, 402-681 |
| `src/web/templates/admin/logs.html` | üîë –î–æ–±–∞–≤–ª–µ–Ω auth.js, 2 –∑–∞–º–µ–Ω—ã | 12, 312-346 |
| `src/web/templates/admin/settings.html` | üîë –î–æ–±–∞–≤–ª–µ–Ω auth.js, 3 –∑–∞–º–µ–Ω—ã | 12, ... |
| `src/web/templates/admin/permissions.html` | üîë –î–æ–±–∞–≤–ª–µ–Ω auth.js, 4 –∑–∞–º–µ–Ω—ã | 12, 322-631 |

---

## ‚úÖ Checklist —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### Backend
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `web_admin.py` —Å –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–æ–π –∑–∞—â–∏—Ç–æ–π
- [x] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã `jwt` –∏ `re` –º–æ–¥—É–ª–∏
- [x] `ENVIRONMENT=production` –≤ .env
- [x] `JWT_SECRET` —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### Frontend
- [x] –°–æ–∑–¥–∞–Ω `auth.js` –º–æ–¥—É–ª—å
- [x] –ü–æ–¥–∫–ª—é—á–µ–Ω –≤ `index.html`
- [x] –ü–æ–¥–∫–ª—é—á–µ–Ω –≤ `logs.html`
- [x] –ü–æ–¥–∫–ª—é—á–µ–Ω –≤ `settings.html`
- [x] –ü–æ–¥–∫–ª—é—á–µ–Ω –≤ `permissions.html`
- [x] –í—Å–µ `fetch` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `fetchWithAuth`

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω–∫—É –≤ Bitrix24
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–æ–∫–µ–Ω –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ localStorage
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ API –∑–∞–ø—Ä–æ—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç Authorization header
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ª–æ–≥–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FAQ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫:

‚úÖ **Origin –ø—Ä–æ–≤–µ—Ä–∫–∞** - –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∏–∑ Bitrix24
‚úÖ **JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - —Ç—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è API
‚úÖ **HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã** - –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ iframe
‚úÖ **API –∑–∞—â–∏—â–µ–Ω–æ** - —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω—è—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
‚úÖ **–¢–æ–∫–µ–Ω –æ—á–∏—â–∞–µ—Ç—Å—è –∏–∑ URL** - –Ω–µ –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
‚úÖ **HTTPS only** - —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—é

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

- [ ] Refresh token mechanism (–∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤)
- [ ] Token expiration check –≤ auth.js
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /bitrix24/auth –ø—Ä–∏ 401
- [ ] Rate limiting –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] CSRF tokens –¥–ª—è —Ñ–æ—Ä–º

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ—Å—Ç–æ–π GET –∑–∞–ø—Ä–æ—Å
```javascript
const response = await fetchWithAuth('/admin/api/logs/list?page=1');
const data = await response.json();
```

### POST –∑–∞–ø—Ä–æ—Å —Å –¥–∞–Ω–Ω—ã–º–∏
```javascript
const response = await fetchWithAuth('/admin/faq/add', {
    method: 'POST',
    body: {
        question: '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç?',
        answer: '–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫...',
        category: 'FAQ'
    }
});
```

### PUT –∑–∞–ø—Ä–æ—Å
```javascript
const response = await fetchWithAuth(`/admin/faq/update/${id}`, {
    method: 'PUT',
    body: {
        question: '–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å',
        answer: '–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç'
    }
});
```

### DELETE –∑–∞–ø—Ä–æ—Å
```javascript
const response = await fetchWithAuth(`/admin/faq/delete/${id}`, {
    method: 'DELETE'
});
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: 401 Unauthorized

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage
2. –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫
3. –ù–µ–≤–µ—Ä–Ω—ã–π JWT_SECRET –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω
console.log(localStorage.getItem('accessToken'));

// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω–∞ (–¥–µ–∫–æ–¥–∏—Ä—É–π—Ç–µ –Ω–∞ jwt.io)
```

### –ü—Ä–æ–±–ª–µ–º–∞: 403 Forbidden

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Origin –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å BITRIX24_DOMAIN
2. –ó–∞–ø—Ä–æ—Å –Ω–µ –∏–∑ Bitrix24 iframe

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `BITRIX24_DOMAIN` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∞–¥–º–∏–Ω–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ Bitrix24, –∞ –Ω–µ –Ω–∞–ø—Ä—è–º—É—é

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–æ–∫–µ–Ω –Ω–µ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ URL

**–†–µ—à–µ–Ω–∏–µ:**
```javascript
// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL
console.log(window.location.search);
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ?token=eyJhbGci...

// –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ auth.js –∑–∞–≥—Ä—É–∂–µ–Ω
console.log(typeof getAuthToken);
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: function
```

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0
**–ê–≤—Ç–æ—Ä**: AI Assistant
**–î–∞—Ç–∞**: 2025-01-28
