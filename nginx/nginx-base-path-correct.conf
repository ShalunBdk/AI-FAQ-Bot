# ================================================
# ПРАВИЛЬНАЯ конфигурация Nginx для BASE_PATH
# ================================================
# Использует ProxyFix middleware в Flask
# НЕТ костылей с volumes и alias!
# ================================================

# Пример: Приложение доступно на https://domain.com/faqbot
# BASE_PATH=/faqbot в .env

# ============================================
# ADMIN WEB PANEL (/faqbot)
# ============================================
location /faqbot {
    # ✅ ПРАВИЛЬНО: НЕТ rewrite! Проксируем с полным путём
    proxy_pass http://faqbot-web-admin:5000;

    # Важные headers для ProxyFix
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Script-Name /faqbot;  # ← КЛЮЧЕВОЙ header!

    # HTTP/1.1 для keep-alive
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Буферизация и таймауты
    proxy_buffering off;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 300s;

    # Размер загружаемых файлов
    client_max_body_size 10M;
}

# СТАТИКА ОБРАБАТЫВАЕТСЯ ТЕМ ЖЕ location /faqbot!
# НЕТ отдельного location /faqbot/static - он не нужен!
# Flask сам отдаёт статику через ProxyFix

# ============================================
# BITRIX24 BOT WEBHOOK (/faqbot/webhook/bitrix24)
# ============================================
location /faqbot/webhook/bitrix24 {
    # ✅ ПРАВИЛЬНО: НЕТ rewrite!
    proxy_pass http://faqbot-bitrix24-bot:5002;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Script-Name /faqbot;  # ← Для Bitrix24 бота тоже!

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_read_timeout 300s;

    # Только POST запросы
    limit_except POST {
        deny all;
    }
}

# ============================================
# BITRIX24 OAUTH (если используется)
# ============================================
location /bitrix24/ {
    # OAuth endpoints не используют BASE_PATH
    proxy_pass http://faqbot-web-admin:5000/bitrix24/;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
}

# ============================================
# HEALTH CHECKS (опционально)
# ============================================
location /faqbot/health {
    proxy_pass http://faqbot-web-admin:5000/health;
    access_log off;
}

location /faqbot-bot/health {
    proxy_pass http://faqbot-bitrix24-bot:5002/health;
    access_log off;
}

# ============================================
# ПРИМЕЧАНИЯ
# ============================================
# 1. X-Script-Name header - ключевой момент!
#    ProxyFix использует его для определения BASE_PATH
#
# 2. НЕТ rewrite - Flask сам парсит полный путь
#
# 3. НЕТ location /faqbot/static - не нужен!
#    Статика обрабатывается через location /faqbot
#
# 4. НЕТ volumes между nginx и flask контейнерами
#
# 5. Для изменения BASE_PATH:
#    - Измените .env: BASE_PATH=/новый-путь
#    - Обновите nginx: location /новый-путь { ... }
#    - Перезапустите: docker compose restart
#
# 6. Для работы БЕЗ BASE_PATH (корневой путь):
#    - .env: BASE_PATH=
#    - nginx: location / { ... }
