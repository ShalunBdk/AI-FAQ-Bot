# ================================================
# Конфигурация Nginx для FAQ-бота
# Добавьте эти location блоки в ваш существующий server блок
# ================================================

# Админ-панель FAQ бота (Web интерфейс)
# Доступ: https://your-domain.com/faq-admin
location /faq-admin {
    # Удаляем /faq-admin из URI перед передачей в приложение
    rewrite ^/faq-admin/(.*)$ /$1 break;
    rewrite ^/faq-admin$ / break;

    proxy_pass http://faqbot-web-admin:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Prefix /faq-admin;

    # Настройки для Flask приложения
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_read_timeout 300s;

    # Размер загружаемых файлов (если нужно)
    client_max_body_size 10M;
}

# Статические файлы админ-панели (если нужно)
location /faq-admin/static {
    rewrite ^/faq-admin/static/(.*)$ /static/$1 break;
    proxy_pass http://faqbot-web-admin:5000;
    proxy_set_header Host $host;
    proxy_cache_valid 200 1d;
    expires 1d;
    add_header Cache-Control "public, immutable";
}

# Telegram бот - внутренний reload endpoint
# Доступ: https://your-domain.com/faq-bot/reload
location /faq-bot {
    rewrite ^/faq-bot/(.*)$ /$1 break;
    rewrite ^/faq-bot$ / break;

    proxy_pass http://faqbot-telegram-bot:5001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_read_timeout 300s;

    # Ограничиваем доступ только к определенным endpoints
    # Если нужно ограничить доступ только с локальной сети:
    # allow 10.0.0.0/8;
    # allow 172.16.0.0/12;
    # allow 192.168.0.0/16;
    # deny all;
}

# Bitrix24 вебхуки (если используется Bitrix24 интеграция)
location /faq-bot/webhook/bitrix24 {
    rewrite ^/faq-bot/webhook/bitrix24(.*)$ /webhook/bitrix24$1 break;

    proxy_pass http://faqbot-bitrix24-bot:5002;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_buffering off;
    proxy_read_timeout 300s;

    # Разрешаем только POST-запросы
    limit_except POST {
        deny all;
    }
}

# Health checks для мониторинга
location /faq-admin/health {
    rewrite ^/faq-admin/health$ /health break;
    proxy_pass http://faqbot-web-admin:5000;
    access_log off;
}

location /faq-bot/health {
    rewrite ^/faq-bot/health$ /health break;
    proxy_pass http://faqbot-telegram-bot:5001;
    access_log off;
}
