# ================================================
# ПОЛНАЯ конфигурация Nginx с интеграцией FAQ-бота
# Замените существующий конфигурационный файл этим
# ================================================

server {
    listen 80;
    server_name _;

    # Перенаправление HTTP на HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name _;

    ssl_certificate /etc/nginx/ssl/your-domain.com.pem;
    ssl_certificate_key /etc/nginx/ssl/your-domain.com-key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256';

    client_max_body_size 100M;

    # ================================================
    # FAQ БОТ - Админ-панель
    # ================================================
    location /faq-admin {
        # Удаляем /faq-admin из URI перед передачей в приложение
        rewrite ^/faq-admin/(.*)$ /$1 break;
        rewrite ^/faq-admin$ / break;

        proxy_pass http://faqbot-web-admin:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /faq-admin;

        # Настройки для Flask приложения
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_read_timeout 300s;

        # Размер загружаемых файлов
        client_max_body_size 10M;
    }

    # Статические файлы админ-панели
    location /faq-admin/static {
        rewrite ^/faq-admin/static/(.*)$ /static/$1 break;
        proxy_pass http://faqbot-web-admin:5000;
        proxy_set_header Host $host;
        proxy_cache_valid 200 1d;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Health check для админ-панели
    location /faq-admin/health {
        rewrite ^/faq-admin/health$ /health break;
        proxy_pass http://faqbot-web-admin:5000;
        access_log off;
    }

    # ================================================
    # FAQ БОТ - Telegram бот (reload endpoint)
    # ================================================
    location /faq-bot {
        rewrite ^/faq-bot/(.*)$ /$1 break;
        rewrite ^/faq-bot$ / break;

        proxy_pass http://faqbot-telegram-bot:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_read_timeout 300s;
    }

    # Health check для бота
    location /faq-bot/health {
        rewrite ^/faq-bot/health$ /health break;
        proxy_pass http://faqbot-telegram-bot:5001;
        access_log off;
    }

    # ================================================
    # FAQ БОТ - Bitrix24 вебхуки (опционально)
    # ================================================
    location /faq-bot/webhook/bitrix24 {
        rewrite ^/faq-bot/webhook/bitrix24(.*)$ /webhook/bitrix24$1 break;

        proxy_pass http://faqbot-bitrix24-bot:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_read_timeout 300s;

        # Разрешаем только POST-запросы
        limit_except POST {
            deny all;
        }
    }

    # ================================================
    # СУЩЕСТВУЮЩИЕ LOCATION БЛОКИ
    # ================================================

    # GLPI
    location / {
#       auth_request /auth-proxy;
        proxy_pass http://glpi;
#        proxy_set_header REMOTE_USER $upstream_http_remote_user;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Обработка вебхуков для Telegram (существующий)
    location /webhook/ {
        proxy_pass http://webhook/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Особые настройки для API
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering off;
        proxy_read_timeout 300s;

        # Разрешаем только POST-запросы
        limit_except POST {
            deny all;
        }
    }

    # VPN скрипт
    location = /vpn {
        default_type text/plain;
        charset utf-8;
        alias /usr/share/nginx/vpn.ps1;
        add_header Content-Disposition "inline";
    }

    # II Practicum
    location /ii-practicum {
        alias /usr/share/nginx/ii-prac.html;
        default_type text/html;
        add_header Content-Type "text/html; charset=utf-8";
    }
}
