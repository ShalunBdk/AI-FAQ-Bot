# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è AI: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Bitrix24

> **–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è:** AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—ã, –ø–æ–º–æ–≥–∞—é—â–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å React/Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Bitrix24
>
> **–í–µ—Ä—Å–∏—è:** 1.0
> **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-11

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ](#–≤–≤–µ–¥–µ–Ω–∏–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
3. [–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è](#–ø–æ—à–∞–≥–æ–≤–∞—è-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
4. [Backend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#backend-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
5. [Frontend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è](#frontend-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
6. [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](#–±–∞–∑–∞-–¥–∞–Ω–Ω—ã—Ö)
7. [–°–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞](#—Å–∏—Å—Ç–µ–º—ã-–ø—Ä–∞–≤-–¥–æ—Å—Ç—É–ø–∞)
8. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–æ—Ç–ª–∞–¥–∫–∞)
9. [Production deployment](#production-deployment)
10. [–¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è](#—Ç–∏–ø–∏—á–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-–∏-—Ä–µ—à–µ–Ω–∏—è)

---

## –í–≤–µ–¥–µ–Ω–∏–µ

### –ß—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Bitrix24?

Bitrix24 - —ç—Ç–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª –∏ CRM-—Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ OAuth 2.0 –∏ REST API. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- ‚úÖ –í—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Bitrix24 (iframe)
- ‚úÖ –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –ø–æ—Ä—Ç–∞–ª–∞
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSO (Single Sign-On) –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- ‚úÖ –†–∞–±–æ—Ç–∞—Ç—å —Å REST API Bitrix24
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ä—Ç–∞–ª–æ–≤)

### –¢–∏–ø—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. **–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** (Local Application) - –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Ä—Ç–∞–ª
2. **–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** - –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ Bitrix24.Market –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω—è—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–µ–∑ UI

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ **–ª–æ–∫–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**.

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Bitrix24 Portal                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Bitrix24 UI (iframe container)                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  Your React Application                         ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  + Bitrix24 JS SDK (BX24)                       ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ OAuth 2.0 / REST API
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Your Backend (Express/Node.js)                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Bitrix24 Routes ‚îÇ  ‚îÇ Token Storage‚îÇ  ‚îÇ Permissions   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ /bitrix24/*     ‚îÇ  ‚îÇ (in-memory/  ‚îÇ  ‚îÇ Management    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                 ‚îÇ  ‚îÇ  PostgreSQL) ‚îÇ  ‚îÇ               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   PostgreSQL Database                        ‚îÇ
‚îÇ  - bitrix24_permissions (user roles)                        ‚îÇ
‚îÇ  - your_app_data                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **Bitrix24 JS SDK (BX24)** - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Bitrix24
2. **OAuth 2.0 —Ç–æ–∫–µ–Ω—ã** - access_token –∏ refresh_token –¥–ª—è REST API
3. **Webhook endpoints** - —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
4. **Token storage** - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ–∫–µ–Ω–æ–≤ (in-memory, PostgreSQL, Redis)
5. **Permissions system** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Bitrix24

#### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç–∞–ª Bitrix24
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ: **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è** ‚Üí **–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º** ‚Üí **–î—Ä—É–≥–æ–µ** ‚Üí **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø: **–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

#### 1.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
```
–ù–∞–∑–≤–∞–Ω–∏–µ: –í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
–ö–æ–¥: your_app_code (–ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ)
–û–ø–∏—Å–∞–Ω–∏–µ: –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
```

**URL –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:**
```
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (Install handler):
https://your-domain.com/bitrix24/install

–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è (Index handler):
https://your-domain.com/bitrix24/index

URL –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (Application URL):
https://your-domain.com/bitrix24/app
```

**–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (Scopes):**
- –ú–∏–Ω–∏–º—É–º: `app` (–±–∞–∑–æ–≤—ã–π –¥–æ—Å—Ç—É–ø)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: `user`, `department`, `crm`, –∏ —Ç.–¥. (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞)

#### 1.3 –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ:
- **CLIENT_ID** (Application ID) - –Ω–∞–ø—Ä–∏–º–µ—Ä: `local.5c8bb1b0891cf2.87252039`
- **CLIENT_SECRET** (Application key) - –Ω–∞–ø—Ä–∏–º–µ—Ä: `SakeVG5mbRdcQet45UUrt6q72AMTo7fkwXSO7Y5LYFYNCRsA6f`

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

#### 2.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**Backend (Node.js/Express):**
```bash
npm install express cors helmet cookie-parser bcryptjs jsonwebtoken
npm install @types/express @types/cors @types/bcryptjs @types/jsonwebtoken --save-dev
```

**Frontend (React):**
```bash
npm install react react-router-dom
npm install @types/react @types/react-router-dom --save-dev
```

#### 2.2 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env —Ñ–∞–π–ª–∞

–°–æ–∑–¥–∞–π—Ç–µ `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# Server
NODE_ENV=development
PORT=3001

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/your_db

# JWT
JWT_SECRET=your_super_secret_jwt_key_here
REFRESH_SECRET=your_super_secret_refresh_key_here

# Bitrix24 Integration
BITRIX24_CLIENT_ID=local.xxxxxxxxxx.xxxxxxxx
BITRIX24_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
BITRIX24_REDIRECT_URI=https://your-ngrok-url.ngrok.io/bitrix24/callback

# CORS
CLIENT_ORIGIN=http://localhost:3000
```

#### 2.3 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

Bitrix24 —Ç—Ä–µ–±—É–µ—Ç HTTPS. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
# Windows: choco install ngrok
# macOS: brew install ngrok
# Linux: snap install ngrok

# –ó–∞–ø—É—Å–∫
ngrok http 3001

# –í—ã –ø–æ–ª—É—á–∏—Ç–µ URL –≤–∏–¥–∞:
# https://abc123def456.ngrok.io -> http://localhost:3001
```

**–û–±–Ω–æ–≤–∏—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Bitrix24:**
```
https://abc123def456.ngrok.io/bitrix24/install
https://abc123def456.ngrok.io/bitrix24/index
https://abc123def456.ngrok.io/bitrix24/app
```

---

## Backend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
server/
‚îú‚îÄ‚îÄ index.ts                  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ server.ts                 # –û—Å–Ω–æ–≤–Ω–æ–π Express —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ database.ts               # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
‚îî‚îÄ‚îÄ bitrix24/
    ‚îú‚îÄ‚îÄ config.ts             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Bitrix24
    ‚îú‚îÄ‚îÄ storage.ts            # –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ–∫–µ–Ω–æ–≤
    ‚îú‚îÄ‚îÄ routes.ts             # –ú–∞—Ä—à—Ä—É—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
    ‚îú‚îÄ‚îÄ permissions.ts        # API —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏
    ‚îî‚îÄ‚îÄ api.ts                # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å REST API Bitrix24
```

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (config.ts)

```typescript
/**
 * server/bitrix24/config.ts
 * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ë–∏—Ç—Ä–∏–∫—Å24
 */

export const BITRIX24_CONFIG = {
  // Client ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ë–∏—Ç—Ä–∏–∫—Å24
  CLIENT_ID: process.env.BITRIX24_CLIENT_ID || '',

  // Client Secret –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ë–∏—Ç—Ä–∏–∫—Å24
  CLIENT_SECRET: process.env.BITRIX24_CLIENT_SECRET || '',

  // URL –¥–ª—è OAuth callback
  REDIRECT_URI: process.env.BITRIX24_REDIRECT_URI || 'http://localhost:3001/bitrix24/callback',

  // OAuth endpoints –ë–∏—Ç—Ä–∏–∫—Å24
  OAUTH_URL: 'https://oauth.bitrix.info/oauth/token/',

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  isConfigured(): boolean {
    return !!(this.CLIENT_ID && this.CLIENT_SECRET);
  }
};
```

### 2. –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ–∫–µ–Ω–æ–≤ (storage.ts)

```typescript
/**
 * server/bitrix24/storage.ts
 * –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ–∫–µ–Ω–æ–≤ –ë–∏—Ç—Ä–∏–∫—Å24
 */

export interface Bitrix24Tokens {
  domain: string;
  access_token: string;
  refresh_token: string;
  expires_at: number;
  application_token?: string;
  member_id?: string;
  client_endpoint?: string;
}

// In-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
const tokensStore = new Map<string, Bitrix24Tokens>();

/**
 * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
 */
export const saveTokens = (domain: string, tokens: Bitrix24Tokens): void => {
  tokensStore.set(domain, {
    ...tokens,
    domain
  });
};

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
 */
export const getTokens = (domain: string): Bitrix24Tokens | undefined => {
  return tokensStore.get(domain);
};

/**
 * –£–¥–∞–ª–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
 */
export const deleteTokens = (domain: string): boolean => {
  return tokensStore.delete(domain);
};

/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å—Ç–µ–∫–ª–∏ –ª–∏ —Ç–æ–∫–µ–Ω—ã
 */
export const isTokenExpired = (tokens: Bitrix24Tokens): boolean => {
  return Date.now() >= tokens.expires_at;
};

/**
 * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–æ–º–µ–Ω—ã
 */
export const getAllDomains = (): string[] => {
  return Array.from(tokensStore.keys());
};

/**
 * –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–∫–µ–Ω—ã (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
 */
export const clearAllTokens = (): void => {
  tokensStore.clear();
};
```

**‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è production:** –ó–∞–º–µ–Ω–∏—Ç–µ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞ PostgreSQL –∏–ª–∏ Redis!

### 3. –ú–∞—Ä—à—Ä—É—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (routes.ts)

```typescript
/**
 * server/bitrix24/routes.ts
 * API –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ë–∏—Ç—Ä–∏–∫—Å24
 */

import express, { Request, Response } from 'express';
import { saveTokens, getTokens } from './storage';
import { getDb } from '../database';
import path from 'path';

const router = express.Router();

/**
 * –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */
const addInitialAdmin = async (domain: string, accessToken: string) => {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ REST API
    const userResponse = await fetch(`https://${domain}/rest/user.current?auth=${accessToken}`);
    const userData = await userResponse.json() as any;

    if (userData.error) {
      return;
    }

    const currentUser = userData.result;
    const userId = currentUser.ID;
    const userName = `${currentUser.LAST_NAME} ${currentUser.NAME}`;

    const db = await getDb();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞
    const existing = await db.query(
      'SELECT COUNT(*) FROM bitrix24_permissions WHERE domain = $1',
      [domain]
    );

    if (Number(existing.rows[0].count) === 0) {
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—Ç–æ–≥–æ –∫—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∏–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
      await db.query(
        'INSERT INTO bitrix24_permissions (domain, user_id, user_name, role, createdat, createdby) VALUES ($1, $2, $3, $4, $5, $6)',
        [domain, userId, userName, 'admin', new Date().toISOString(), userId]
      );
    }
  } catch (error) {
    // Handle error silently
  }
};

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ query (GET) –∏–ª–∏ body (POST)
 */
const handleInstall = async (req: Request, res: Response) => {
  try {
    // –ë–∏—Ç—Ä–∏–∫—Å24 –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ GET (query) –∏–ª–∏ POST (body)
    const params = { ...req.query, ...req.body };

    const { event, PLACEMENT } = params;

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ ONAPPINSTALL
    if (event === 'ONAPPINSTALL' && params.auth) {
      const auth = params.auth as any;

      if (typeof auth === 'object' && auth.domain && auth.access_token) {
        const tokens = {
          domain: auth.domain,
          access_token: auth.access_token,
          refresh_token: auth.refresh_token || '',
          expires_at: Date.now() + (parseInt(auth.expires_in || '3600') * 1000),
          member_id: auth.member_id || '',
          client_endpoint: `https://${auth.domain}/rest/`
        };

        saveTokens(auth.domain, tokens);

        // –î–æ–±–∞–≤–ª—è–µ–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ –∫–∞–∫ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await addInitialAdmin(auth.domain, auth.access_token);

        return res.send(`
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8">
              <title>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</title>
              <script src="//api.bitrix24.com/api/v1/"></script>
            </head>
            <body>
              <script>
                BX24.init(function() {
                  BX24.installFinish();
                });
              </script>
              <h2>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!</h2>
              <p>–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –º–µ–Ω—é –ë–∏—Ç—Ä–∏–∫—Å24.</p>
            </body>
          </html>
        `);
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ PLACEMENT
    if (PLACEMENT === 'DEFAULT') {
      const domain = params.DOMAIN as string;
      const authId = params.AUTH_ID as string;
      const refreshId = params.REFRESH_ID as string;
      const expires = params.AUTH_EXPIRES as string;
      const memberId = params.member_id as string;

      if (domain && authId) {
        const tokens = {
          domain,
          access_token: authId,
          refresh_token: refreshId || '',
          expires_at: Date.now() + (parseInt(expires || '3600') * 1000),
          member_id: memberId || '',
          client_endpoint: `https://${domain}/rest/`
        };

        saveTokens(domain, tokens);

        // –î–æ–±–∞–≤–ª—è–µ–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ –∫–∞–∫ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await addInitialAdmin(domain, authId);

        return res.send(`
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8">
              <title>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</title>
              <script src="//api.bitrix24.com/api/v1/"></script>
            </head>
            <body>
              <script>
                BX24.init(function() {
                  BX24.installFinish();
                });
              </script>
              <h2>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!</h2>
            </body>
          </html>
        `);
      }
    }

    // –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –ø–æ–¥–æ—à–ª–∏
    res.status(400).send(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <title>–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</title>
        </head>
        <body>
          <h2>–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
          <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç –ë–∏—Ç—Ä–∏–∫—Å24.</p>
        </body>
      </html>
    `);

  } catch (error: any) {
    res.status(500).send(`
      <!DOCTYPE html>
      <html>
        <head><meta charset="UTF-8"><title>–û—à–∏–±–∫–∞</title></head>
        <body>
          <h2>–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
          <p>${error.message}</p>
        </body>
      </html>
    `);
  }
};

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (GET –∏ POST)
 */
router.get('/install', handleInstall);
router.post('/install', handleInstall);

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */
const handleIndex = async (req: Request, res: Response) => {
  try {
    const params = { ...req.query, ...req.body };

    const domain = params.DOMAIN as string;
    const authId = params.AUTH_ID as string;
    const refreshId = params.REFRESH_ID as string;
    const expires = params.AUTH_EXPIRES as string;
    const memberId = params.member_id as string;

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (domain && authId) {
      const tokens = {
        domain,
        access_token: authId,
        refresh_token: refreshId || '',
        expires_at: Date.now() + (parseInt(expires || '3600') * 1000),
        member_id: memberId || '',
        client_endpoint: `https://${domain}/rest/`
      };

      saveTokens(domain, tokens);

      // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
      await addInitialAdmin(domain, authId);
    }

    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    const redirectParams = new URLSearchParams({
      domain: domain || '',
      auth: authId || '',
      member_id: memberId || ''
    });

    res.redirect(`/bitrix24/app?${redirectParams.toString()}`);

  } catch (error: any) {
    res.status(500).send('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
  }
};

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (GET –∏ POST)
 */
router.get('/index', handleIndex);
router.post('/index', handleIndex);

/**
 * –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * –û—Ç–¥–∞–µ—Ç React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
 */
router.get('/app', (req: Request, res: Response) => {
  try {
    const buildPath = path.join(__dirname, '../../build/index.html');
    res.sendFile(buildPath);
  } catch (error: any) {
    res.status(500).send(`
      <!DOCTYPE html>
      <html>
        <head><meta charset="UTF-8"><title>–û—à–∏–±–∫–∞</title></head>
        <body>
          <h2>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Å–æ–±—Ä–∞–Ω–æ</h2>
          <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ: npm run build</p>
        </body>
      </html>
    `);
  }
});

export default router;
```

### 4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ server.ts

```typescript
/**
 * server/server.ts (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
 */

import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import bitrix24Routes from './bitrix24/routes';
import bitrix24PermissionsRoutes from './bitrix24/permissions';

const app = express();

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Helmet –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Bitrix24 iframe
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      ...helmet.contentSecurityPolicy.getDefaultDirectives(),
      "script-src": ["'self'", "'unsafe-inline'", "api.bitrix24.com", "*.bitrix24.ru", "*.bitrix24.com"],
      "connect-src": ["'self'", "*.bitrix24.ru", "*.bitrix24.com", "*.bitrix24.ua", "*.bitrix24.eu"],
      "frame-ancestors": ["'self'", "*.bitrix24.ru", "*.bitrix24.com", "*.bitrix24.ua", "*.bitrix24.eu"],
    },
  },
  frameguard: false // –û—Ç–∫–ª—é—á–∞–µ–º X-Frame-Options
}));

// CORS –¥–ª—è Bitrix24
app.use(cors({
  origin: (origin, callback) => {
    // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –¥–æ–º–µ–Ω—ã Bitrix24
    if (!origin || origin.includes('bitrix24')) {
      return callback(null, true);
    }

    // –†–∞–∑—Ä–µ—à–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É
    if (origin.includes('localhost') || origin.includes('127.0.0.1')) {
      return callback(null, true);
    }

    callback(new Error('Not allowed by CORS'));
  },
  credentials: true
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã Bitrix24
app.use('/bitrix24', bitrix24Routes);
app.use('/api/bitrix24/permissions', bitrix24PermissionsRoutes);

// –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –¥–ª—è production
if (process.env.NODE_ENV === 'production') {
  app.use(express.static('build'));
}

app.listen(3001, () => {
  console.log('Server running on port 3001');
});
```

---

## Frontend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
src/
‚îú‚îÄ‚îÄ App.tsx                           # –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥
‚îú‚îÄ‚îÄ Bitrix24App.tsx                   # –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Bitrix24
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îú‚îÄ‚îÄ Bitrix24Context.tsx           # –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Bitrix24
‚îÇ   ‚îî‚îÄ‚îÄ ToastContext.tsx              # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îî‚îÄ‚îÄ components/
    ‚îú‚îÄ‚îÄ Bitrix24AdminWrapper.tsx      # –û–±–µ—Ä—Ç–∫–∞ –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è Bitrix24
    ‚îî‚îÄ‚îÄ Bitrix24PermissionsManager.tsx # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏
```

### 1. TypeScript —Ç–∏–ø—ã –¥–ª—è Bitrix24 SDK

```typescript
/**
 * src/types.ts (–¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Ç–∏–ø—ã)
 */

declare global {
  interface Window {
    BX24?: {
      init: (callback: () => void) => void;
      getAuth: () => {
        access_token: string;
        domain: string;
        expires: number;
        expires_in: number;
        member_id: string;
        refresh_token: string;
        scope: string;
        status: string;
        user_id: number;
      };
      callMethod: (method: string, params: any, callback: (result: any) => void) => void;
      fitWindow: () => void;
      resizeWindow: (width: number, height: number) => void;
      closeApplication: () => void;
      installFinish: () => void;
    };
  }
}

export {};
```

### 2. –ö–æ–Ω—Ç–µ–∫—Å—Ç Bitrix24 (Bitrix24Context.tsx)

```typescript
/**
 * src/contexts/Bitrix24Context.tsx
 * –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Bitrix24
 */

import React, { createContext, useContext, ReactNode } from 'react';

interface Bitrix24User {
  id: string;
  name: string;
  lastName: string;
  fullName: string;
}

interface Bitrix24ContextType {
  user: Bitrix24User | null;
  isInBitrix24: boolean;
}

const Bitrix24Context = createContext<Bitrix24ContextType>({
  user: null,
  isInBitrix24: false
});

export const useBitrix24 = () => useContext(Bitrix24Context);

interface Bitrix24ProviderProps {
  children: ReactNode;
  user: Bitrix24User | null;
}

export const Bitrix24Provider: React.FC<Bitrix24ProviderProps> = ({ children, user }) => {
  return (
    <Bitrix24Context.Provider value={{ user, isInBitrix24: !!user }}>
      {children}
    </Bitrix24Context.Provider>
  );
};
```

### 3. –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Bitrix24 (Bitrix24App.tsx)

```typescript
/**
 * src/Bitrix24App.tsx
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ –ë–∏—Ç—Ä–∏–∫—Å24
 */

import React, { useEffect, useState } from 'react';
import { Routes, Route, Navigate } from 'react-router-dom';
import { Bitrix24Provider } from './contexts/Bitrix24Context';

function Bitrix24App() {
  const [isInitialized, setIsInitialized] = useState(false);
  const [error, setError] = useState<string>('');
  const [userRole, setUserRole] = useState<string | null>(null);
  const [bitrixUser, setBitrixUser] = useState<any>(null);

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API
  const checkUserPermissions = async (domain: string) => {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ API Bitrix24
      const currentUser: any = await new Promise((resolve, reject) => {
        window.BX24.callMethod('user.current', {}, (result: any) => {
          if (result.error()) {
            reject(result.error());
          } else {
            resolve(result.data());
          }
        });
      });

      const userId = currentUser.ID;
      const userName = `${currentUser.LAST_NAME} ${currentUser.NAME}`;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      setBitrixUser({
        id: currentUser.ID,
        name: currentUser.NAME,
        lastName: currentUser.LAST_NAME,
        fullName: userName
      });

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const response = await fetch(
        `/api/bitrix24/permissions/check?domain=${encodeURIComponent(domain)}&user_id=${encodeURIComponent(userId)}`
      );
      const data = await response.json();

      if (data.hasPermission && (data.role === 'admin' || data.role === 'observer')) {
        setUserRole(data.role);

        // –ü–æ–ª—É—á–∞–µ–º JWT —Ç–æ–∫–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å backend API
        const authResponse = await fetch('/api/bitrix24/permissions/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            domain: domain,
            user_id: userId,
            user_name: userName
          })
        });

        if (authResponse.ok) {
          const authData = await authResponse.json();
          localStorage.setItem('accessToken', authData.accessToken);
          localStorage.setItem('user', JSON.stringify(authData.user));
        }
      } else {
        // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        setUserRole(null);
        localStorage.removeItem('accessToken');
        localStorage.removeItem('user');
      }

      setIsInitialized(true);

      // –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä iframe –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
      window.BX24.fitWindow();

    } catch (error) {
      setUserRole(null);
      setIsInitialized(true);
    }
  };

  useEffect(() => {
    // –ó–∞–≥—Ä—É–∑–∫–∞ Bitrix24 JS SDK
    const loadBitrix24SDK = () => {
      if (window.BX24) {
        initBitrix24();
        return;
      }

      const script = document.createElement('script');
      script.src = '//api.bitrix24.com/api/v1/';
      script.async = true;

      script.onload = () => {
        initBitrix24();
      };

      script.onerror = () => {
        setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Bitrix24 SDK');
      };

      document.head.appendChild(script);
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bitrix24
    const initBitrix24 = () => {
      if (!window.BX24) {
        setError('Bitrix24 SDK –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        return;
      }

      try {
        window.BX24.init(() => {
          const auth = window.BX24.getAuth();
          checkUserPermissions(auth.domain);
        });
      } catch (err: any) {
        setError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Bitrix24: ' + err.message);
      }
    };

    loadBitrix24SDK();
  }, []);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
  useEffect(() => {
    if (isInitialized && window.BX24) {
      let timeoutId: NodeJS.Timeout;
      const debouncedFitWindow = () => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          if (window.BX24) {
            window.BX24.fitWindow();
          }
        }, 300);
      };

      const resizeObserver = new ResizeObserver(debouncedFitWindow);
      const mainContainer = document.querySelector('#root > div');
      if (mainContainer) {
        resizeObserver.observe(mainContainer as Element);
      }

      return () => {
        clearTimeout(timeoutId);
        resizeObserver.disconnect();
      };
    }
  }, [isInitialized]);

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="bg-white p-8 rounded-lg shadow-md max-w-md">
          <h2 className="text-2xl font-bold text-red-600 mb-4">–û—à–∏–±–∫–∞</h2>
          <p className="text-gray-700">{error}</p>
        </div>
      </div>
    );
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  if (!isInitialized) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-100">
        <div className="bg-white p-8 rounded-lg shadow-md">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
          <p className="text-gray-700 text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
        </div>
      </div>
    );
  }

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω–∫—É
  if (userRole === 'admin' || userRole === 'observer') {
    return (
      <div>
        <h1>Admin Dashboard</h1>
        <p>Role: {userRole}</p>
        {/* –í–∞—à –∞–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */}
      </div>
    );
  }

  // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  return (
    <Bitrix24Provider user={bitrixUser}>
      <Routes>
        <Route path="app" element={<div>Your App Content</div>} />
        <Route path="*" element={<Navigate to="app" replace />} />
      </Routes>
    </Bitrix24Provider>
  );
}

export default Bitrix24App;
```

### 4. –†–æ—É—Ç–∏–Ω–≥ –≤ App.tsx

```typescript
/**
 * src/App.tsx
 * –ì–ª–∞–≤–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */

import React from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import Bitrix24App from './Bitrix24App';
import HomePage from './HomePage'; // Standalone —Ä–µ–∂–∏–º

function App() {
  return (
    <BrowserRouter>
      <Routes>
        {/* –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è Bitrix24 */}
        <Route path="/bitrix24/*" element={<Bitrix24App />} />

        {/* Standalone —Ä–µ–∂–∏–º */}
        <Route path="/" element={<HomePage />} />
        <Route path="/admin" element={<div>Admin Panel (Standalone)</div>} />
      </Routes>
    </BrowserRouter>
  );
}

export default App;
```

---

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

```sql
/**
 * –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Bitrix24
 */

CREATE TABLE IF NOT EXISTS bitrix24_permissions (
    id SERIAL PRIMARY KEY,
    domain VARCHAR(255) NOT NULL,           -- –î–æ–º–µ–Ω –ø–æ—Ä—Ç–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, mycompany.bitrix24.ru)
    user_id VARCHAR(50) NOT NULL,           -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Bitrix24
    user_name VARCHAR(255),                 -- –§–ò–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    role VARCHAR(50) NOT NULL,              -- –†–æ–ª—å: 'admin' –∏–ª–∏ 'observer'
    createdat TIMESTAMP DEFAULT NOW(),      -- –î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤
    createdby VARCHAR(50),                  -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–¥–∞–ª –ø—Ä–∞–≤–∞

    CONSTRAINT unique_domain_user UNIQUE (domain, user_id)
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –¥–æ–º–µ–Ω—É –∏ user_id
CREATE INDEX idx_bitrix24_permissions_domain_user
ON bitrix24_permissions(domain, user_id);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –¥–æ–º–µ–Ω—É
CREATE INDEX idx_bitrix24_permissions_domain
ON bitrix24_permissions(domain);
```

### (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ PostgreSQL

```sql
/**
 * –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è OAuth —Ç–æ–∫–µ–Ω–æ–≤ Bitrix24
 * –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production –≤–º–µ—Å—Ç–æ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
 */

CREATE TABLE IF NOT EXISTS bitrix24_tokens (
    domain VARCHAR(255) PRIMARY KEY,        -- –î–æ–º–µ–Ω –ø–æ—Ä—Ç–∞–ª–∞
    access_token TEXT NOT NULL,             -- OAuth access token
    refresh_token TEXT NOT NULL,            -- OAuth refresh token
    expires_at BIGINT NOT NULL,             -- –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ (Unix timestamp)
    member_id VARCHAR(255),                 -- ID —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    client_endpoint TEXT,                   -- REST API endpoint
    updated_at TIMESTAMP DEFAULT NOW()      -- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–µ–∫—à–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
CREATE INDEX idx_bitrix24_tokens_expires
ON bitrix24_tokens(expires_at);
```

### –ú–∏–≥—Ä–∞—Ü–∏—è storage.ts –Ω–∞ PostgreSQL

```typescript
/**
 * server/bitrix24/storage.ts (PostgreSQL –≤–µ—Ä—Å–∏—è)
 */

import { getDb } from '../database';

export interface Bitrix24Tokens {
  domain: string;
  access_token: string;
  refresh_token: string;
  expires_at: number;
  application_token?: string;
  member_id?: string;
  client_endpoint?: string;
}

/**
 * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
 */
export const saveTokens = async (domain: string, tokens: Bitrix24Tokens): Promise<void> => {
  const db = await getDb();

  await db.query(`
    INSERT INTO bitrix24_tokens (domain, access_token, refresh_token, expires_at, member_id, client_endpoint, updated_at)
    VALUES ($1, $2, $3, $4, $5, $6, NOW())
    ON CONFLICT (domain)
    DO UPDATE SET
      access_token = EXCLUDED.access_token,
      refresh_token = EXCLUDED.refresh_token,
      expires_at = EXCLUDED.expires_at,
      member_id = EXCLUDED.member_id,
      client_endpoint = EXCLUDED.client_endpoint,
      updated_at = NOW()
  `, [domain, tokens.access_token, tokens.refresh_token, tokens.expires_at, tokens.member_id, tokens.client_endpoint]);
};

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
 */
export const getTokens = async (domain: string): Promise<Bitrix24Tokens | undefined> => {
  const db = await getDb();

  const result = await db.query(
    'SELECT * FROM bitrix24_tokens WHERE domain = $1',
    [domain]
  );

  if (result.rows.length === 0) {
    return undefined;
  }

  return result.rows[0] as Bitrix24Tokens;
};

/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∏—Å—Ç–µ–∫–ª–∏ –ª–∏ —Ç–æ–∫–µ–Ω—ã
 */
export const isTokenExpired = (tokens: Bitrix24Tokens): boolean => {
  return Date.now() >= tokens.expires_at;
};
```

---

## –°–∏—Å—Ç–µ–º—ã –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

### API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏ (permissions.ts)

```typescript
/**
 * server/bitrix24/permissions.ts
 * API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–∏—Ç—Ä–∏–∫—Å24
 */

import express, { Request, Response } from 'express';
import { getDb } from '../database';
import jwt from 'jsonwebtoken';

const router = express.Router();

const JWT_SECRET = process.env.JWT_SECRET || 'supersecretkey';
const REFRESH_SECRET = process.env.REFRESH_SECRET || 'refreshsecretkey';
const ACCESS_TOKEN_EXPIRES = '15m';
const REFRESH_TOKEN_EXPIRES = '7d';

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * GET /api/bitrix24/permissions/check?domain=xxx&user_id=yyy
 */
router.get('/check', async (req: Request, res: Response) => {
  try {
    const { domain, user_id } = req.query;

    if (!domain || !user_id) {
      return res.status(400).json({ error: 'Domain and user_id are required' });
    }

    const db = await getDb();
    const result = await db.query(
      'SELECT role FROM bitrix24_permissions WHERE domain = $1 AND user_id = $2',
      [domain, user_id]
    );

    if (result.rows.length === 0) {
      return res.json({ hasPermission: false, role: null });
    }

    res.json({
      hasPermission: true,
      role: result.rows[0].role
    });

  } catch (error: any) {
    res.status(500).json({ error: 'Failed to check permissions' });
  }
});

/**
 * –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏ –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
 * GET /api/bitrix24/permissions/list?domain=xxx
 */
router.get('/list', async (req: Request, res: Response) => {
  try {
    const { domain } = req.query;

    if (!domain) {
      return res.status(400).json({ error: 'Domain is required' });
    }

    const db = await getDb();
    const result = await db.query(
      'SELECT id, user_id, user_name, role, createdat, createdby FROM bitrix24_permissions WHERE domain = $1 ORDER BY createdat DESC',
      [domain]
    );

    res.json({ users: result.rows });

  } catch (error: any) {
    res.status(500).json({ error: 'Failed to get permissions list' });
  }
});

/**
 * –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 * POST /api/bitrix24/permissions/add
 * Body: { domain, user_id, user_name, role, created_by }
 */
router.post('/add', async (req: Request, res: Response) => {
  try {
    const { domain, user_id, user_name, role, created_by } = req.body;

    if (!domain || !user_id || !role) {
      return res.status(400).json({ error: 'Domain, user_id, and role are required' });
    }

    // Validate role
    if (!['admin', 'observer'].includes(role)) {
      return res.status(400).json({ error: 'Role must be admin or observer' });
    }

    const db = await getDb();

    // Check if user already has permissions
    const existing = await db.query(
      'SELECT id FROM bitrix24_permissions WHERE domain = $1 AND user_id = $2',
      [domain, user_id]
    );

    if (existing.rows.length > 0) {
      // Update existing permission
      await db.query(
        'UPDATE bitrix24_permissions SET role = $1, user_name = $2 WHERE domain = $3 AND user_id = $4',
        [role, user_name, domain, user_id]
      );

      return res.json({ message: 'Permission updated successfully' });
    }

    // Insert new permission
    await db.query(
      'INSERT INTO bitrix24_permissions (domain, user_id, user_name, role, createdat, createdby) VALUES ($1, $2, $3, $4, $5, $6)',
      [domain, user_id, user_name, role, new Date().toISOString(), created_by]
    );

    res.json({ message: 'Permission added successfully' });

  } catch (error: any) {
    res.status(500).json({ error: 'Failed to add permission' });
  }
});

/**
 * –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * DELETE /api/bitrix24/permissions/remove
 * Body: { domain, user_id }
 */
router.delete('/remove', async (req: Request, res: Response) => {
  try {
    const { domain, user_id } = req.body;

    if (!domain || !user_id) {
      return res.status(400).json({ error: 'Domain and user_id are required' });
    }

    const db = await getDb();
    await db.query(
      'DELETE FROM bitrix24_permissions WHERE domain = $1 AND user_id = $2',
      [domain, user_id]
    );

    res.json({ message: 'Permission removed successfully' });

  } catch (error: any) {
    res.status(500).json({ error: 'Failed to remove permission' });
  }
});

/**
 * –ü–æ–ª—É—á–∏—Ç—å JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è Bitrix24 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * POST /api/bitrix24/permissions/auth
 * Body: { domain, user_id, user_name }
 */
router.post('/auth', async (req: Request, res: Response) => {
  try {
    const { domain, user_id, user_name } = req.body;

    if (!domain || !user_id) {
      return res.status(400).json({ error: 'Domain and user_id are required' });
    }

    const db = await getDb();
    const result = await db.query(
      'SELECT role FROM bitrix24_permissions WHERE domain = $1 AND user_id = $2',
      [domain, user_id]
    );

    if (result.rows.length === 0) {
      return res.status(403).json({ error: 'User does not have permissions' });
    }

    const role = result.rows[0].role;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω—ã
    const accessToken = jwt.sign(
      { id: user_id, username: user_name, role },
      JWT_SECRET,
      { expiresIn: ACCESS_TOKEN_EXPIRES }
    );

    const refreshToken = jwt.sign(
      { id: user_id, username: user_name, role },
      REFRESH_SECRET,
      { expiresIn: REFRESH_TOKEN_EXPIRES }
    );

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º refresh —Ç–æ–∫–µ–Ω –≤ httpOnly cookie
    res.cookie('refreshToken', refreshToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      maxAge: 7 * 24 * 60 * 60 * 1000 // 7 –¥–Ω–µ–π
    });

    res.json({
      accessToken,
      user: {
        id: user_id,
        username: user_name,
        role
      }
    });

  } catch (error: any) {
    res.status(500).json({ error: 'Failed to authenticate' });
  }
});

export default router;
```

### –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞

**–†–æ–ª–∏:**
1. **admin** - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏)
2. **observer** - —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–µ–≥—É—Å—Ç–∞—Ü–∏–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
3. **–æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** - —É—á–∞—Å—Ç–∏–µ –≤ –¥–µ–≥—É—Å—Ç–∞—Ü–∏—è—Ö (–±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω–∫–µ)

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Frontend:**
```typescript
// –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
if (userRole === 'admin') {
  // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
} else if (userRole === 'observer') {
  // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä
} else {
  // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–µ–≥—É—Å—Ç–∞—Ü–∏–∏
}
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (dev —Ä–µ–∂–∏–º)

```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
curl http://localhost:3001/bitrix24/api/debug/tokens

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ—Ä—Ç–∞–ª–∞
curl "http://localhost:3001/bitrix24/api/status?domain=mycompany.bitrix24.ru"
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Bitrix24: **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è** ‚Üí **–ú–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
2. –ù–∞–∂–º–∏—Ç–µ **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ browser console –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ backend –ª–æ–≥–∏: `console.log('[Bitrix24] Install request:', params)`

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã SDK

–í browser console:
```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ SDK
console.log(window.BX24);

// –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
BX24.getAuth();

// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
BX24.callMethod('user.current', {}, (result) => {
  console.log(result.data());
});
```

### 4. –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –†–µ—à–µ–Ω–∏–µ |
|--------|---------|---------|
| `BX24 is not defined` | SDK –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è | –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `<script src="//api.bitrix24.com/api/v1/">` |
| `CORS error` | –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CORS | –î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω—ã Bitrix24 –≤ allowed origins |
| `Cannot GET /bitrix24/app` | Build –Ω–µ —Å–æ–∑–¥–∞–Ω | –í—ã–ø–æ–ª–Ω–∏—Ç–µ `npm run build` |
| `Refused to display in a frame` | X-Frame-Options –±–ª–æ–∫–∏—Ä—É–µ—Ç iframe | –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Helmet: `frameguard: false` |
| `Tokens expired` | –¢–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–ª–∏ | –†–µ–∞–ª–∏–∑—É–π—Ç–µ refresh token –º–µ—Ö–∞–Ω–∏–∑–º |
| `User not found` | –ù–µ—Ç –ø—Ä–∞–≤ –≤ –ë–î | –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ permissions API |

---

## Production Deployment

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é

**Checklist:**
- [ ] –°–æ–±—Ä–∞—Ç—å frontend: `npm run build`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å token storage –Ω–∞ PostgreSQL/Redis
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTPS (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- [ ] –û–±–Ω–æ–≤–∏—Ç—å URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Bitrix24 –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è production –¥–æ–º–µ–Ω–æ–≤
- [ ] –£–¥–∞–ª–∏—Ç—å debug endpoints (`/api/debug/tokens`)

### 2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è production

```env
NODE_ENV=production
PORT=3001

DATABASE_URL=postgresql://user:password@db-host:5432/production_db

JWT_SECRET=your_super_secure_jwt_secret_key_here_min_32_chars
REFRESH_SECRET=your_super_secure_refresh_secret_key_here_min_32_chars

BITRIX24_CLIENT_ID=local.xxxxxxxxxx.xxxxxxxx
BITRIX24_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxx
BITRIX24_REDIRECT_URI=https://your-domain.com/bitrix24/callback

CLIENT_ORIGIN=https://your-domain.com
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Let's Encrypt:**
```bash
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

**–ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ nginx –∫–∞–∫ reverse proxy:**
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # –î–ª—è Bitrix24 iframe
        add_header X-Frame-Options "ALLOW-FROM https://*.bitrix24.ru";
    }
}
```

### 4. Docker deployment (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3001

CMD ["node", "server/index.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:password@db:5432/appdb
      - JWT_SECRET=${JWT_SECRET}
      - REFRESH_SECRET=${REFRESH_SECRET}
      - BITRIX24_CLIENT_ID=${BITRIX24_CLIENT_ID}
      - BITRIX24_CLIENT_SECRET=${BITRIX24_CLIENT_SECRET}
    depends_on:
      - db

  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
```

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ Bitrix24

–ó–∞–º–µ–Ω–∏—Ç–µ ngrok URL –Ω–∞ production –¥–æ–º–µ–Ω:
```
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏: https://your-domain.com/bitrix24/install
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è: https://your-domain.com/bitrix24/index
URL –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è: https://your-domain.com/bitrix24/app
```

---

## –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Iframe –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–µ–ª—ã–π —ç–∫—Ä–∞–Ω –≤ Bitrix24
- –û—à–∏–±–∫–∞ –≤ console: "Refused to display in a frame"

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// server.ts
app.use(helmet({
  frameguard: false, // –û—Ç–∫–ª—é—á–∏—Ç—å X-Frame-Options
  contentSecurityPolicy: {
    directives: {
      "frame-ancestors": ["'self'", "*.bitrix24.ru", "*.bitrix24.com"],
    },
  },
}));
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: CORS –æ—à–∏–±–∫–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- "Access to fetch blocked by CORS policy"
- Network errors –≤ DevTools

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
app.use(cors({
  origin: (origin, callback) => {
    // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –¥–æ–º–µ–Ω—ã Bitrix24
    if (!origin || origin.includes('bitrix24')) {
      return callback(null, true);
    }
    callback(new Error('Not allowed by CORS'));
  },
  credentials: true
}));
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –¢–æ–∫–µ–Ω—ã —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"

**–†–µ—à–µ–Ω–∏–µ:**
–ú–∏–≥—Ä–∏—Ä—É–π—Ç–µ –Ω–∞ PostgreSQL storage (—Å–º. —Ä–∞–∑–¥–µ–ª "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö")

### –ü—Ä–æ–±–ª–µ–º–∞ 4: BX24.fitWindow() –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ—è–≤–ª—è—é—Ç—Å—è scrollbars –≤ iframe
- –ö–æ–Ω—Ç–µ–Ω—Ç –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ResizeObserver –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏
useEffect(() => {
  const resizeObserver = new ResizeObserver(() => {
    if (window.BX24) {
      window.BX24.fitWindow();
    }
  });

  const container = document.querySelector('#root > div');
  if (container) {
    resizeObserver.observe(container);
  }

  return () => resizeObserver.disconnect();
}, []);
```

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –ù–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- `user.current` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É
- –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤—å—Ç–µ scope `user` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Bitrix24

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```typescript
// server/bitrix24/api.ts
router.get('/users', async (req: Request, res: Response) => {
  const { domain } = req.query;
  const tokens = getTokens(domain as string);

  if (!tokens) {
    return res.status(401).json({ error: 'No tokens' });
  }

  const response = await fetch(
    `https://${domain}/rest/user.get?auth=${tokens.access_token}`
  );
  const data = await response.json();

  res.json({ users: data.result });
});
```

### 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Bitrix24

```typescript
// –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
const sendNotification = async (domain: string, userId: string, message: string) => {
  const tokens = getTokens(domain);

  await fetch(`https://${domain}/rest/im.notify?auth=${tokens.access_token}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      to: userId,
      message: message,
      type: 'SYSTEM'
    })
  });
};
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CRM

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–∞ –≤ CRM
const createLead = async (domain: string, leadData: any) => {
  const tokens = getTokens(domain);

  await fetch(`https://${domain}/rest/crm.lead.add?auth=${tokens.access_token}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ fields: leadData })
  });
};
```

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [Bitrix24 REST API](https://dev.1c-bitrix.ru/rest_help/)
- [Bitrix24 JS SDK](https://dev.1c-bitrix.ru/rest_help/js_library/index.php)
- [OAuth 2.0 –≤ Bitrix24](https://dev.1c-bitrix.ru/rest_help/general/auth.php)
- [–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π](https://dev.1c-bitrix.ru/rest_help/application_embedding/)

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- [ngrok](https://ngrok.com/) - –¢—É–Ω–Ω–µ–ª—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [Postman](https://www.postman.com/) - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ REST API
- [VS Code REST Client](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)

---

## –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

–ü—Ä–∏ –ø–æ–º–æ—â–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Bitrix24, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:

- [ ] –°–æ–∑–¥–∞–Ω `.env` —Ñ–∞–π–ª —Å CLIENT_ID –∏ CLIENT_SECRET
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- [ ] –°–æ–∑–¥–∞–Ω—ã –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ–∞–π–ª—ã backend (config.ts, storage.ts, routes.ts, permissions.ts)
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω—ã –º–∞—Ä—à—Ä—É—Ç—ã –≤ server.ts
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã Helmet –∏ CORS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å iframe
- [ ] –°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ bitrix24_permissions –≤ PostgreSQL
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω Bitrix24App.tsx —Å –∑–∞–≥—Ä—É–∑–∫–æ–π SDK
- [ ] –î–æ–±–∞–≤–ª–µ–Ω—ã TypeScript —Ç–∏–ø—ã –¥–ª—è window.BX24
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤ (admin/observer/user)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω auto-resize iframe —á–µ—Ä–µ–∑ BX24.fitWindow()
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ permissions API
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω production build

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ React/Node.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å Bitrix24.

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
1. **HTTPS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Bitrix24
2. **–¢–æ–∫–µ–Ω—ã –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ** (PostgreSQL/Redis –≤ production)
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ BX24.fitWindow()** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–∑–º–µ—Ä–∞ iframe
4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS –∏ Helmet** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å iframe
5. **–†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –ø—Ä–∞–≤** –¥–ª—è —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
6. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ ngrok** –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Bitrix24 –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ browser console + backend –ª–æ–≥–∏.

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 1.0
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-11
**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–µ—Ä—Å–∏–∏ Bitrix24:** Cloud –∏ On-Premise
